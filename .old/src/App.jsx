import { useState, useEffect, useCallback } from "react";
import { LayoutDashboard,Briefcase,Users,FileText,Receipt,CreditCard,PieChart,Settings,Plus,X,Clock,DollarSign,AlertTriangle,TrendingUp,CheckCircle,Circle,Home,FileCheck,RefreshCw,Upload,Hash,BookOpen,Lock,Globe,MessageSquare,Phone,Mail,Download,Printer,Copy,Car,Wifi,ArrowLeft,Route,Percent,Calculator,Send,Eye,MoreVertical,Ban,Edit3,Trash2,Link2,Unlink,FileSpreadsheet,Check,Info } from "lucide-react";
import { BarChart,Bar,XAxis,YAxis,Tooltip,ResponsiveContainer,LineChart,Line,CartesianGrid,PieChart as RPie,Pie,Cell,AreaChart,Area } from "recharts";
import { generateInvoicePdf, generateQuotePdf, generateExpenseReportPdf } from "./lib/pdf";

const JOBS=[{id:1,t:"Custom Timber Shelving Unit",cl:"Sarah & Mark Thompson",ty:"Fabrication",st:"In Progress",pr:"High",v:2400,due:"2026-02-28",n:1},{id:2,t:"Logo Design — Greymouth Kayaks",cl:"Greymouth Kayaks Ltd",ty:"Design",st:"Quoted",pr:"Medium",v:800,due:"2026-03-15"},{id:3,t:"Workshop Consultation",cl:"West Coast Community Trust",ty:"Consulting",st:"Enquiry",pr:"Low",v:450,due:null,n:1},{id:4,t:"Steel Bracket Fab x24",cl:"BuildRight Construction",ty:"Fabrication",st:"Approved",pr:"High",v:1800,due:"2026-02-20"},{id:5,t:"Ecoglo Monthly Consult",cl:"Ecoglo International",ty:"Consulting",st:"Invoiced",pr:"Medium",v:300,due:"2026-01-31"},{id:6,t:"Motorcycle Pannier Mounts",cl:"Adventure Moto NZ",ty:"Fabrication",st:"Complete",pr:"Medium",v:650,due:"2026-01-20"}];
const CL=[{id:1,n:"Sarah & Mark Thompson",e:"sarah.mark@gmail.com",p:"027 555 1234",a:"14 Tainui St, Greymouth",j:3,r:5200},{id:2,n:"Greymouth Kayaks Ltd",e:"info@greymouthkayaks.co.nz",p:"03 555 2345",a:"8 Wharf St, Greymouth",j:1,r:800},{id:3,n:"West Coast Community Trust",e:"admin@wcct.org.nz",p:"03 555 3456",a:"PO Box 45, Greymouth",j:2,r:1900},{id:4,n:"BuildRight Construction",e:"orders@buildright.co.nz",p:"027 555 4567",a:"22 Industrial Pl",j:4,r:12400},{id:5,n:"Ecoglo International",e:"trevor@ecoglo.com",p:"03 555 5678",a:"15 Sir Gil Simpson Dr, Chch",j:12,r:3600},{id:6,n:"Adventure Moto NZ",e:"parts@adventuremoto.nz",p:"021 555 6789",a:"5 Arthur St, Hokitika",j:2,r:1300}];
const CT=[{id:1,n:"Dave Murray",co:"Metalcraft Engineering",e:"dave@metalcraft.co.nz",p:"03 768 1234",ty:"Supplier",tg:["steel","fab"],nt:"Good turnaround. Trade >$500."},{id:2,n:"Karen Liu",co:"Bunnings Greymouth",p:"03 768 2345",ty:"Supplier",tg:["hardware"],nt:"Trade account set up."},{id:3,n:"Mike Te Huia",co:"Freelance",e:"mike@mikedesign.co.nz",p:"027 555 9876",ty:"Contractor",tg:["design"],nt:"$65/hr overflow."},{id:4,n:"Rachel Simmons",co:"Simmons Accounting",e:"rachel@simmonsaccounting.co.nz",p:"03 768 4567",ty:"Professional",tg:["tax"],nt:"IR3 checklist Feb."},{id:5,n:"Tony Chen",co:"WC Powdercoating",e:"tony@wcpc.co.nz",p:"03 768 5678",ty:"Supplier",tg:["finish"],nt:"Min 10pcs. 5 days."},{id:6,n:"James Porter",co:"Porter Electrical",e:"james@porter.co.nz",p:"027 555 3210",ty:"Trade",tg:["electrical"],nt:"Sparky sign-off."}];
const QT=[{id:"Q-0008",cl:"Greymouth Kayaks Ltd",job:"Logo Design",am:800,gst:120,st:"Sent",dt:"2026-01-30",exp:"2026-03-01",v:1,en:"2 revision rounds incl.",inn:"Budget tight."},{id:"Q-0009",cl:"BuildRight Construction",job:"Steel Brackets",am:1800,gst:270,st:"Accepted",dt:"2026-02-03",exp:"2026-03-05",v:1,en:"6mm mild steel.",inn:""},{id:"Q-0007",cl:"West Coast Community Trust",job:"Workshop Consult",am:450,gst:67.5,st:"Draft",dt:"2026-02-10",v:1,en:"",inn:"Waiting for Ruth."},{id:"Q-0006",cl:"Sarah & Mark Thompson",job:"Timber Shelving",am:2400,gst:360,st:"Accepted",dt:"2026-01-12",exp:"2026-02-11",v:2,en:"Incl. material & install. Recycled rimu.",inn:"V1 was $2800."}];
const INV=[{id:"SHMAKE-0012",cl:"Ecoglo International",am:345,gst:45,st:"Paid",dt:"2026-01-20",due:"2026-02-20",rec:1,en:"Monthly consult — Jan",inn:""},{id:"SHMAKE-0013",cl:"BuildRight Construction",am:2070,gst:270,st:"Sent",dt:"2026-02-01",due:"2026-02-20",en:"Per Quote Q-0009.",inn:"Dave pays ~15th."},{id:"SHMAKE-0014",cl:"Sarah & Mark Thompson",am:1380,gst:180,st:"Draft",dt:"2026-02-10",en:"",inn:"50% deposit."},{id:"SHMAKE-0011",cl:"Adventure Moto NZ",am:747.5,gst:97.5,st:"Overdue",dt:"2025-12-28",due:"2026-01-20",en:"",inn:"Chased 3 Feb. Chase again."},{id:"SHMAKE-0010",cl:"West Coast Community Trust",am:517.5,gst:67.5,st:"Paid",dt:"2025-12-15",due:"2026-01-20",en:"Half day workshop",inn:""}];
const EXP=[{id:1,dt:"2026-02-08",d:"Steel flat bar x4",am:186.3,gst:24.3,cat:"Materials",job:"Steel Bracket Fab",rc:1},{id:2,dt:"2026-02-05",d:"Supabase Pro — Feb",am:25,gst:0,cat:"Software"},{id:3,dt:"2026-02-01",d:"Stripe Fees — Jan",am:42.18,gst:0,cat:"Processing",auto:1},{id:4,dt:"2026-01-30",d:"Bunnings — drill bits",am:67.8,gst:8.84,cat:"Tools",rc:1},{id:5,dt:"2026-01-28",d:"Z Energy — fuel",am:22.5,gst:2.93,cat:"Vehicle",rc:1,ap:1,full:90,bp:25},{id:6,dt:"2026-01-15",d:"Internet — Jan",am:10.99,gst:1.43,cat:"Home Office",ap:1,full:109.9,bp:10}];
const TRIPS=[{id:1,dt:"2026-02-10",fr:"Home",to:"Metalcraft",km:12,p:"Steel pickup",cat:"Supplier"},{id:2,dt:"2026-02-07",fr:"Workshop",to:"BuildRight",km:8,p:"Bracket delivery",cat:"Client"},{id:3,dt:"2026-02-03",fr:"Home",to:"Bunnings",km:6,p:"Drill bits",cat:"Supplier"},{id:4,dt:"2026-01-28",fr:"Home",to:"Thompson residence",km:18,p:"Site measure",cat:"Client"},{id:5,dt:"2026-01-22",fr:"Workshop",to:"WC Powdercoating",km:22,p:"Drop samples",cat:"Supplier"},{id:6,dt:"2026-01-15",fr:"Home",to:"Ecoglo Chch",km:340,p:"Monthly visit",cat:"Client"}];
const HOEX=[{id:1,m:"Jan 2026",ty:"Internet",f:109.9,pc:10,d:10.99},{id:2,m:"Jan 2026",ty:"Power",f:245,pc:10,d:24.5},{id:3,m:"Jan 2026",ty:"Insurance",f:185,pc:10,d:18.5},{id:4,m:"Dec 2025",ty:"Internet",f:109.9,pc:10,d:10.99},{id:5,m:"Dec 2025",ty:"Power",f:220,pc:10,d:22},{id:6,m:"Dec 2025",ty:"Insurance",f:185,pc:10,d:18.5}];
const RECTPL=[{id:1,cl:"Ecoglo International",d:"Monthly Consultancy",am:345,gst:45,freq:"Monthly",next:"2026-03-01",st:"Active",gen:12},{id:2,cl:"Sarah & Mark Thompson",d:"Maintenance (paused)",am:150,gst:22.5,freq:"Quarterly",next:null,st:"Paused",gen:3}];
const STRP=[{id:"ch_1",dt:"2026-01-31",ty:"charge",g:4,fe:.62,ne:3.38,d:"myMECA monthly"},{id:"ch_2",dt:"2026-01-31",ty:"charge",g:4,fe:.62,ne:3.38,d:"myMECA monthly"},{id:"ch_3",dt:"2026-01-30",ty:"charge",g:4,fe:.62,ne:3.38,d:"myMECA monthly"},{id:"po_1",dt:"2026-02-01",ty:"payout",ne:1005.86,d:"Payout to ••7890"}];
const SUBS=[{id:1,app:"myMECA",subscribers:267,mrr:1068,grossJan:1068,feesJan:62.14,netJan:1005.86,trend:[890,920,945,980,1010,1040,1068]}];
const BANK=[{id:1,dt:"2026-02-03",d:"STRIPE PAYOUT",am:1005.86,mt:"Stripe payout — Jan"},{id:2,dt:"2026-02-01",d:"BUILDRIGHT CONST",am:2070,mt:"SHMAKE-0013"},{id:3,dt:"2026-01-30",d:"BUNNINGS GREYMOUTH",am:-67.8,mt:"Expense #4"},{id:4,dt:"2026-01-28",d:"Z ENERGY",am:-90},{id:5,dt:"2026-01-25",d:"COUNTDOWN",am:-145.2}];
const REV=[{m:"Sep",inv:2100,sub:890},{m:"Oct",inv:1800,sub:920},{m:"Nov",inv:3200,sub:945},{m:"Dec",inv:1650,sub:980},{m:"Jan",inv:2400,sub:1010},{m:"Feb",inv:1380,sub:1068}];
const EC=[{n:"Materials",v:1840,c:"#d97706"},{n:"Tools",v:420,c:"#92400e"},{n:"Software",v:150,c:"#6366f1"},{n:"Vehicle",v:380,c:"#64748b"},{n:"Home Office",v:132,c:"#059669"},{n:"Processing",v:310,c:"#dc2626"}];
const PNL=[{m:"Apr",i:3200,e:1100},{m:"May",i:2800,e:950},{m:"Jun",i:3500,e:1200},{m:"Jul",i:2100,e:880},{m:"Aug",i:2900,e:1050},{m:"Sep",i:2990,e:1150},{m:"Oct",i:2720,e:980},{m:"Nov",i:4145,e:1300},{m:"Dec",i:2630,e:1100},{m:"Jan",i:3410,e:1250},{m:"Feb",i:2448,e:900}];

const $=n=>new Intl.NumberFormat("en-NZ",{style:"currency",currency:"NZD"}).format(n);
const SC=s=>({Enquiry:"bg-slate-100 text-slate-700",Quoted:"bg-blue-50 text-blue-700",Approved:"bg-indigo-50 text-indigo-700","In Progress":"bg-amber-50 text-amber-700",Complete:"bg-emerald-50 text-emerald-700",Invoiced:"bg-purple-50 text-purple-700",Draft:"bg-slate-100 text-slate-600",Sent:"bg-blue-50 text-blue-700",Paid:"bg-emerald-50 text-emerald-700",Overdue:"bg-red-50 text-red-700",Accepted:"bg-emerald-50 text-emerald-700",Declined:"bg-red-50 text-red-600",Active:"bg-emerald-50 text-emerald-700",Paused:"bg-amber-50 text-amber-700"}[s]||"bg-gray-100 text-gray-600");
const PD=p=>({High:"bg-red-500",Medium:"bg-amber-400",Low:"bg-slate-300"}[p]||"bg-slate-300");
const CC=t=>({Supplier:"bg-orange-50 text-orange-700",Contractor:"bg-blue-50 text-blue-700",Trade:"bg-violet-50 text-violet-700",Professional:"bg-teal-50 text-teal-700"}[t]||"bg-stone-100 text-stone-600");

/* === UI === */
function Sld({open,onClose,title,children}){useEffect(()=>{document.body.style.overflow=open?"hidden":"";return()=>{document.body.style.overflow=""}},[open]);if(!open)return null;return(<div className="fixed inset-0 z-50 flex justify-end"><div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}/><div className="relative w-full max-w-lg bg-white shadow-2xl border-l border-stone-200 overflow-y-auto" style={{animation:"slideIn .2s ease-out"}}><div className="sticky top-0 bg-white border-b border-stone-200 px-6 py-4 flex items-center justify-between z-10"><h2 className="text-lg font-semibold text-stone-900 fs">{title}</h2><button onClick={onClose} className="p-1.5 rounded-lg hover:bg-stone-100 text-stone-400"><X size={20}/></button></div><div className="p-6">{children}</div></div></div>)}
function FF({l,children,h}){return(<div className="mb-5"><label className="block text-sm font-medium text-stone-700 mb-1.5 fs">{l}</label>{children}{h&&<p className="mt-1 text-xs text-stone-400">{h}</p>}</div>)}
function I(p){return<input{...p}className="w-full px-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500"/>}
function S({options,ph,...p}){return(<select{...p}className="w-full px-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500 bg-white">{ph&&<option value="">{ph}</option>}{options.map(o=><option key={o}>{o}</option>)}</select>)}
function T(p){return<textarea rows={3}{...p}className="w-full px-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500 resize-none"/>}
function B({children,vr="primary",sz="md",icon:Ic,...p}){const v={primary:"bg-stone-900 text-white hover:bg-stone-800",secondary:"bg-stone-100 text-stone-700 hover:bg-stone-200",ghost:"text-stone-600 hover:bg-stone-100",danger:"bg-red-50 text-red-700 hover:bg-red-100",success:"bg-emerald-600 text-white hover:bg-emerald-700"};const s={sm:"px-3 py-1.5 text-xs",md:"px-4 py-2 text-sm"};return<button className={`inline-flex items-center justify-center font-medium rounded-lg transition-all gap-2 ${v[vr]} ${s[sz]}`}{...p}>{Ic&&<Ic size={sz==="sm"?14:16}/>}{children}</button>}
function NB({i,e}){if(!i&&!e)return null;return(<div className="space-y-2 mt-2">{i&&<div className="flex items-start gap-2 p-2.5 bg-amber-50 border border-amber-200 rounded-lg"><Lock size={13}className="text-amber-600 mt-0.5 flex-shrink-0"/><p className="text-xs text-amber-800">{i}</p></div>}{e&&<div className="flex items-start gap-2 p-2.5 bg-blue-50 border border-blue-200 rounded-lg"><Globe size={13}className="text-blue-600 mt-0.5 flex-shrink-0"/><p className="text-xs text-blue-800">{e}</p></div>}</div>)}
function NF({noExt}){return(<div className="space-y-4 p-4 bg-stone-50 rounded-lg border border-stone-200"><div className="flex items-center gap-2 mb-1"><MessageSquare size={14}className="text-stone-500"/><span className="text-sm font-semibold text-stone-700 fs">Notes</span></div><div><div className="flex items-center gap-1.5 mb-1.5"><Lock size={12}className="text-amber-600"/><label className="text-xs font-medium text-amber-700">Internal</label><span className="text-xs text-stone-400">— only you</span></div><T placeholder="Private notes..."/></div>{!noExt&&<div><div className="flex items-center gap-1.5 mb-1.5"><Globe size={12}className="text-blue-600"/><label className="text-xs font-medium text-blue-700">External</label><span className="text-xs text-stone-400">— on PDF</span></div><T placeholder="For client..."/></div>}</div>)}
function Stat({l,v,icon:Ic,ch,up,sub}){return(<div className="bg-white border border-stone-200 rounded-xl p-5 hover:border-stone-300"><div className="flex items-center justify-between mb-3"><span className="text-xs font-medium text-stone-500 uppercase tracking-wider">{l}</span><Ic size={16}className="text-stone-400"/></div><div className="text-2xl font-bold text-stone-900 fm">{v}</div>{(ch||sub)&&<div className="flex items-center gap-2 mt-1">{ch&&<span className={`text-xs font-medium ${up?"text-emerald-600":"text-stone-500"}`}>{ch}</span>}{sub&&<span className="text-xs text-stone-400">{sub}</span>}</div>}</div>)}
function Bk({onClick,label}){return<button onClick={onClick} className="inline-flex items-center gap-1.5 text-sm text-stone-500 hover:text-stone-700 mb-6"><ArrowLeft size={16}/>{label||"Back"}</button>}
function Tabs({items,active,onChange}){return<div className="flex gap-1 mb-6 bg-stone-100 p-1 rounded-lg overflow-x-auto">{items.map(s=><button key={s} onClick={()=>onChange(s)} className={`px-3 py-1.5 text-xs font-medium rounded-md whitespace-nowrap transition-all ${active===s?"bg-white text-stone-900 shadow-sm":"text-stone-500 hover:text-stone-700"}`}>{s}</button>)}</div>}
function Badge({s}){return<span className={`text-xs px-2.5 py-1 rounded-full font-medium ${SC(s)}`}>{s}</span>}

function useSort(defaultKey,defaultDir="asc"){const[sort,setSort]=useState({key:defaultKey,dir:defaultDir});const toggle=k=>{setSort(s=>s.key===k?{key:k,dir:s.dir==="asc"?"desc":"asc"}:{key:k,dir:"asc"})};const sorted=(arr,getVal)=>{const cp=[...arr];cp.sort((a,b)=>{const av=getVal?getVal(a,sort.key):a[sort.key];const bv=getVal?getVal(b,sort.key):b[sort.key];if(av==null)return 1;if(bv==null)return-1;if(typeof av==="number")return sort.dir==="asc"?av-bv:bv-av;return sort.dir==="asc"?String(av).localeCompare(String(bv)):String(bv).localeCompare(String(av))});return cp};return{sort,toggle,sorted}}
function SortTh({children,sortKey,sort,toggle,align}){const active=sort.key===sortKey;return<th className={`text-${align||"left"} text-xs font-medium text-stone-500 uppercase tracking-wider px-5 py-3 cursor-pointer hover:text-stone-700 select-none transition-colors`} onClick={()=>toggle(sortKey)}><span className="inline-flex items-center gap-1">{children}{active&&<span className="text-amber-500">{sort.dir==="asc"?"↑":"↓"}</span>}</span></th>}
function SearchBar({value,onChange,placeholder,children}){return<div className="flex items-center gap-3 mb-6"><div className="relative flex-1 max-w-sm"><svg className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg><input value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder||"Search..."} className="w-full pl-9 pr-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500"/></div>{children}</div>}

function useToast(){const[ts,setTs]=useState([]);const add=useCallback((m,t="info")=>{const id=Date.now();setTs(x=>[...x,{id,m,t}]);setTimeout(()=>setTs(x=>x.filter(y=>y.id!==id)),3e3)},[]);const Ts=()=>ts.length?<div className="fixed bottom-6 right-6 z-[60] space-y-2">{ts.map(t=><div key={t.id}className={`px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2 ${t.t==="success"?"bg-emerald-600 text-white":"bg-stone-800 text-white"}`}>{t.t==="success"?<Check size={16}/>:<Info size={16}/>}{t.m}</div>)}</div>:null;return{toast:add,Toasts:Ts}}

/* === FORMS === */
function JobF({c}){return<div><FF l="Job Title"><I placeholder="e.g. Custom Shelving"/></FF><FF l="Client"><S ph="— Select —" options={CL.map(c=>c.n)}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Type"><S options={["Fabrication","Design","Consulting","Other"]}/></FF><FF l="Priority"><S options={["Low","Medium","High"]}/></FF></div><FF l="Description"><T placeholder="Brief desc..."/></FF><div className="grid grid-cols-2 gap-4"><FF l="Value" h="Excl. GST"><I type="number" placeholder="0.00"/></FF><FF l="Due"><I type="date"/></FF></div><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={c}>Create Job</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function QuoteF({c}){return<div><FF l="Client"><S ph="— Select —" options={CL.map(c=>c.n)}/></FF><FF l="Linked Job"><S ph="— None —" options={JOBS.map(j=>j.t)}/></FF><div className="my-5"><div className="flex items-center justify-between mb-3"><h3 className="text-sm font-semibold text-stone-700 fs">Line Items</h3><B vr="ghost" sz="sm" icon={Plus}>Add Line</B></div><div className="p-3 bg-stone-50 rounded-lg border border-stone-200"><I placeholder="Description"/><div className="grid grid-cols-4 gap-2 mt-2"><div><label className="text-xs text-stone-500">Type</label><S options={["Labour","Materials","Flat Fee"]}/></div><div><label className="text-xs text-stone-500">Qty</label><I type="number" defaultValue="1"/></div><div><label className="text-xs text-stone-500">Rate</label><I type="number"/></div><div><label className="text-xs text-stone-500">Total</label><div className="px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm font-medium">$0.00</div></div></div></div></div><NF/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={FileCheck} onClick={c}>Create Quote</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function InvF({c}){return<div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-5"><div className="flex items-center gap-2 text-sm text-stone-600"><Hash size={14}/><span className="font-mono font-medium">SHMAKE-0015</span></div></div><FF l="Client"><S ph="— Select —" options={CL.map(c=>c.n)}/></FF><FF l="From Quote"><S ph="— Scratch —" options={["Q-0008","Q-0009"]}/></FF><div className="my-5"><div className="flex items-center justify-between mb-3"><h3 className="text-sm font-semibold text-stone-700 fs">Line Items</h3><B vr="ghost" sz="sm" icon={Plus}>Add</B></div><div className="p-3 bg-stone-50 rounded-lg border border-stone-200"><I defaultValue="Steel brackets x24"/><div className="grid grid-cols-4 gap-2 mt-2"><div><label className="text-xs text-stone-500">Type</label><S options={["Labour","Materials","Flat Fee"]}/></div><div><label className="text-xs text-stone-500">Qty</label><I type="number" defaultValue="24"/></div><div><label className="text-xs text-stone-500">Rate</label><I type="number" defaultValue="75"/></div><div><label className="text-xs text-stone-500">Total</label><div className="px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm font-medium">$1,800</div></div></div></div></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-5"><div className="flex justify-between text-sm mb-1"><span className="text-stone-500">Subtotal</span><span className="font-medium">$1,800</span></div><div className="flex justify-between text-sm mb-1"><span className="text-stone-500">GST</span><span className="font-medium">$270</span></div><div className="flex justify-between text-sm font-semibold border-t border-stone-300 pt-2 mt-2"><span>Total</span><span>$2,070</span></div></div><div className="grid grid-cols-2 gap-4"><FF l="Date"><I type="date" defaultValue="2026-02-12"/></FF><FF l="Due"><I type="date" defaultValue="2026-03-20"/></FF></div><NF/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={FileText} onClick={c}>Create Invoice</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function ExpF({c}){const[ap,setAp]=useState(false);return<div><FF l="Date"><I type="date" defaultValue="2026-02-12"/></FF><FF l="Description"><I placeholder="e.g. Steel from Metalcraft"/></FF><div className="grid grid-cols-2 gap-4"><FF l="Amount (incl GST)"><I type="number" placeholder="0.00"/></FF><FF l="GST Content"><I type="number" placeholder="0.00"/></FF></div><FF l="Category"><S options={["Materials","Tools","Software","Vehicle","Home Office","Marketing","Processing","Other"]}/></FF><FF l="Supplier"><S ph="— None —" options={CT.filter(c=>c.ty==="Supplier").map(c=>c.n)}/></FF><FF l="Linked Job"><S ph="— None —" options={JOBS.map(j=>j.t)}/></FF><div className="my-5 p-4 bg-stone-50 rounded-lg border border-stone-200"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={ap} onChange={e=>setAp(e.target.checked)} className="rounded border-stone-300 text-amber-600"/><span className="text-sm font-medium text-stone-700">Apportioned</span></label>{ap&&<div className="grid grid-cols-2 gap-4 mt-4"><FF l="Full Amount"><I type="number"/></FF><FF l="Biz %"><I type="number" placeholder="25"/></FF></div>}</div><FF l="Receipt"><div className="border-2 border-dashed border-stone-300 rounded-lg p-6 text-center hover:border-amber-400 cursor-pointer"><Upload size={20}className="mx-auto text-stone-400 mb-2"/><p className="text-sm text-stone-500">Drop or browse</p></div></FF><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={c}>Log Expense</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function ContactF({c}){return<div><FF l="Name"><I placeholder="Dave Murray"/></FF><FF l="Company"><I placeholder="Metalcraft"/></FF><FF l="Type"><S options={["Supplier","Contractor","Trade","Professional","Other"]}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Email"><I type="email"/></FF><FF l="Phone"><I/></FF></div><FF l="Tags" h="Comma-separated"><I/></FF><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={c}>Add Contact</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function ClientF({c}){return<div><FF l="Name"><I/></FF><div className="grid grid-cols-2 gap-4"><FF l="Email"><I type="email"/></FF><FF l="Phone"><I/></FF></div><FF l="Address"><I/></FF><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={c}>Add Client</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function MarkPaidF({c,toast}){return<div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-5"><p className="text-sm font-medium text-stone-700">SHMAKE-0013 — BuildRight</p><p className="text-xl font-bold fm mt-1">{$(2070)}</p></div><FF l="Payment Date"><I type="date" defaultValue="2026-02-12"/></FF><FF l="Amount"><I type="number" defaultValue="2070"/></FF><FF l="Method"><S options={["Bank Transfer","Cash","Cheque","Stripe","Other"]}/></FF><FF l="Reference"><I placeholder="Bank ref"/></FF><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B vr="success" icon={CheckCircle} onClick={()=>{toast("Marked as paid","success");c()}}>Confirm</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function IncSrcF({c,toast}){return<div><FF l="App Name"><I placeholder="myMECA"/></FF><FF l="Platform"><S options={["Stripe","Paddle","Other"]}/></FF><FF l="Pricing"><S options={["Monthly","Annual","One-time"]}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Price"><I type="number" placeholder="4.00"/></FF><FF l="Currency"><S options={["NZD","USD","AUD"]}/></FF></div><FF l="GST"><S options={["NZ only","All","No GST"]}/></FF><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={()=>{toast("Source added","success");c()}}>Add</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function TripF({c,toast}){return<div><FF l="Date"><I type="date" defaultValue="2026-02-12"/></FF><div className="grid grid-cols-2 gap-4"><FF l="From"><I placeholder="Home"/></FF><FF l="To"><I placeholder="Metalcraft"/></FF></div><FF l="Km"><I type="number"/></FF><FF l="Purpose"><I placeholder="Steel pickup"/></FF><FF l="Category"><S options={["Client visit","Supplier run","Site visit","Other"]}/></FF><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={()=>{toast("Trip logged","success");c()}}>Log Trip</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function HomeExpF({c,toast}){return<div><FF l="Month"><I type="month" defaultValue="2026-02"/></FF><FF l="Type"><S options={["Internet","Power","Insurance","Rates","Rent/Mortgage","Repairs","Other"]}/></FF><FF l="Full Amount"><I type="number"/></FF><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 my-4"><div className="flex justify-between text-sm"><span className="text-stone-600">Business %</span><span className="font-medium">10%</span></div><p className="text-xs text-stone-400 mt-1">From Settings</p></div><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={()=>{toast("Logged","success");c()}}>Log</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}

/* === SUB-VIEWS === */
function VehicleV({onBack,o}){const tk=TRIPS.reduce((s,t)=>s+t.km,0);return<div><Bk onClick={onBack} label="Back to Expenses"/><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Vehicle Log</h1><B sz="sm" icon={Plus} onClick={()=>o("trip")}>Log Trip</B></div><div className="grid grid-cols-4 gap-4 mb-6"><Stat l="Total Km" v={`${tk} km`} icon={Route} ch={`${TRIPS.length} trips`}/><Stat l="Method" v="Km Rate" icon={Calculator} sub="Petrol $1.17/$0.37"/><Stat l="Deduction (YTD)" v={$(tk*1.17)} icon={DollarSign} up ch="Tier 1"/><Stat l="Business Use" v="25%" icon={Percent}/></div><div className="bg-white border border-stone-200 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Route</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Km</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Purpose</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Deduction</th></tr></thead><tbody>{TRIPS.map(t=><tr key={t.id} className="border-b border-stone-100 hover:bg-stone-50"><td className="px-5 py-3 text-sm text-stone-500">{t.dt}</td><td className="px-5 py-3 text-sm text-stone-800">{t.fr} → {t.to}</td><td className="px-5 py-3 text-right text-sm font-medium fm">{t.km}</td><td className="px-5 py-3 text-sm text-stone-600">{t.p}</td><td className="px-5 py-3 text-right text-sm font-medium text-emerald-700 fm">{$(t.km*1.17)}</td></tr>)}</tbody></table></div><div className="mt-6 p-4 bg-stone-50 rounded-lg border border-stone-200"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-3">Annual Summary</h4><div className="grid grid-cols-3 gap-4"><div><p className="text-xs text-stone-500">Tier 1 (≤14,000km)</p><p className="text-sm font-medium fm">{tk}km × $1.17 = {$(tk*1.17)}</p></div><div><p className="text-xs text-stone-500">Tier 2 (&gt;14,000km)</p><p className="text-sm font-medium fm">0km</p></div><div><p className="text-xs text-stone-500">Total Deduction</p><p className="text-lg font-bold text-emerald-700 fm">{$(tk*1.17)}</p></div></div></div></div>}

function HomeV({onBack,o}){const td=HOEX.reduce((s,e)=>s+e.d,0);return<div><Bk onClick={onBack} label="Back to Expenses"/><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Home Office</h1><B sz="sm" icon={Plus} onClick={()=>o("homeExp")}>Log Expense</B></div><div className="grid grid-cols-4 gap-4 mb-6"><Stat l="Office" v="12 m²" icon={Home} sub="of 120 m²"/><Stat l="Business %" v="10%" icon={Percent}/><Stat l="Full Costs (YTD)" v={$(HOEX.reduce((s,e)=>s+e.f,0))} icon={Receipt}/><Stat l="Deductible (YTD)" v={$(td)} icon={DollarSign} up/></div><div className="bg-white border border-stone-200 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Month</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Type</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Full</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">%</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Deductible</th></tr></thead><tbody>{HOEX.map(e=><tr key={e.id} className="border-b border-stone-100 hover:bg-stone-50"><td className="px-5 py-3 text-sm text-stone-500">{e.m}</td><td className="px-5 py-3 text-sm text-stone-800">{e.ty}</td><td className="px-5 py-3 text-right text-sm fm">{$(e.f)}</td><td className="px-5 py-3 text-right text-sm text-stone-500">{e.pc}%</td><td className="px-5 py-3 text-right text-sm font-medium text-emerald-700 fm">{$(e.d)}</td></tr>)}</tbody></table></div></div>}

function RecurV({onBack,toast}){return<div><Bk onClick={onBack} label="Back to Invoices"/><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Recurring Invoices</h1><B sz="sm" icon={Plus}>New Template</B></div><div className="space-y-4">{RECTPL.map(t=><div key={t.id} className="bg-white border border-stone-200 rounded-xl p-5"><div className="flex items-start justify-between mb-4"><div><h3 className="text-sm font-semibold text-stone-800">{t.cl}</h3><p className="text-xs text-stone-500">{t.d}</p></div><Badge s={t.st}/></div><div className="grid grid-cols-4 gap-4 mb-4"><div><p className="text-xs text-stone-500">Amount</p><p className="text-sm font-semibold fm">{$(t.am)}</p></div><div><p className="text-xs text-stone-500">Frequency</p><p className="text-sm font-medium">{t.freq}</p></div><div><p className="text-xs text-stone-500">Next</p><p className="text-sm font-medium">{t.next||"—"}</p></div><div><p className="text-xs text-stone-500">Generated</p><p className="text-sm font-medium">{t.gen}</p></div></div><div className="flex gap-2">{t.st==="Active"&&<B vr="secondary" sz="sm" icon={Ban} onClick={()=>toast("Paused","info")}>Pause</B>}{t.st==="Paused"&&<B vr="secondary" sz="sm" icon={RefreshCw} onClick={()=>toast("Resumed","success")}>Resume</B>}<B vr="secondary" sz="sm" icon={Edit3}>Edit</B><B vr="danger" sz="sm" icon={Trash2} onClick={()=>toast("Cancelled","info")}>Cancel</B></div></div>)}</div></div>}

function StripeV({onBack,toast}){const[s,setS]=useState(1);return<div><Bk onClick={onBack} label="Back"/><h1 className="text-2xl font-bold text-stone-900 fs mb-6">Import Stripe</h1><div className="flex gap-2 mb-6">{[1,2,3].map(n=><div key={n} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium ${s>=n?"bg-stone-900 text-white":"bg-stone-100 text-stone-500"}`}>{["Upload","Preview","Confirm"][n-1]}</div>)}</div>
  {s===1&&<div className="bg-white border border-stone-200 rounded-xl p-8 text-center"><div className="border-2 border-dashed border-stone-300 rounded-lg p-12 hover:border-amber-400 cursor-pointer" onClick={()=>setS(2)}><FileSpreadsheet size={32}className="mx-auto text-stone-400 mb-3"/><p className="text-sm font-medium text-stone-700">Drop Stripe CSV here</p><p className="text-xs text-stone-400 mt-1">Balance transactions / Payouts</p></div></div>}
  {s===2&&<div><div className="bg-white border border-stone-200 rounded-xl overflow-hidden mb-4"><div className="px-5 py-3 bg-stone-50 border-b border-stone-200"><span className="text-sm font-semibold text-stone-700">4 rows detected</span></div><table className="w-full"><thead><tr className="border-b border-stone-200"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Type</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Desc</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-2">Gross</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-2">Fee</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-2">Net</th></tr></thead><tbody>{STRP.map(r=><tr key={r.id} className="border-b border-stone-100"><td className="px-5 py-2.5 text-xs text-stone-500">{r.dt}</td><td className="px-5 py-2.5"><span className={`text-xs px-2 py-0.5 rounded-full ${r.ty==="charge"?"bg-emerald-50 text-emerald-700":"bg-blue-50 text-blue-700"}`}>{r.ty}</span></td><td className="px-5 py-2.5 text-xs text-stone-600">{r.d}</td><td className="px-5 py-2.5 text-right text-xs fm">{r.g?$(r.g):"—"}</td><td className="px-5 py-2.5 text-right text-xs text-red-600 fm">{r.fe?`-${$(r.fe)}`:"—"}</td><td className="px-5 py-2.5 text-right text-xs font-medium fm">{$(r.ne)}</td></tr>)}</tbody></table></div><div className="flex gap-3"><B onClick={()=>setS(3)}>Continue</B><B vr="ghost" onClick={()=>setS(1)}>Back</B></div></div>}
  {s===3&&<div className="bg-white border border-stone-200 rounded-xl p-6 text-center"><CheckCircle size={48}className="mx-auto text-emerald-500 mb-4"/><h3 className="text-lg font-semibold text-stone-900 mb-2">Ready to Import</h3><p className="text-sm text-stone-600 mb-6">3 charges + 1 payout</p><div className="flex gap-3 justify-center"><B vr="success" icon={CheckCircle} onClick={()=>{toast("Imported","success");onBack()}}>Import</B><B vr="ghost" onClick={()=>setS(2)}>Back</B></div></div>}
</div>}

function BankV({onBack,toast}){const[s,setS]=useState(1);return<div><Bk onClick={onBack} label="Back"/><h1 className="text-2xl font-bold text-stone-900 fs mb-6">Bank Statement Import</h1><div className="flex gap-2 mb-6">{[1,2,3].map(n=><div key={n} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium ${s>=n?"bg-stone-900 text-white":"bg-stone-100 text-stone-500"}`}>{["Upload","Match","Done"][n-1]}</div>)}</div>
  {s===1&&<div className="bg-white border border-stone-200 rounded-xl p-8 text-center"><div className="border-2 border-dashed border-stone-300 rounded-lg p-12 hover:border-amber-400 cursor-pointer" onClick={()=>setS(2)}><FileSpreadsheet size={32}className="mx-auto text-stone-400 mb-3"/><p className="text-sm font-medium text-stone-700">Drop bank CSV here</p><p className="text-xs text-stone-400 mt-1">ASB, Westpac, ANZ, BNZ</p></div></div>}
  {s===2&&<div><div className="bg-white border border-stone-200 rounded-xl overflow-hidden mb-4"><div className="px-5 py-3 bg-stone-50 border-b border-stone-200 flex items-center justify-between"><span className="text-sm font-semibold text-stone-700">5 transactions</span><div className="flex gap-3 text-xs"><span className="text-emerald-600">3 matched</span><span className="text-amber-600">2 unmatched</span></div></div><table className="w-full"><thead><tr className="border-b border-stone-200"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Desc</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-2">Amount</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Match</th><th className="text-center text-xs font-medium text-stone-500 uppercase px-5 py-2">Action</th></tr></thead><tbody>{BANK.map(r=><tr key={r.id} className={`border-b border-stone-100 ${r.mt?"":"bg-amber-50/50"}`}><td className="px-5 py-3 text-xs text-stone-500">{r.dt}</td><td className="px-5 py-3 text-xs text-stone-800">{r.d}</td><td className={`px-5 py-3 text-right text-xs font-medium fm ${r.am>0?"text-emerald-700":"text-stone-700"}`}>{r.am>0?"+":""}{$(Math.abs(r.am))}</td><td className="px-5 py-3">{r.mt?<span className="inline-flex items-center gap-1 text-xs text-emerald-700"><Link2 size={11}/>{r.mt}</span>:<span className="text-xs text-amber-600">No match</span>}</td><td className="px-5 py-3 text-center">{r.mt?<button className="text-stone-400 hover:text-stone-600"><Unlink size={14}/></button>:<B vr="ghost" sz="sm">Create expense</B>}</td></tr>)}</tbody></table></div><div className="flex gap-3"><B onClick={()=>setS(3)}>Confirm</B><B vr="ghost" onClick={()=>setS(1)}>Back</B></div></div>}
  {s===3&&<div className="bg-white border border-stone-200 rounded-xl p-6 text-center"><CheckCircle size={48}className="mx-auto text-emerald-500 mb-4"/><h3 className="text-lg font-semibold text-stone-900 mb-2">Done</h3><p className="text-sm text-stone-600 mb-6">3 matched · 2 unmatched</p><B vr="success" icon={CheckCircle} onClick={()=>{toast("Imported","success");onBack()}}>Done</B></div>}
</div>}

/* === PAGES === */
function Dash({o}){return<div>
  <div className="flex items-center justify-between mb-8"><div><h1 className="text-2xl font-bold text-stone-900 fs">Dashboard</h1><p className="text-sm text-stone-500 mt-1">Feb 2026 · Tax year ending 31 Mar</p></div><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Plus} onClick={()=>o("exp")}>Expense</B><B vr="secondary" sz="sm" icon={FileText} onClick={()=>o("inv")}>Invoice</B><B sz="sm" icon={Plus} onClick={()=>o("job")}>New Job</B></div></div>
  <div className="grid grid-cols-4 gap-4 mb-8"><Stat l="Revenue (YTD)" v={$(14280)} icon={DollarSign} ch="+12%" up sub="Apr–Feb"/><Stat l="Outstanding" v={$(2817.5)} icon={Clock} ch="2 inv" sub="1 overdue"/><Stat l="Expenses (YTD)" v={$(4232)} icon={Receipt} ch="+8%"/><Stat l="Net Profit" v={$(10048)} icon={TrendingUp} ch="+15%" up sub="Before tax"/></div>
  <div className="grid grid-cols-3 gap-4 mb-8"><div className="col-span-2 bg-white border border-stone-200 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Revenue — 6 Months</h3><ResponsiveContainer width="100%" height={220}><BarChart data={REV} barGap={2}><CartesianGrid strokeDasharray="3 3" stroke="#e7e5e4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:12,fill:"#78716c"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:12,fill:"#78716c"}} axisLine={false} tickLine={false} width={50} tickFormatter={v=>`$${v/1e3}k`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:8,border:"1px solid #e7e5e4",fontSize:13}}/><Bar dataKey="inv" fill="#292524" radius={[4,4,0,0]} name="Invoices"/><Bar dataKey="sub" fill="#d97706" radius={[4,4,0,0]} name="Subs"/></BarChart></ResponsiveContainer></div><div className="bg-white border border-stone-200 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Expenses</h3><ResponsiveContainer width="100%" height={180}><RPie><Pie data={EC} cx="50%" cy="50%" innerRadius={45} outerRadius={75} dataKey="v" stroke="none">{EC.map((e,i)=><Cell key={i} fill={e.c}/>)}</Pie><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:8,border:"1px solid #e7e5e4",fontSize:13}}/></RPie></ResponsiveContainer><div className="grid grid-cols-2 gap-x-4 gap-y-1 mt-2">{EC.map((e,i)=><div key={i} className="flex items-center gap-1.5 text-xs text-stone-600"><div className="w-2 h-2 rounded-full" style={{background:e.c}}/>{e.n}</div>)}</div></div></div>
  <div className="grid grid-cols-2 gap-4"><div className="bg-white border border-stone-200 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 fs mb-4">Active Jobs</h3>{JOBS.filter(j=>!["Closed","Invoiced","Complete"].includes(j.st)).map(j=><div key={j.id} className="flex items-center justify-between py-2 border-b border-stone-100 last:border-0"><div className="flex items-center gap-3"><div className={`w-2 h-2 rounded-full ${PD(j.pr)}`}/><div><p className="text-sm font-medium text-stone-800">{j.t}{j.n&&<Lock size={11}className="inline ml-1.5 text-amber-500"/>}</p><p className="text-xs text-stone-400">{j.cl}</p></div></div><Badge s={j.st}/></div>)}</div>
    <div className="bg-white border border-stone-200 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 fs mb-4"><span className="inline-flex items-center gap-2"><AlertTriangle size={14}className="text-red-500"/>Attention</span></h3>{INV.filter(i=>i.st==="Overdue").map(inv=><div key={inv.id} className="p-3 bg-red-50 rounded-lg border border-red-100 mb-3"><div className="flex items-center justify-between"><div><p className="text-sm font-medium text-red-800">{inv.id} — Overdue</p><p className="text-xs text-red-600">{inv.cl} · Due {inv.due}</p></div><span className="text-sm font-semibold text-red-800 fm">{$(inv.am)}</span></div>{inv.inn&&<div className="flex items-start gap-1.5 mt-2 pt-2 border-t border-red-100"><Lock size={11}className="text-red-400 mt-0.5"/><p className="text-xs text-red-700">{inv.inn}</p></div>}</div>)}<div className="p-3 bg-amber-50 rounded-lg border border-amber-100"><p className="text-sm font-medium text-amber-800">GST Return Due</p><p className="text-xs text-amber-600">Period ending 31 Jan · Due 28 Feb</p></div></div>
  </div>
</div>}

function JobsPg({o}){const[f,sF]=useState("All");const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("t");const JS=["Enquiry","Quoted","Approved","In Progress","Complete","Invoiced","Closed"];const base=f==="All"?JOBS:JOBS.filter(j=>j.st===f);const fil=q?base.filter(j=>(j.t+j.cl+j.ty).toLowerCase().includes(q.toLowerCase())):base;const l=sorted(fil,(x,k)=>({t:x.t,cl:x.cl,ty:x.ty,st:x.st,v:x.v,due:x.due||""}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Jobs</h1><B sz="sm" icon={Plus} onClick={()=>o("job")}>New Job</B></div><Tabs items={["All",...JS]} active={f} onChange={sF}/><SearchBar value={q} onChange={sQ} placeholder="Search jobs..."/><div className="bg-white border border-stone-200 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="t" sort={sort} toggle={toggle}>Job</SortTh><SortTh sortKey="cl" sort={sort} toggle={toggle}>Client</SortTh><SortTh sortKey="ty" sort={sort} toggle={toggle}>Type</SortTh><SortTh sortKey="st" sort={sort} toggle={toggle}>Status</SortTh><SortTh sortKey="v" sort={sort} toggle={toggle} align="right">Value</SortTh><SortTh sortKey="due" sort={sort} toggle={toggle} align="right">Due</SortTh></tr></thead><tbody>{l.length?l.map(j=><tr key={j.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer"><td className="px-5 py-3.5"><div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${PD(j.pr)}`}/><span className="text-sm font-medium text-stone-800">{j.t}</span>{j.n&&<Lock size={11}className="text-amber-500"/>}</div></td><td className="px-5 py-3.5 text-sm text-stone-600">{j.cl}</td><td className="px-5 py-3.5"><span className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{j.ty}</span></td><td className="px-5 py-3.5"><Badge s={j.st}/></td><td className="px-5 py-3.5 text-right text-sm font-medium fm">{$(j.v)}</td><td className="px-5 py-3.5 text-right text-sm text-stone-500">{j.due||"—"}</td></tr>):<tr><td colSpan={6} className="px-5 py-8 text-center text-sm text-stone-400">No jobs found</td></tr>}</tbody></table></div></div>}

function ClientsPg({o}){const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("n");const fil=q?CL.filter(c=>(c.n+c.e+c.a).toLowerCase().includes(q.toLowerCase())):CL;const l=sorted(fil,(x,k)=>({n:x.n,e:x.e,a:x.a,j:x.j,r:x.r}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Clients</h1><B sz="sm" icon={Plus} onClick={()=>o("client")}>Add Client</B></div><SearchBar value={q} onChange={sQ} placeholder="Search clients..."/><div className="bg-white border border-stone-200 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="n" sort={sort} toggle={toggle}>Client</SortTh><SortTh sortKey="e" sort={sort} toggle={toggle}>Contact</SortTh><SortTh sortKey="a" sort={sort} toggle={toggle}>Address</SortTh><SortTh sortKey="j" sort={sort} toggle={toggle} align="center">Jobs</SortTh><SortTh sortKey="r" sort={sort} toggle={toggle} align="right">Revenue</SortTh></tr></thead><tbody>{l.length?l.map(c=><tr key={c.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer"><td className="px-5 py-3.5 text-sm font-medium text-stone-800">{c.n}</td><td className="px-5 py-3.5"><div className="text-sm text-stone-600">{c.e}</div><div className="text-xs text-stone-400">{c.p}</div></td><td className="px-5 py-3.5 text-sm text-stone-500 max-w-48 truncate">{c.a}</td><td className="px-5 py-3.5 text-sm text-center">{c.j}</td><td className="px-5 py-3.5 text-right text-sm font-medium fm">{$(c.r)}</td></tr>):<tr><td colSpan={5} className="px-5 py-8 text-center text-sm text-stone-400">No clients found</td></tr>}</tbody></table></div></div>}

function ContactsPg({o}){const[f,sF]=useState("All");const[q,sQ]=useState("");const base=f==="All"?CT:CT.filter(c=>c.ty===f);const l=q?base.filter(c=>(c.n+c.co+(c.tg||[]).join(" ")+(c.nt||"")).toLowerCase().includes(q.toLowerCase())):base;return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Contacts Directory</h1><B sz="sm" icon={Plus} onClick={()=>o("contact")}>Add Contact</B></div><Tabs items={["All","Supplier","Contractor","Trade","Professional","Other"]} active={f} onChange={sF}/><SearchBar value={q} onChange={sQ} placeholder="Search contacts..."/><div className="grid grid-cols-2 gap-4">{l.length?l.map(c=><div key={c.id} className="bg-white border border-stone-200 rounded-xl p-5 hover:border-stone-300 cursor-pointer"><div className="flex items-start justify-between mb-3"><div><h3 className="text-sm font-semibold text-stone-800">{c.n}</h3><p className="text-xs text-stone-500">{c.co}</p></div><span className={`text-xs px-2 py-0.5 rounded-full font-medium ${CC(c.ty)}`}>{c.ty}</span></div><div className="space-y-1.5 mb-3">{c.e&&<div className="flex items-center gap-2 text-xs text-stone-600"><Mail size={12}className="text-stone-400"/>{c.e}</div>}<div className="flex items-center gap-2 text-xs text-stone-600"><Phone size={12}className="text-stone-400"/>{c.p}</div></div>{c.tg?.length>0&&<div className="flex flex-wrap gap-1 mb-3">{c.tg.map(t=><span key={t} className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{t}</span>)}</div>}{c.nt&&<div className="flex items-start gap-2 p-2.5 bg-amber-50 border border-amber-200 rounded-lg"><Lock size={12}className="text-amber-600 mt-0.5"/><p className="text-xs text-amber-800">{c.nt}</p></div>}</div>):<div className="col-span-2 py-8 text-center text-sm text-stone-400">No contacts found</div>}</div></div>}

const MOCK_LI={
"Q-0008":[{description:"Logo design — Greymouth Kayaks",type:"Labour",quantity:1,unitPrice:800,total:800}],
"Q-0009":[{description:"Steel bracket fabrication x24",type:"Labour",quantity:24,unitPrice:75,total:1800}],
"Q-0007":[{description:"Workshop consultation — half day",type:"Labour",quantity:1,unitPrice:450,total:450}],
"Q-0006":[{description:"Design and fabrication — recycled rimu shelving unit",type:"Labour",quantity:1,unitPrice:1600,total:1600},{description:"Materials — recycled rimu timber, brackets, fixings",type:"Materials",quantity:1,unitPrice:800,total:800}],
"SHMAKE-0012":[{description:"Monthly consultancy — January",type:"Labour",quantity:1,unitPrice:300,total:300}],
"SHMAKE-0013":[{description:"Steel bracket fabrication",type:"Labour",quantity:24,unitPrice:75,total:1800}],
"SHMAKE-0014":[{description:"Timber shelving — 50% deposit",type:"Labour",quantity:1,unitPrice:1200,total:1200}],
"SHMAKE-0011":[{description:"Motorcycle pannier mounts",type:"Fabrication",quantity:1,unitPrice:650,total:650}],
"SHMAKE-0010":[{description:"Workshop consultation — half day",type:"Labour",quantity:1,unitPrice:450,total:450}],
};
function dlQuote(q){const cl=CL.find(c=>c.n===q.cl);generateQuotePdf({id:q.id,version:q.v||1,status:q.st,date:q.dt,expiryDate:q.exp||null,client:{name:cl?.n||q.cl,email:cl?.e||"",phone:cl?.p||"",address:cl?.a||""},jobTitle:q.job||"",lineItems:MOCK_LI[q.id]||[{description:q.job||"Services",type:"Labour",quantity:1,unitPrice:q.am-q.gst,total:q.am-q.gst}],subtotal:q.am-q.gst,gst:q.gst,total:q.am,externalNote:q.en||""})}
function dlInv(inv){const cl=CL.find(c=>c.n===inv.cl);generateInvoicePdf({id:inv.id,status:inv.st,date:inv.dt,dueDate:inv.due||null,client:{name:cl?.n||inv.cl,email:cl?.e||"",phone:cl?.p||"",address:cl?.a||""},lineItems:MOCK_LI[inv.id]||[{description:"Services",type:"Labour",quantity:1,unitPrice:inv.am-inv.gst,total:inv.am-inv.gst}],subtotal:inv.am-inv.gst,gst:inv.gst,total:inv.am,externalNote:inv.en||"",linkedQuote:inv.id==="SHMAKE-0013"?"Q-0009":null,paymentDate:inv.st==="Paid"?"2026-02-10":null})}
function dlExp(){const exps=EXP.map(e=>({date:e.dt,description:e.d,category:e.cat,job:e.job||null,amount:e.am,gst:e.gst||0,hasReceipt:!!e.rc,apportioned:!!e.ap,fullAmount:e.full||null,businessPercent:e.bp||null}));const ta=EXP.reduce((s,e)=>s+e.am,0);const tg=EXP.reduce((s,e)=>s+(e.gst||0),0);const cats={};EXP.forEach(e=>{cats[e.cat]=(cats[e.cat]||0)+e.am});generateExpenseReportPdf(exps,{from:"2026-01-01",to:"2026-02-28",label:"Jan–Feb 2026"},{totalAmount:ta,totalGst:tg,byCategory:Object.entries(cats).map(([category,amount])=>({category,amount}))})}

function QuotesPg({o,toast}){const[f,sF]=useState("All");const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("dt","desc");const base=f==="All"?QT:QT.filter(x=>x.st===f);const fil=q?base.filter(x=>(x.id+x.cl+x.job).toLowerCase().includes(q.toLowerCase())):base;const l=sorted(fil,(x,k)=>({id:x.id,cl:x.cl,st:x.st,am:x.am,dt:x.dt}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Quotes</h1><B sz="sm" icon={Plus} onClick={()=>o("quote")}>New Quote</B></div><Tabs items={["All","Draft","Sent","Accepted","Declined","Expired"]} active={f} onChange={sF}/><SearchBar value={q} onChange={sQ} placeholder="Search quotes..."/><div className="bg-white border border-stone-200 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="id" sort={sort} toggle={toggle}>Quote</SortTh><SortTh sortKey="cl" sort={sort} toggle={toggle}>Client / Job</SortTh><SortTh sortKey="st" sort={sort} toggle={toggle}>Status</SortTh><SortTh sortKey="am" sort={sort} toggle={toggle} align="right">Amount</SortTh><th className="w-12"></th></tr></thead><tbody>{l.map(q=><tr key={q.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer"><td className="px-5 py-3.5"><div className="flex items-center gap-2"><span className="text-sm font-mono font-medium text-stone-800">{q.id}</span>{q.v>1&&<span className="text-xs bg-stone-100 text-stone-500 px-1.5 py-0.5 rounded">v{q.v}</span>}{(q.inn||q.en)&&<MessageSquare size={12}className="text-stone-400"/>}</div></td><td className="px-5 py-3.5"><div className="text-sm text-stone-700">{q.cl}</div><div className="text-xs text-stone-400">{q.job}</div></td><td className="px-5 py-3.5"><Badge s={q.st}/></td><td className="px-5 py-3.5 text-right"><span className="text-sm font-medium fm">{$(q.am)}</span><span className="block text-xs text-stone-400">+{$(q.gst)} GST</span></td><td className="px-3"><div className="flex gap-1">{q.st==="Accepted"&&<button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={()=>toast("Invoice created","success")}><FileText size={14}/></button>}<button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={()=>{dlQuote(q);toast("PDF downloaded","success")}}><Download size={14}/></button></div></td></tr>)}</tbody></table></div><div className="mt-6 bg-white border border-stone-200 rounded-xl p-5"><div className="flex items-center justify-between mb-3"><div><h3 className="text-sm font-semibold text-stone-800 fs">Q-0006 — Timber Shelving</h3><p className="text-xs text-stone-500">v2 · Accepted</p></div><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Copy} onClick={()=>toast("Duplicated as Q-0010","success")}>Duplicate</B><B vr="secondary" sz="sm" icon={FileText} onClick={()=>toast("Invoice created","success")}>→ Invoice</B><B vr="secondary" sz="sm" icon={Download} onClick={()=>{dlQuote(QT.find(x=>x.id==="Q-0006"));toast("PDF downloaded","success")}}>PDF</B></div></div><NB i="V1 was $2800 — dropped rate." e="Incl. material & install. Recycled rimu."/></div></div>}

function InvPg({o,toast,setView}){const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("dt","desc");const fil=q?INV.filter(i=>(i.id+i.cl).toLowerCase().includes(q.toLowerCase())):INV;const l=sorted(fil,(x,k)=>({id:x.id,cl:x.cl,due:x.due||"",st:x.st,am:x.am,dt:x.dt}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Invoices</h1><div className="flex gap-2"><B vr="secondary" sz="sm" icon={RefreshCw} onClick={()=>setView("recurring")}>Recurring</B><B sz="sm" icon={Plus} onClick={()=>o("inv")}>New Invoice</B></div></div><div className="grid grid-cols-4 gap-4 mb-6">{[{l:"Draft",c:1,a:1380},{l:"Sent",c:1,a:2070},{l:"Paid",c:2,a:862.5},{l:"Overdue",c:1,a:747.5}].map((s,i)=><div key={i} className="bg-white border border-stone-200 rounded-xl p-4"><p className="text-xs font-medium text-stone-500 uppercase">{s.l}</p><p className="text-xl font-bold mt-1 fm">{$(s.a)}</p><p className="text-xs text-stone-400">{s.c} inv</p></div>)}</div><SearchBar value={q} onChange={sQ} placeholder="Search invoices..."/><div className="bg-white border border-stone-200 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="id" sort={sort} toggle={toggle}>Invoice</SortTh><SortTh sortKey="cl" sort={sort} toggle={toggle}>Client</SortTh><SortTh sortKey="due" sort={sort} toggle={toggle}>Due</SortTh><SortTh sortKey="st" sort={sort} toggle={toggle}>Status</SortTh><SortTh sortKey="am" sort={sort} toggle={toggle} align="right">Amount</SortTh><th className="w-10"></th></tr></thead><tbody>{l.map(inv=><tr key={inv.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer"><td className="px-5 py-3.5"><div className="flex items-center gap-2"><span className="text-sm font-mono font-medium text-stone-800">{inv.id}</span>{inv.rec&&<RefreshCw size={12}className="text-blue-500"/>}{(inv.inn||inv.en)&&<MessageSquare size={12}className="text-stone-400"/>}</div></td><td className="px-5 py-3.5 text-sm text-stone-600">{inv.cl}</td><td className="px-5 py-3.5 text-sm text-stone-500">{inv.due||"—"}</td><td className="px-5 py-3.5"><Badge s={inv.st}/></td><td className="px-5 py-3.5 text-right"><span className="text-sm font-medium fm">{$(inv.am)}</span><span className="block text-xs text-stone-400">GST {$(inv.gst)}</span></td><td className="px-3"><button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={()=>{dlInv(inv);toast("PDF downloaded","success")}}><Download size={14}/></button></td></tr>)}</tbody></table></div><div className="mt-6 bg-white border border-stone-200 rounded-xl p-5"><div className="flex items-center justify-between mb-3"><div><h3 className="text-sm font-semibold text-stone-800 fs">SHMAKE-0013 — BuildRight</h3><p className="text-xs text-stone-500">Sent · Due 20 Feb · {$(2070)}</p></div><div className="flex gap-2"><B vr="success" sz="sm" icon={CheckCircle} onClick={()=>o("markPaid")}>Mark Paid</B><B vr="secondary" sz="sm" icon={Send} onClick={()=>toast("Resent","success")}>Resend</B><B vr="secondary" sz="sm" icon={Download} onClick={()=>{dlInv(INV.find(x=>x.id==="SHMAKE-0013"));toast("PDF downloaded","success")}}>PDF</B></div></div><NB i="Dave pays ~15th." e="Per Quote Q-0009."/></div></div>}

function ExpPg({o,setView}){const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("dt","desc");const fil=q?EXP.filter(e=>(e.d+e.cat+(e.job||"")).toLowerCase().includes(q.toLowerCase())):EXP;const l=sorted(fil,(x,k)=>({dt:x.dt,d:x.d,cat:x.cat,job:x.job||"",am:x.am}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Expenses</h1><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Download} onClick={()=>dlExp()}>Export PDF</B><B vr="secondary" sz="sm" icon={Car} onClick={()=>setView("vehicle")}>Vehicle Log</B><B vr="secondary" sz="sm" icon={Home} onClick={()=>setView("home")}>Home Office</B><B sz="sm" icon={Plus} onClick={()=>o("exp")}>Log Expense</B></div></div><SearchBar value={q} onChange={sQ} placeholder="Search expenses..."/><div className="bg-white border border-stone-200 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="dt" sort={sort} toggle={toggle}>Date</SortTh><SortTh sortKey="d" sort={sort} toggle={toggle}>Description</SortTh><SortTh sortKey="cat" sort={sort} toggle={toggle}>Cat</SortTh><SortTh sortKey="job" sort={sort} toggle={toggle}>Job</SortTh><SortTh sortKey="am" sort={sort} toggle={toggle} align="right">Amount</SortTh><th className="text-center text-xs font-medium text-stone-500 uppercase px-5 py-3">Rcpt</th></tr></thead><tbody>{l.map(e=><tr key={e.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer"><td className="px-5 py-3.5 text-sm text-stone-500">{e.dt}</td><td className="px-5 py-3.5"><span className="text-sm text-stone-800">{e.d}</span>{e.ap&&<span className="ml-2 text-xs bg-amber-50 text-amber-700 px-1.5 py-0.5 rounded-full">{e.bp}%</span>}{e.auto&&<span className="ml-2 text-xs bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded-full">auto</span>}</td><td className="px-5 py-3.5"><span className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{e.cat}</span></td><td className="px-5 py-3.5 text-sm text-stone-500 max-w-40 truncate">{e.job||"—"}</td><td className="px-5 py-3.5 text-right"><span className="text-sm font-medium fm">{$(e.am)}</span>{e.ap&&<span className="block text-xs text-stone-400">of {$(e.full)}</span>}</td><td className="px-5 py-3.5 text-center">{e.rc?<CheckCircle size={16}className="mx-auto text-emerald-500"/>:<Circle size={16}className="mx-auto text-stone-300"/>}</td></tr>)}</tbody></table></div></div>}

function SubsPg({setView,o}){return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Subscriptions & Apps</h1><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Upload} onClick={()=>setView("stripe")}>Import Stripe</B><B sz="sm" icon={Plus} onClick={()=>o("incSrc")}>Add Source</B></div></div>{SUBS.map(a=><div key={a.id} className="bg-white border border-stone-200 rounded-xl p-6"><div className="flex items-start justify-between mb-6"><div><h2 className="text-lg font-semibold text-stone-900 fs">{a.app}</h2><p className="text-sm text-stone-500">{a.subscribers} subs</p></div><div className="text-right"><p className="text-2xl font-bold fm">{$(a.mrr)}</p><p className="text-xs text-stone-500">MRR</p></div></div><div className="grid grid-cols-3 gap-4 mb-6"><div className="bg-stone-50 rounded-lg p-4"><p className="text-xs font-medium text-stone-500 uppercase mb-1">Gross</p><p className="text-lg font-bold fm">{$(a.grossJan)}</p></div><div className="bg-red-50 rounded-lg p-4"><p className="text-xs font-medium text-red-500 uppercase mb-1">Fees</p><p className="text-lg font-bold text-red-700 fm">-{$(a.feesJan)}</p></div><div className="bg-emerald-50 rounded-lg p-4"><p className="text-xs font-medium text-emerald-600 uppercase mb-1">Net</p><p className="text-lg font-bold text-emerald-700 fm">{$(a.netJan)}</p></div></div><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">MRR Trend</h3><ResponsiveContainer width="100%" height={120}><LineChart data={a.trend.map((v,i)=>({m:["Aug","Sep","Oct","Nov","Dec","Jan","Feb"][i],v}))}><CartesianGrid strokeDasharray="3 3" stroke="#e7e5e4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:11,fill:"#78716c"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:11,fill:"#78716c"}} axisLine={false} tickLine={false} width={45} tickFormatter={v=>`$${v}`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:8,border:"1px solid #e7e5e4",fontSize:13}}/><Line type="monotone" dataKey="v" stroke="#d97706" strokeWidth={2.5} dot={{fill:"#d97706",r:3}}/></LineChart></ResponsiveContainer></div>)}</div>}

function RepPg({toast}){const[t,sT]=useState("pnl");const ti=PNL.reduce((s,d)=>s+d.i,0);const te=PNL.reduce((s,d)=>s+d.e,0);const sf=510.42;return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Reports</h1><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Download} onClick={()=>toast("CSV exported","success")}>Export</B><B vr="secondary" sz="sm" icon={Printer} onClick={()=>toast("Print opened","info")}>Print</B></div></div><Tabs items={["pnl","gst","tax","jobs"]} active={t} onChange={sT}/>
  {t==="pnl"&&<div><div className="bg-white border border-stone-200 rounded-xl p-5 mb-6"><ResponsiveContainer width="100%" height={240}><AreaChart data={PNL}><CartesianGrid strokeDasharray="3 3" stroke="#e7e5e4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:12,fill:"#78716c"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:12,fill:"#78716c"}} axisLine={false} tickLine={false} width={50} tickFormatter={v=>`$${v/1e3}k`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:8,border:"1px solid #e7e5e4",fontSize:13}}/><Area type="monotone" dataKey="i" fill="#d9770620" stroke="#d97706" strokeWidth={2} name="Income"/><Area type="monotone" dataKey="e" fill="#dc262620" stroke="#dc2626" strokeWidth={2} name="Expenses"/></AreaChart></ResponsiveContainer></div><div className="grid grid-cols-2 gap-6"><div className="bg-white border border-stone-200 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">Income</h3>{[["Invoices",ti*.65],["Subscriptions",ti*.35]].map(([l,v])=><div key={l} className="flex justify-between py-2 border-b border-stone-100"><span className="text-sm text-stone-600">{l}</span><span className="text-sm font-medium fm">{$(v)}</span></div>)}<div className="flex justify-between py-2 font-semibold"><span className="text-sm">Total</span><span className="fm">{$(ti)}</span></div></div><div className="bg-white border border-stone-200 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">Expenses</h3>{EC.map(e=><div key={e.n} className="flex justify-between py-2 border-b border-stone-100"><span className="text-sm text-stone-600">{e.n}</span><span className="text-sm font-medium fm">{$(e.v)}</span></div>)}<div className="flex justify-between py-2 border-b border-stone-100"><span className="text-sm text-stone-600">Stripe Fees</span><span className="text-sm font-medium fm">{$(sf)}</span></div><div className="flex justify-between py-2 font-semibold"><span className="text-sm">Total</span><span className="fm">{$(te+sf)}</span></div><div className="mt-4 pt-4 border-t-2 border-stone-900"><div className="flex justify-between"><span className="font-bold">NET PROFIT</span><span className="font-bold text-emerald-700 fm">{$(ti-te-sf)}</span></div></div></div></div></div>}
  {t==="gst"&&<div className="bg-white border border-stone-200 rounded-xl p-6"><h3 className="text-sm font-semibold text-stone-700 mb-1 fs">GST — Period Ending 31 Jan</h3><p className="text-xs text-stone-400 mb-6">Due 28 Feb</p><div className="space-y-4"><div className="p-4 bg-stone-50 rounded-lg">{[["Collected (Invoices)",742.5],["Collected (NZ Subs)",312]].map(([l,v])=><div key={l} className="flex justify-between mb-2"><span className="text-sm text-stone-600">{l}</span><span className="text-sm font-medium fm">{$(v)}</span></div>)}<div className="flex justify-between pt-2 border-t border-stone-200 font-semibold"><span className="text-sm">Total Collected</span><span className="fm">{$(1054.5)}</span></div></div><div className="p-4 bg-stone-50 rounded-lg"><div className="flex justify-between"><span className="text-sm text-stone-600">GST Paid</span><span className="text-sm font-medium fm">{$(186.3)}</span></div></div><div className="p-4 bg-amber-50 border border-amber-200 rounded-lg"><div className="flex justify-between font-bold"><span className="text-amber-900">To Pay IRD</span><span className="text-amber-900 fm">{$(868.2)}</span></div></div></div></div>}
  {t==="tax"&&<div className="bg-white border border-stone-200 rounded-xl p-6"><h3 className="text-sm font-semibold text-stone-700 mb-1 fs">Tax Year — Apr 25 to Mar 26</h3><p className="text-xs text-stone-400 mb-6">YTD · For IR3</p><div className="space-y-4"><div className="p-4 bg-stone-50 rounded-lg"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-3">Income</h4>{[["Invoices (excl GST)",21450],["Subscriptions (gross)",10680]].map(([l,v])=><div key={l} className="flex justify-between py-1.5"><span className="text-sm text-stone-600">{l}</span><span className="text-sm font-medium fm">{$(v)}</span></div>)}<div className="flex justify-between pt-2 border-t border-stone-200 font-semibold"><span className="text-sm">Total</span><span className="fm">{$(32130)}</span></div></div><div className="p-4 bg-stone-50 rounded-lg"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-3">Deductions</h4>{[["Materials & tools",2260],["Software",150],["Stripe fees",510.42],["Vehicle (25%)",380],["Home office (10%)",132],["Other",220]].map(([l,v])=><div key={l} className="flex justify-between py-1.5"><span className="text-sm text-stone-600">{l}</span><span className="text-sm font-medium fm">{$(v)}</span></div>)}<div className="flex justify-between pt-2 border-t border-stone-200 font-semibold"><span className="text-sm">Total</span><span className="fm">{$(3652.42)}</span></div></div><div className="p-4 bg-emerald-50 border border-emerald-200 rounded-lg"><div className="flex justify-between font-bold"><span className="text-emerald-900">Net Taxable</span><span className="text-emerald-900 fm">{$(28477.58)}</span></div><p className="text-xs text-emerald-700 mt-1">→ Rachel at Simmons Accounting</p></div></div></div>}
  {t==="jobs"&&<div className="bg-white border border-stone-200 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Job</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Revenue</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Costs</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Profit</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Margin</th></tr></thead><tbody>{[{t:"Timber Shelving",r:2400,e:680},{t:"Steel Brackets",r:1800,e:186},{t:"Ecoglo Consult",r:300,e:0},{t:"Pannier Mounts",r:650,e:120}].map((j,i)=><tr key={i} className="border-b border-stone-100"><td className="px-5 py-3.5 text-sm font-medium">{j.t}</td><td className="px-5 py-3.5 text-right text-sm font-medium fm">{$(j.r)}</td><td className="px-5 py-3.5 text-right text-sm text-red-600 fm">{$(j.e)}</td><td className="px-5 py-3.5 text-right text-sm font-medium text-emerald-700 fm">{$(j.r-j.e)}</td><td className="px-5 py-3.5 text-right text-sm">{((j.r-j.e)/j.r*100).toFixed(0)}%</td></tr>)}</tbody></table></div>}
</div>}

function SetPg({toast,setView}){const[t,sT]=useState("business");return<div><h1 className="text-2xl font-bold text-stone-900 fs mb-6">Settings</h1><div className="flex gap-6"><div className="w-48 flex-shrink-0 space-y-0.5">{[["business","Business"],["invoicing","Invoicing"],["deductions","Deductions"],["categories","Categories"],["data","Data"]].map(([k,l])=><button key={k} onClick={()=>sT(k)} className={`w-full text-left px-3 py-2 text-sm rounded-lg ${t===k?"bg-stone-200 text-stone-900 font-medium":"text-stone-500 hover:bg-stone-100"}`}>{l}</button>)}</div><div className="flex-1 bg-white border border-stone-200 rounded-xl p-6">
  {t==="business"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Business Details</h3><div className="grid grid-cols-2 gap-4"><FF l="Trading Name"><I defaultValue="SHMAKE"/></FF><FF l="Legal Name"><I defaultValue="Sam — Sole Trader"/></FF><FF l="GST #"><I defaultValue="123-456-789"/></FF><FF l="IRD #"><I defaultValue="12-345-678"/></FF><FF l="Bank"><I defaultValue="03-1234-0567890-00"/></FF><FF l="Email"><I defaultValue="sam@shmake.nz"/></FF></div><FF l="Logo"><div className="border-2 border-dashed border-stone-300 rounded-lg p-6 text-center hover:border-amber-400 cursor-pointer"><Upload size={20}className="mx-auto text-stone-400 mb-2"/><p className="text-sm text-stone-500">Upload</p></div></FF><div className="pt-4"><B icon={CheckCircle} onClick={()=>toast("Saved","success")}>Save</B></div></div>}
  {t==="invoicing"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Invoice Settings</h3><div className="grid grid-cols-2 gap-4"><FF l="Prefix"><I defaultValue="SHMAKE-"/></FF><FF l="Next #"><I type="number" defaultValue="15"/></FF><FF l="Terms"><S options={["7 days","14 days","20th following","30 days"]}/></FF><FF l="GST %"><I type="number" defaultValue="15"/></FF></div><FF l="Default Note" h="On every invoice"><T defaultValue="Thank you for your business."/></FF><div className="pt-4"><B icon={CheckCircle} onClick={()=>toast("Saved","success")}>Save</B></div></div>}
  {t==="deductions"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Tax Deductions</h3><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-6"><div className="flex items-center gap-2 mb-3"><Home size={16}className="text-stone-600"/><h4 className="text-sm font-semibold text-stone-700">Home Office</h4></div><div className="grid grid-cols-3 gap-4"><FF l="Office (m²)"><I type="number" defaultValue="12"/></FF><FF l="Total (m²)"><I type="number" defaultValue="120"/></FF><FF l="Biz %"><div className="px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm font-medium">10%</div></FF></div></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-6"><div className="flex items-center gap-2 mb-3"><Car size={16}className="text-stone-600"/><h4 className="text-sm font-semibold text-stone-700">Vehicle</h4></div><FF l="Method"><S options={["IRD Km Rate","Actual + %"]}/></FF><FF l="Type"><S options={["Petrol","Diesel","Hybrid","Electric"]}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Tier 1 (≤14k km)"><I type="number" defaultValue="1.17"/></FF><FF l="Tier 2 (>14k km)"><I type="number" defaultValue="0.37"/></FF></div></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200"><div className="flex items-center gap-2 mb-3"><Wifi size={16}className="text-stone-600"/><h4 className="text-sm font-semibold text-stone-700">Other</h4></div><div className="grid grid-cols-2 gap-4"><FF l="Phone %"><I type="number" defaultValue="50"/></FF><FF l="Internet %"><I type="number" defaultValue="10"/></FF></div></div><div className="pt-4"><B icon={CheckCircle} onClick={()=>toast("Saved","success")}>Save</B></div></div>}
  {t==="categories"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Categories</h3>{[["Expense",ECATEGORIES],["Job Types",JTYPES],["Contact",CTYPES]].map(([l,items])=><div key={l} className="mb-6"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-2">{l}</h4><div className="flex flex-wrap gap-2 mb-2">{items.map(i=><span key={i} className="inline-flex items-center gap-1.5 text-sm bg-stone-100 text-stone-700 px-3 py-1.5 rounded-lg">{i}<button className="text-stone-400 hover:text-red-500" onClick={()=>toast(`Removed "${i}"`)}><X size={12}/></button></span>)}</div><B vr="ghost" sz="sm" icon={Plus} onClick={()=>toast("Added","success")}>Add</B></div>)}</div>}
  {t==="data"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Data & Export</h3><div className="space-y-4"><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 flex items-center justify-between"><div><p className="text-sm font-medium text-stone-700">Export All</p><p className="text-xs text-stone-400">CSV of everything</p></div><B vr="secondary" sz="sm" icon={Download} onClick={()=>toast("Exported","success")}>Export</B></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 flex items-center justify-between"><div><p className="text-sm font-medium text-stone-700">Bank Statement</p><p className="text-xs text-stone-400">ASB, Westpac CSV</p></div><B vr="secondary" sz="sm" icon={Upload} onClick={()=>setView("bank")}>Import</B></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 flex items-center justify-between"><div><p className="text-sm font-medium text-stone-700">Stripe Transactions</p><p className="text-xs text-stone-400">Balance / payouts</p></div><B vr="secondary" sz="sm" icon={Upload} onClick={()=>setView("stripe")}>Import</B></div></div></div>}
</div></div></div>}

/* === APP === */
const NAV=[{id:"dashboard",l:"Dashboard",ic:LayoutDashboard},{id:"jobs",l:"Jobs",ic:Briefcase,b:4},{id:"clients",l:"Clients",ic:Users},{id:"contacts",l:"Contacts",ic:BookOpen},{id:"quotes",l:"Quotes",ic:FileCheck},{id:"invoices",l:"Invoices",ic:FileText,b:1},{id:"subscriptions",l:"Subscriptions",ic:CreditCard},{id:"expenses",l:"Expenses",ic:Receipt},{id:"reports",l:"Reports",ic:PieChart},{id:"settings",l:"Settings",ic:Settings}];
const FT={job:"New Job",quote:"New Quote",inv:"New Invoice",exp:"Log Expense",contact:"New Contact",client:"New Client",markPaid:"Record Payment",incSrc:"Add Income Source",trip:"Log Trip",homeExp:"Home Expense"};

export default function App(){
  const[pg,sPg]=useState("dashboard");
  const[vw,sVw]=useState(null);
  const[sl,sSl]=useState({o:false,t:null});
  const{toast,Toasts}=useToast();
  const o=t=>sSl({o:true,t});const c=()=>sSl({o:false,t:null});const gb=()=>sVw(null);

  const form=()=>{switch(sl.t){case"job":return<JobF c={c}/>;case"quote":return<QuoteF c={c}/>;case"inv":return<InvF c={c}/>;case"exp":return<ExpF c={c}/>;case"contact":return<ContactF c={c}/>;case"client":return<ClientF c={c}/>;case"markPaid":return<MarkPaidF c={c} toast={toast}/>;case"incSrc":return<IncSrcF c={c} toast={toast}/>;case"trip":return<TripF c={c} toast={toast}/>;case"homeExp":return<HomeExpF c={c} toast={toast}/>;default:return null}};

  const page=()=>{
    if(vw==="vehicle")return<VehicleV onBack={gb} o={o}/>;
    if(vw==="home")return<HomeV onBack={gb} o={o}/>;
    if(vw==="recurring")return<RecurV onBack={gb} toast={toast}/>;
    if(vw==="stripe")return<StripeV onBack={gb} toast={toast}/>;
    if(vw==="bank")return<BankV onBack={gb} toast={toast}/>;
    switch(pg){case"dashboard":return<Dash o={o}/>;case"jobs":return<JobsPg o={o}/>;case"clients":return<ClientsPg o={o}/>;case"contacts":return<ContactsPg o={o}/>;case"quotes":return<QuotesPg o={o} toast={toast}/>;case"invoices":return<InvPg o={o} toast={toast} setView={sVw}/>;case"expenses":return<ExpPg o={o} setView={sVw}/>;case"subscriptions":return<SubsPg setView={sVw} o={o}/>;case"reports":return<RepPg toast={toast}/>;case"settings":return<SetPg toast={toast} setView={sVw}/>}
  };

  return(<div className="flex h-screen bg-stone-100">
    <div className="w-60 bg-white flex flex-col flex-shrink-0 border-r border-stone-200"><div className="px-5 py-5 border-b border-stone-200"><div className="flex items-center gap-3"><div className="w-9 h-9 bg-amber-500 rounded-lg flex items-center justify-center"><span className="text-sm font-bold text-white fm">S</span></div><div><h1 className="text-sm font-bold text-stone-900 tracking-wide fs">SHMAKE</h1><p className="text-xs text-stone-400">Admin</p></div></div></div>
      <nav className="flex-1 px-3 py-4 space-y-0.5 overflow-y-auto">{NAV.map(n=>{const a=pg===n.id&&!vw;return<button key={n.id} onClick={()=>{sPg(n.id);sVw(null)}} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all ${a?"bg-stone-100 text-stone-900":"text-stone-500 hover:text-stone-900 hover:bg-stone-50"}`}><n.ic size={18}className={a?"text-amber-500":""}/><span className="flex-1 text-left">{n.l}</span>{n.b&&<span className={`text-xs px-1.5 py-0.5 rounded-full ${a?"bg-amber-500/20 text-amber-600":"bg-stone-100 text-stone-500"}`}>{n.b}</span>}</button>})}</nav>
      <div className="px-5 py-4 border-t border-stone-200"><div className="flex items-center gap-3"><div className="w-8 h-8 bg-stone-200 rounded-full flex items-center justify-center"><span className="text-xs font-semibold text-stone-600">SM</span></div><div><p className="text-sm font-medium text-stone-700">Sam</p><p className="text-xs text-stone-400">Sole Trader</p></div></div></div>
    </div>
    <div className="flex-1 overflow-y-auto"><div className="max-w-screen-xl mx-auto px-8 py-8">{page()}</div></div>
    <Sld open={sl.o} onClose={c} title={FT[sl.t]||""}>{form()}</Sld><Toasts/>
  </div>);
}
