import { useState, useEffect, useCallback, useRef, Fragment } from "react";
import { LayoutDashboard,Briefcase,Users,FileText,Receipt,CreditCard,PieChart,Settings,Plus,X,Clock,DollarSign,AlertTriangle,TrendingUp,CheckCircle,Circle,Home,FileCheck,RefreshCw,Upload,Hash,BookOpen,Lock,Globe,MessageSquare,Phone,Mail,Download,Printer,Copy,Car,Wifi,ArrowLeft,Route,Percent,Calculator,Send,Eye,MoreVertical,Ban,Edit3,Trash2,Link2,Unlink,FileSpreadsheet,Check,Info,Image,Target } from "lucide-react";
import { BarChart,Bar,XAxis,YAxis,Tooltip,ResponsiveContainer,LineChart,Line,CartesianGrid,PieChart as RPie,Pie,Cell,AreaChart,Area } from "recharts";
import { generateInvoicePdf, generateQuotePdf, generateExpenseReportPdf } from "../lib/pdf";
import { useAuth } from "../context/AuthContext";
import { loadProjects, HERO_CARDS, ABOUT_CONTENT, CONTACT_CONFIG, SITE_META } from "../data/projects";
import * as db from "../lib/db";

/* === DATA (populated from Supabase via reload()) === */
let JOBS=[],CL=[],CT=[],QT=[],INV=[],EXP=[],TRIPS=[],HOEX=[],RECTPL=[],STRP=[],SUBS=[],BANK=[],REV=[],EC=[],PNL=[],ECATEGORIES=[],ICATEGORIES=["Invoicing","Subscriptions"],JTYPES=[],CTYPES=[],BUDGET=[],MPAY=[],ENQ=[];
let DEDS={homeOffice:{officeSqm:12,totalSqm:120,percent:10},vehicle:{method:"IRD Km Rate",type:"Petrol",tier1:1.17,tier2:0.37},phonePercent:50,internetPercent:10};
let BIZ={tradingName:"",legalName:"",gstNumber:"",irdNumber:"",bankAccount:"",email:"",logo:""};
let INVSET={prefix:"SHMAKE-",nextNumber:1,terms:"20th following",gstPercent:15,defaultNote:""};

const $=n=>new Intl.NumberFormat("en-NZ",{style:"currency",currency:"NZD"}).format(n);
const SC=s=>({Quoted:"bg-blue-50 text-blue-700",Approved:"bg-indigo-50 text-indigo-700","In Progress":"bg-amber-50 text-amber-700",Complete:"bg-emerald-50 text-emerald-700",Invoiced:"bg-purple-50 text-purple-700",Draft:"bg-slate-100 text-slate-600",Sent:"bg-blue-50 text-blue-700",Paid:"bg-emerald-50 text-emerald-700",Overdue:"bg-red-50 text-red-700",Accepted:"bg-emerald-50 text-emerald-700",Declined:"bg-red-50 text-red-600",Active:"bg-emerald-50 text-emerald-700",Paused:"bg-amber-50 text-amber-700"}[s]||"bg-gray-100 text-gray-600");
const PD=p=>({High:"bg-red-500",Medium:"bg-amber-400",Low:"bg-slate-300"}[p]||"bg-slate-300");
const CC=t=>({Supplier:"bg-orange-50 text-orange-700",Contractor:"bg-blue-50 text-blue-700",Trade:"bg-violet-50 text-violet-700",Professional:"bg-teal-50 text-teal-700"}[t]||"bg-stone-100 text-stone-600");

/* === UI COMPONENTS === */
function Sld({open,onClose,title,wide,children}){useEffect(()=>{document.body.style.overflow=open?"hidden":"";return()=>{document.body.style.overflow=""}},[open]);if(!open)return null;return(<div className="fixed inset-0 z-50 flex justify-end"><div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" onClick={onClose}/><div className={`relative w-full ${wide?"max-w-3xl":"max-w-lg"} bg-white shadow-2xl border-l border-stone-200 overflow-y-auto`} style={{animation:"slideIn .2s ease-out"}}><div className="sticky top-0 bg-white border-b border-stone-200 px-6 py-4 flex items-center justify-between z-10"><h2 className="text-lg font-semibold text-stone-900 fs">{title}</h2><button onClick={onClose} className="p-1.5 rounded-lg hover:bg-stone-100 text-stone-400"><X size={20}/></button></div><div className="p-6">{children}</div></div></div>)}
function FF({l,children,h}){return(<div className="mb-5"><label className="block text-sm font-medium text-stone-700 mb-1.5 fs">{l}</label>{children}{h&&<p className="mt-1 text-xs text-stone-400">{h}</p>}</div>)}
function I(p){return<input{...p}className="w-full px-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500"/>}
function S({options,ph,...p}){return(<select{...p}className="w-full px-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500 bg-white">{ph&&<option value="">{ph}</option>}{options.map(o=><option key={o}>{o}</option>)}</select>)}
function T(p){return<textarea rows={3}{...p}className="w-full px-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500 resize-none"/>}
function B({children,vr="primary",sz="md",icon:Ic,...p}){const v={primary:"bg-stone-900 text-white hover:bg-stone-800",secondary:"bg-stone-100 text-stone-700 hover:bg-stone-200",ghost:"text-stone-600 hover:bg-stone-100",danger:"bg-red-50 text-red-700 hover:bg-red-100",success:"bg-emerald-600 text-white hover:bg-emerald-700"};const s={sm:"px-3 py-1.5 text-xs",md:"px-4 py-2 text-sm"};return<button className={`inline-flex items-center justify-center font-medium rounded-lg transition-all gap-2 ${v[vr]} ${s[sz]}`}{...p}>{Ic&&<Ic size={sz==="sm"?14:16}/>}{children}</button>}
function NB({i,e}){if(!i&&!e)return null;return(<div className="space-y-2 mt-2">{i&&<div className="flex items-start gap-2 p-2.5 bg-amber-50 border border-amber-200 rounded-lg"><Lock size={13}className="text-amber-600 mt-0.5 flex-shrink-0"/><p className="text-xs text-amber-800">{i}</p></div>}{e&&<div className="flex items-start gap-2 p-2.5 bg-blue-50 border border-blue-200 rounded-lg"><Globe size={13}className="text-blue-600 mt-0.5 flex-shrink-0"/><p className="text-xs text-blue-800">{e}</p></div>}</div>)}
function NF({noExt}){return(<div className="space-y-4 p-4 bg-stone-50 rounded-lg border border-stone-200"><div className="flex items-center gap-2 mb-1"><MessageSquare size={14}className="text-stone-500"/><span className="text-sm font-semibold text-stone-700 fs">Notes</span></div><div><div className="flex items-center gap-1.5 mb-1.5"><Lock size={12}className="text-amber-600"/><label className="text-xs font-medium text-amber-700">Internal</label><span className="text-xs text-stone-400">— only you</span></div><T placeholder="Private notes..."/></div>{!noExt&&<div><div className="flex items-center gap-1.5 mb-1.5"><Globe size={12}className="text-blue-600"/><label className="text-xs font-medium text-blue-700">External</label><span className="text-xs text-stone-400">— on PDF</span></div><T placeholder="For client..."/></div>}</div>)}
function Stat({l,v,icon:Ic,ch,up,sub}){return(<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><div className="flex items-center justify-between mb-2"><span className="text-xs font-medium text-stone-400 uppercase tracking-wider">{l}</span><Ic size={15}className="text-stone-300"/></div><div className="text-xl font-semibold text-stone-800 fm">{v}</div>{(ch||sub)&&<div className="flex items-center gap-2 mt-1">{ch&&<span className={`text-xs font-medium ${up?"text-emerald-600":"text-stone-500"}`}>{ch}</span>}{sub&&<span className="text-xs text-stone-400">{sub}</span>}</div>}</div>)}
function Bk({onClick,label}){return<button onClick={onClick} className="inline-flex items-center gap-1.5 text-sm text-stone-500 hover:text-stone-700 mb-6"><ArrowLeft size={16}/>{label||"Back"}</button>}
function Tabs({items,active,onChange}){return<div className="flex gap-1 mb-6 bg-stone-100 p-1 rounded-lg overflow-x-auto">{items.map(s=><button key={s} onClick={()=>onChange(s)} className={`px-3 py-1.5 text-xs font-medium rounded-md whitespace-nowrap transition-all ${active===s?"bg-white text-stone-900 shadow-sm":"text-stone-500 hover:text-stone-700"}`}>{s}</button>)}</div>}
function Badge({s}){return<span className={`text-xs px-2.5 py-1 rounded-full font-medium ${SC(s)}`}>{s}</span>}
function ImgUp({value,onChange,h,accept}){const ref=useRef(null);const[pv,sPv]=useState(null);const[pvType,sPvType]=useState(null);const[upl,sUpl]=useState(false);const[drag,sDrag]=useState(false);const acc=accept||"image/*";const isPdf=url=>url&&(/\.pdf(\?|$)/i.test(url));const doUpload=async file=>{if(!file)return;sUpl(true);sPvType(file.type);sPv(file.type==="application/pdf"?"pdf":URL.createObjectURL(file));const folder=file.type==="application/pdf"?"receipts":"images";const url=await db.uploadFile(file,folder);sUpl(false);if(url)onChange(url);else{sPv(null);sPvType(null);onChange("")}};const pick=e=>{const file=e.target.files?.[0];if(file)doUpload(file);e.target.value=""};const validDrop=f=>f&&(f.type.startsWith("image/")||f.type==="application/pdf");const onDrop=e=>{e.preventDefault();sDrag(false);const file=e.dataTransfer.files?.[0];if(validDrop(file))doUpload(file)};const src=pv||(value?(/^https?:\/\//.test(value)?value:`/${value}`):null);const pdf=pv==="pdf"||isPdf(value);return<div><div className={`relative rounded-lg overflow-hidden ${src?"group border border-stone-200":`border-2 border-dashed ${drag?"border-amber-400 bg-amber-50/50":"border-stone-300 hover:border-amber-400"} cursor-pointer flex flex-col items-center justify-center`}`} style={{height:h||128}} onClick={()=>!src&&ref.current?.click()} onDragOver={e=>{e.preventDefault();sDrag(true)}} onDragLeave={()=>sDrag(false)} onDrop={onDrop}>{src?<>{pdf?<div className="w-full h-full flex flex-col items-center justify-center bg-stone-50"><FileText size={32} className="text-red-500 mb-1"/><p className="text-xs text-stone-600 font-medium">PDF Receipt</p></div>:<img src={src} alt="" className="w-full h-full object-cover"/>}{upl&&<div className="absolute inset-0 bg-black/50 flex items-center justify-center"><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"/></div>}<div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">{pdf&&<a href={value} target="_blank" rel="noreferrer" onClick={e=>e.stopPropagation()} className="p-1.5 bg-white rounded-lg text-stone-600 hover:text-stone-900"><Eye size={14}/></a>}<button type="button" onClick={e=>{e.stopPropagation();ref.current?.click()}} className="p-1.5 bg-white rounded-lg text-stone-600 hover:text-stone-900"><Upload size={14}/></button><button type="button" onClick={e=>{e.stopPropagation();sPv(null);sPvType(null);onChange("")}} className="p-1.5 bg-white rounded-lg text-stone-600 hover:text-red-500"><X size={14}/></button></div></>:<>{upl?<div className="w-5 h-5 border-2 border-stone-400 border-t-transparent rounded-full animate-spin"/>:<><Upload size={h&&h<100?16:20} className="text-stone-400 mb-1"/><p className={`text-stone-500 ${h&&h<100?"text-[10px]":"text-xs"}`}>{drag?"Drop here":"Upload"}</p></>}</>}</div><input ref={ref} type="file" accept={acc} className="hidden" onChange={pick}/></div>}

function useSort(defaultKey,defaultDir="asc"){const[sort,setSort]=useState({key:defaultKey,dir:defaultDir});const toggle=k=>{setSort(s=>s.key===k?{key:k,dir:s.dir==="asc"?"desc":"asc"}:{key:k,dir:"asc"})};const sorted=(arr,getVal)=>{const cp=[...arr];cp.sort((a,b)=>{const av=getVal?getVal(a,sort.key):a[sort.key];const bv=getVal?getVal(b,sort.key):b[sort.key];if(av==null)return 1;if(bv==null)return-1;if(typeof av==="number")return sort.dir==="asc"?av-bv:bv-av;return sort.dir==="asc"?String(av).localeCompare(String(bv)):String(bv).localeCompare(String(av))});return cp};return{sort,toggle,sorted}}
function SortTh({children,sortKey,sort,toggle,align}){return<th className={`text-${align||"left"} text-xs font-medium text-stone-500 uppercase tracking-wider px-5 py-3 cursor-pointer hover:text-stone-700 select-none transition-colors`} onClick={()=>toggle(sortKey)}><span className="inline-flex items-center gap-1">{children}{sort.key===sortKey&&<span className="text-amber-500">{sort.dir==="asc"?"↑":"↓"}</span>}</span></th>}
function SearchBar({value,onChange,placeholder,children}){return<div className="flex items-center gap-3 mb-6"><div className="relative flex-1 max-w-sm"><svg className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg><input value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder||"Search..."} className="w-full pl-9 pr-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500"/></div>{children}</div>}

function useToast(){const[ts,setTs]=useState([]);const add=useCallback((m,t="info")=>{const id=Date.now();setTs(x=>[...x,{id,m,t}]);setTimeout(()=>setTs(x=>x.filter(y=>y.id!==id)),3e3)},[]);const Ts=()=>ts.length?<div className="fixed bottom-6 right-6 z-[60] space-y-2">{ts.map(t=><div key={t.id}className={`px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2 ${t.t==="success"?"bg-emerald-600 text-white":"bg-stone-800 text-white"}`}>{t.t==="success"?<Check size={16}/>:<Info size={16}/>}{t.m}</div>)}</div>:null;return{toast:add,Toasts:Ts}}

/* === FORMS === */
function JobF({c,item,toast,reload}){const isNew=!item;const[f,sF]=useState({t:item?.t||"",cl:item?.cl||"",ty:item?.ty||"Fabrication",pr:item?.pr||"Medium",st:item?.st||"Quoted",v:item?.v||"",due:item?.due||""});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><FF l="Job Title"><I value={f.t} onChange={e=>u("t",e.target.value)} placeholder="e.g. Custom Shelving"/></FF><FF l="Client"><S value={f.cl} onChange={e=>u("cl",e.target.value)} ph="— Select —" options={CL.map(c=>c.n)}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Type"><S value={f.ty} onChange={e=>u("ty",e.target.value)} options={JTYPES}/></FF><FF l="Priority"><S value={f.pr} onChange={e=>u("pr",e.target.value)} options={["Low","Medium","High"]}/></FF></div>{!isNew&&<FF l="Status"><S value={f.st} onChange={e=>u("st",e.target.value)} options={["Quoted","Approved","In Progress","Complete","Invoiced","Closed"]}/></FF>}<FF l="Description"><T placeholder="Brief desc..."/></FF><div className="grid grid-cols-2 gap-4"><FF l="Value" h="Excl. GST"><I type="number" value={f.v} onChange={e=>u("v",e.target.value)} placeholder="0.00"/></FF><FF l="Due"><I type="date" value={f.due} onChange={e=>u("due",e.target.value)}/></FF></div><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?Plus:CheckCircle} onClick={async()=>{if(isNew)await db.createJob(f);else await db.updateJob(item.id,f);await reload();toast(isNew?"Job created":"Job updated","success");c()}}>{isNew?"Create Job":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteJob(item.id);await reload();toast("Job deleted","info");c()}}>Delete</B>}</div></div>}
function QuoteF({c,item,toast,reload}){const isNew=!item;const[li,setLi]=useState([]);useEffect(()=>{if(item)db.getLineItems("quote",item.id).then(setLi)},[item]);const[f,sF]=useState({cl:item?.cl||"",job:item?.job||"",st:item?.st||"Draft",dt:item?.dt||"",exp:item?.exp||"",en:item?.en||"",inn:item?.inn||""});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><FF l="Client"><S value={f.cl} onChange={e=>u("cl",e.target.value)} ph="— Select —" options={CL.map(c=>c.n)}/></FF><FF l="Linked Job"><S value={f.job} onChange={e=>u("job",e.target.value)} ph="— None —" options={JOBS.map(j=>j.t)}/></FF>{!isNew&&<div className="grid grid-cols-2 gap-4"><FF l="Status"><S value={f.st} onChange={e=>u("st",e.target.value)} options={["Draft","Sent","Accepted","Declined","Expired"]}/></FF><FF l="Version"><div className="px-3 py-2 bg-stone-50 border border-stone-200 rounded-lg text-sm font-medium fm">v{item.v||1}</div></FF></div>}<div className="grid grid-cols-2 gap-4"><FF l="Date"><I type="date" value={f.dt} onChange={e=>u("dt",e.target.value)}/></FF><FF l="Expires"><I type="date" value={f.exp} onChange={e=>u("exp",e.target.value)}/></FF></div><div className="my-5"><div className="flex items-center justify-between mb-3"><h3 className="text-sm font-semibold text-stone-700 fs">Line Items</h3><B vr="ghost" sz="sm" icon={Plus}>Add Line</B></div>{(isNew?[{}]:li).map((l,i)=><div key={i} className="p-3 bg-stone-50 rounded-lg border border-stone-200 mb-2"><I defaultValue={l.description||""} placeholder="Description"/><div className="grid grid-cols-4 gap-2 mt-2"><div><label className="text-xs text-stone-500">Type</label><S defaultValue={l.type||"Labour"} options={["Labour","Materials","Flat Fee"]}/></div><div><label className="text-xs text-stone-500">Qty</label><I type="number" defaultValue={l.quantity||1}/></div><div><label className="text-xs text-stone-500">Rate</label><I type="number" defaultValue={l.unitPrice||""}/></div><div><label className="text-xs text-stone-500">Total</label><div className="px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm font-medium fm">{$(l.total||0)}</div></div></div></div>)}</div>{!isNew&&<div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-5"><div className="flex justify-between text-sm mb-1"><span className="text-stone-500">Subtotal</span><span className="font-medium fm">{$(item.am-(item.gst||0))}</span></div><div className="flex justify-between text-sm mb-1"><span className="text-stone-500">GST</span><span className="font-medium fm">{$(item.gst||0)}</span></div><div className="flex justify-between text-sm font-semibold border-t border-stone-300 pt-2 mt-2"><span>Total</span><span className="fm">{$(item.am)}</span></div></div>}<NF/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?FileCheck:CheckCircle} onClick={async()=>{if(isNew){const id=await db.nextQuoteId();if(id)await db.createQuote({...f,id})}else await db.updateQuote(item.id,f);await reload();toast(isNew?"Quote created":"Quote updated","success");c()}}>{isNew?"Create Quote":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteQuote(item.id);await reload();toast("Quote deleted","info");c()}}>Delete</B>}</div></div>}
function InvF({c,item,toast,reload}){const isNew=!item;const[li,setLi]=useState([]);useEffect(()=>{if(item)db.getLineItems("invoice",item.id).then(setLi)},[item]);const[f,sF]=useState({cl:item?.cl||"",st:item?.st||"Draft",dt:item?.dt||"",due:item?.due||"",en:item?.en||"",inn:item?.inn||""});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-5"><div className="flex items-center gap-2 text-sm text-stone-600"><Hash size={14}/><span className="font-mono font-medium">{item?.id||"Auto"}</span></div></div><FF l="Client"><S value={f.cl} onChange={e=>u("cl",e.target.value)} ph="— Select —" options={CL.map(c=>c.n)}/></FF>{isNew&&<FF l="From Quote"><S ph="— Scratch —" options={QT.map(q=>q.id)}/></FF>}{!isNew&&<FF l="Status"><S value={f.st} onChange={e=>u("st",e.target.value)} options={["Draft","Sent","Paid","Overdue"]}/></FF>}{!isNew&&item?.st==="Paid"&&<div className="p-4 bg-emerald-50 rounded-lg border border-emerald-200 mb-5"><div className="flex items-center gap-2 mb-2"><CheckCircle size={14} className="text-emerald-600"/><span className="text-sm font-semibold text-emerald-800">Payment Received</span></div><div className="grid grid-cols-3 gap-4 text-sm"><div><p className="text-xs text-emerald-600">Date</p><p className="text-emerald-800">{item.payDt||"—"}</p></div><div><p className="text-xs text-emerald-600">Method</p><p className="text-emerald-800">{item.payMethod||"—"}</p></div><div><p className="text-xs text-emerald-600">Reference</p><p className="text-emerald-800">{item.payRef||"—"}</p></div></div></div>}<div className="my-5"><div className="flex items-center justify-between mb-3"><h3 className="text-sm font-semibold text-stone-700 fs">Line Items</h3><B vr="ghost" sz="sm" icon={Plus}>Add</B></div>{(isNew?[{description:"",type:"Labour",quantity:1,unitPrice:"",total:0}]:li).map((l,i)=><div key={i} className="p-3 bg-stone-50 rounded-lg border border-stone-200 mb-2"><I defaultValue={l.description||""} placeholder="Description"/><div className="grid grid-cols-4 gap-2 mt-2"><div><label className="text-xs text-stone-500">Type</label><S defaultValue={l.type||"Labour"} options={["Labour","Materials","Flat Fee"]}/></div><div><label className="text-xs text-stone-500">Qty</label><I type="number" defaultValue={l.quantity||1}/></div><div><label className="text-xs text-stone-500">Rate</label><I type="number" defaultValue={l.unitPrice||""}/></div><div><label className="text-xs text-stone-500">Total</label><div className="px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm font-medium fm">{$(l.total||0)}</div></div></div></div>)}</div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-5"><div className="flex justify-between text-sm mb-1"><span className="text-stone-500">Subtotal</span><span className="font-medium fm">{$((item?.am||0)-(item?.gst||0))}</span></div><div className="flex justify-between text-sm mb-1"><span className="text-stone-500">GST</span><span className="font-medium fm">{$(item?.gst||0)}</span></div><div className="flex justify-between text-sm font-semibold border-t border-stone-300 pt-2 mt-2"><span>Total</span><span className="fm">{$(item?.am||0)}</span></div></div><div className="grid grid-cols-2 gap-4"><FF l="Date"><I type="date" value={f.dt} onChange={e=>u("dt",e.target.value)}/></FF><FF l="Due"><I type="date" value={f.due} onChange={e=>u("due",e.target.value)}/></FF></div><NF/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?FileText:CheckCircle} onClick={async()=>{if(isNew){const id=await db.nextInvoiceId();if(id)await db.createInvoice({...f,id})}else await db.updateInvoice(item.id,f);await reload();toast(isNew?"Invoice created":"Invoice updated","success");c()}}>{isNew?"Create Invoice":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteInvoice(item.id);await reload();toast("Invoice deleted","info");c()}}>Delete</B>}</div></div>}
function ExpF({c,item,toast,reload}){const isNew=!item;const[f,sF]=useState({dt:item?.dt||new Date().toISOString().slice(0,10),d:item?.d||"",am:item?.am||"",gst:item?.gst||"",cat:item?.cat||"",job:item?.job||"",sup:item?.sup||"",ap:!!item?.ap,full:item?.full||"",bp:item?.bp||"",rcUrl:item?.rcUrl||"",paid:!!item?.paid,payDt:item?.payDt||"",invNo:item?.invNo||"",due:item?.due||""});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><FF l="Date"><I type="date" value={f.dt} onChange={e=>u("dt",e.target.value)}/></FF><FF l="Description"><I value={f.d} onChange={e=>u("d",e.target.value)} placeholder="e.g. Steel from Metalcraft"/></FF><div className="grid grid-cols-2 gap-4"><FF l="Amount (incl GST)"><I type="number" value={f.am} onChange={e=>u("am",e.target.value)} placeholder="0.00"/></FF><FF l="GST Content"><I type="number" value={f.gst} onChange={e=>u("gst",e.target.value)} placeholder="0.00"/></FF></div><FF l="Category"><S value={f.cat} onChange={e=>u("cat",e.target.value)} options={ECATEGORIES}/></FF><FF l="Supplier"><S value={f.sup} onChange={e=>u("sup",e.target.value)} ph="— None —" options={CT.filter(c=>c.ty==="Supplier").map(c=>c.n)}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Invoice #"><I value={f.invNo} onChange={e=>u("invNo",e.target.value)} placeholder="Supplier inv #"/></FF><FF l="Due Date"><I type="date" value={f.due} onChange={e=>u("due",e.target.value)}/></FF></div><FF l="Linked Job"><S value={f.job} onChange={e=>u("job",e.target.value)} ph="— None —" options={JOBS.map(j=>j.t)}/></FF><div className="my-5 p-4 bg-stone-50 rounded-lg border border-stone-200"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={f.paid} onChange={e=>{u("paid",e.target.checked);if(e.target.checked&&!f.payDt)u("payDt",f.dt||new Date().toISOString().slice(0,10))}} className="rounded border-stone-300 text-emerald-600"/><span className="text-sm font-medium text-stone-700">Paid</span></label>{f.paid&&<div className="mt-4"><FF l="Payment Date"><I type="date" value={f.payDt} onChange={e=>u("payDt",e.target.value)}/></FF></div>}</div><div className="my-5 p-4 bg-stone-50 rounded-lg border border-stone-200"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={f.ap} onChange={e=>u("ap",e.target.checked)} className="rounded border-stone-300 text-amber-600"/><span className="text-sm font-medium text-stone-700">Apportioned</span></label>{f.ap&&<div className="grid grid-cols-2 gap-4 mt-4"><FF l="Full Amount"><I type="number" value={f.full} onChange={e=>u("full",e.target.value)}/></FF><FF l="Biz %"><I type="number" value={f.bp} onChange={e=>u("bp",e.target.value)} placeholder="25"/></FF></div>}</div><FF l="Receipt"><ImgUp value={f.rcUrl} onChange={v=>u("rcUrl",v)} accept="image/*,.pdf"/></FF><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?Plus:CheckCircle} onClick={async()=>{if(isNew)await db.createExpense(f);else await db.updateExpense(item.id,f);await reload();toast(isNew?"Expense logged":"Expense updated","success");c()}}>{isNew?"Log Expense":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteExpense(item.id);await reload();toast("Expense deleted","info");c()}}>Delete</B>}</div></div>}
function ContactF({c,item,toast,reload}){const isNew=!item;const[f,sF]=useState({n:item?.n||"",co:item?.co||"",ty:item?.ty||"",e:item?.e||"",p:item?.p||"",tg:(item?.tg||[]).join(", "),nt:item?.nt||""});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><FF l="Name"><I value={f.n} onChange={e=>u("n",e.target.value)} placeholder="Dave Murray"/></FF><FF l="Company"><I value={f.co} onChange={e=>u("co",e.target.value)} placeholder="Metalcraft"/></FF><FF l="Type"><S value={f.ty} onChange={e=>u("ty",e.target.value)} options={CTYPES} ph="— Select —"/></FF><div className="grid grid-cols-2 gap-4"><FF l="Email"><I type="email" value={f.e} onChange={e=>u("e",e.target.value)}/></FF><FF l="Phone"><I value={f.p} onChange={e=>u("p",e.target.value)}/></FF></div><FF l="Tags" h="Comma-separated"><I value={f.tg} onChange={e=>u("tg",e.target.value)}/></FF><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?Plus:CheckCircle} onClick={async()=>{if(isNew)await db.createContact(f);else await db.updateContact(item.id,f);await reload();toast(isNew?"Contact added":"Contact updated","success");c()}}>{isNew?"Add Contact":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteContact(item.id);await reload();toast("Contact deleted","info");c()}}>Delete</B>}</div></div>}
function ClientF({c,item,toast,reload}){const isNew=!item;const[f,sF]=useState({n:item?.n||"",e:item?.e||"",p:item?.p||"",a:item?.a||""});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><FF l="Name"><I value={f.n} onChange={e=>u("n",e.target.value)}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Email"><I type="email" value={f.e} onChange={e=>u("e",e.target.value)}/></FF><FF l="Phone"><I value={f.p} onChange={e=>u("p",e.target.value)}/></FF></div><FF l="Address"><I value={f.a} onChange={e=>u("a",e.target.value)}/></FF>{!isNew&&<div className="grid grid-cols-2 gap-4 mt-2"><div className="p-3 bg-stone-50 rounded-lg border border-stone-200"><p className="text-xs text-stone-500">Jobs</p><p className="text-lg font-semibold fm">{item.j}</p></div><div className="p-3 bg-stone-50 rounded-lg border border-stone-200"><p className="text-xs text-stone-500">Revenue</p><p className="text-lg font-semibold fm">{$(item.r)}</p></div></div>}<NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?Plus:CheckCircle} onClick={async()=>{if(isNew)await db.createClient(f);else await db.updateClient(item.id,f);await reload();toast(isNew?"Client added":"Client updated","success");c()}}>{isNew?"Add Client":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteClient(item.id);await reload();toast("Client deleted","info");c()}}>Delete</B>}</div></div>}
function MarkPaidF({c,toast,item,reload}){const[f,sF]=useState({payDt:new Date().toISOString().slice(0,10),am:item?.am||0,payMethod:"Bank Transfer",payRef:""});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-5"><p className="text-sm font-medium text-stone-700">{item?.id||"—"} — {item?.cl||"Client"}</p><p className="text-xl font-semibold fm mt-1">{$(item?.am||0)}</p></div><FF l="Payment Date"><I type="date" value={f.payDt} onChange={e=>u("payDt",e.target.value)}/></FF><FF l="Amount"><I type="number" value={f.am} onChange={e=>u("am",e.target.value)}/></FF><FF l="Method"><S value={f.payMethod} onChange={e=>u("payMethod",e.target.value)} options={["Bank Transfer","Cash","Cheque","Stripe","Other"]}/></FF><FF l="Reference"><I value={f.payRef} onChange={e=>u("payRef",e.target.value)} placeholder="Bank ref"/></FF><NF noExt/><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B vr="success" icon={CheckCircle} onClick={async()=>{await db.updateInvoice(item?.id,{st:"Paid",payDt:f.payDt,payMethod:f.payMethod,payRef:f.payRef});await reload();toast("Marked as paid","success");c()}}>Confirm</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function IncSrcF({c,toast,reload}){const[d,sD]=useState({app:"",platform:"Buy Me A Coffee",mrr:0,subs:1});const save=async()=>{if(!d.app||!d.mrr){toast("Please fill required fields","error");return}await db.createSubscriptionSource({appName:d.app,platform:d.platform,subscribers:d.subs,mrr:parseFloat(d.mrr),grossJan:parseFloat(d.mrr),feesJan:0,netJan:parseFloat(d.mrr),gstJan:0,metadata:{trend:[],subscriberTrend:[],monthLabels:[]}});toast("Source added","success");await reload();c()};return<div><FF l="App Name"><I value={d.app} onChange={e=>sD({...d,app:e.target.value})} placeholder="Buy Me A Coffee Donations"/></FF><FF l="Platform"><S value={d.platform} onChange={e=>sD({...d,platform:e.target.value})} options={["Stripe","Buy Me A Coffee","Paddle","Other"]}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Monthly Revenue"><I type="number" value={d.mrr} onChange={e=>sD({...d,mrr:e.target.value})} placeholder="0.00" step="0.01"/></FF><FF l="Supporters"><I type="number" value={d.subs} onChange={e=>sD({...d,subs:e.target.value})} placeholder="1"/></FF></div><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={save}>Add</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function MPF({c,item,toast,reload}){const isNew=!item?.id;const[f,sF]=useState({sid:item?.sid||"",dt:item?.dt||new Date().toISOString().slice(0,10),g:item?.g||"",fe:item?.fe||"",payer:item?.payer||"",n:item?.n||""});const u=(k,v)=>sF(p=>({...p,[k]:v}));const net=parseFloat(f.g||0)-parseFloat(f.fe||0);const save=async()=>{if(!f.sid){toast("Select a source","error");return}if(!f.g){toast("Enter gross amount","error");return}const d={...f,g:parseFloat(f.g),fe:parseFloat(f.fe||0)};if(isNew)await db.createManualPayment(d);else await db.updateManualPayment(item.id,d);await reload();toast(isNew?"Payment logged":"Payment updated","success");c()};return<div><FF l="Income Source"><select value={f.sid} onChange={e=>u("sid",e.target.value)} className="w-full px-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 focus:outline-none focus:ring-2 focus:ring-amber-500/40 focus:border-amber-500 bg-white"><option value="">— Select Source —</option>{SUBS.filter(s=>s.platform!=='Stripe').map(s=><option key={s.id} value={s.id}>{s.app}</option>)}</select></FF><FF l="Date"><I type="date" value={f.dt} onChange={e=>u("dt",e.target.value)}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Gross Amount"><I type="number" value={f.g} onChange={e=>u("g",e.target.value)} placeholder="0.00" step="0.01"/></FF><FF l="Platform Fee"><I type="number" value={f.fe} onChange={e=>u("fe",e.target.value)} placeholder="0.00" step="0.01"/></FF></div><div className="p-3 bg-emerald-50 rounded-lg border border-emerald-200 mb-5"><div className="flex justify-between text-sm"><span className="text-emerald-700">Net Amount</span><span className="font-semibold text-emerald-800 fm">{$(net)}</span></div></div><FF l="Payer / Supporter"><I value={f.payer} onChange={e=>u("payer",e.target.value)} placeholder="e.g. John Smith"/></FF><FF l="Notes"><T value={f.n||""} onChange={e=>u("n",e.target.value)} placeholder="e.g. Monthly BMC donation"/></FF><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?Plus:CheckCircle} onClick={save}>{isNew?"Log Payment":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteManualPayment(item.id);await reload();toast("Payment deleted","info");c()}}>Delete</B>}</div></div>}
function TripF({c,toast,reload}){const[f,sF]=useState({dt:new Date().toISOString().slice(0,10),fr:"",to:"",km:"",p:"",cat:"Client visit"});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><FF l="Date"><I type="date" value={f.dt} onChange={e=>u("dt",e.target.value)}/></FF><div className="grid grid-cols-2 gap-4"><FF l="From"><I value={f.fr} onChange={e=>u("fr",e.target.value)} placeholder="Home"/></FF><FF l="To"><I value={f.to} onChange={e=>u("to",e.target.value)} placeholder="Metalcraft"/></FF></div><FF l="Km"><I type="number" value={f.km} onChange={e=>u("km",e.target.value)}/></FF><FF l="Purpose"><I value={f.p} onChange={e=>u("p",e.target.value)} placeholder="Steel pickup"/></FF><FF l="Category"><S value={f.cat} onChange={e=>u("cat",e.target.value)} options={["Client visit","Supplier run","Site visit","Other"]}/></FF><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={async()=>{if(!f.km){toast("Enter km","error");return}await db.createTrip(f);await reload();toast("Trip logged","success");c()}}>Log Trip</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function HomeExpF({c,toast,reload}){const pc=DEDS.homeOffice?.percent||10;const[f,sF]=useState({m:new Date().toISOString().slice(0,7),ty:"Internet",f:""});const u=(k,v)=>sF(p=>({...p,[k]:v}));return<div><FF l="Month"><I type="month" value={f.m} onChange={e=>u("m",e.target.value)}/></FF><FF l="Type"><S value={f.ty} onChange={e=>u("ty",e.target.value)} options={["Internet","Power","Insurance","Rates","Rent/Mortgage","Repairs","Other"]}/></FF><FF l="Full Amount"><I type="number" value={f.f} onChange={e=>u("f",e.target.value)}/></FF><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 my-4"><div className="flex justify-between text-sm"><span className="text-stone-600">Business %</span><span className="font-medium">{pc}%</span></div>{f.f&&<div className="flex justify-between text-sm mt-2"><span className="text-stone-600">Deductible</span><span className="font-medium text-emerald-700 fm">{$(parseFloat(f.f||0)*pc/100)}</span></div>}<p className="text-xs text-stone-400 mt-1">From Settings</p></div><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={Plus} onClick={async()=>{if(!f.f){toast("Enter amount","error");return}await db.createHomeOfficeExpense({m:f.m,ty:f.ty,f:parseFloat(f.f),pc});await reload();toast("Logged","success");c()}}>Log</B><B vr="ghost" onClick={c}>Cancel</B></div></div>}
function BudgetF({c,item,toast,reload}){const isNew=!item;const now=new Date(),cm=now.getMonth(),cy=now.getFullYear(),dty=cm>=3?cy:cy-1;const[f,sF]=useState({taxYear:item?.taxYear||dty,category:item?.category||"",type:item?.type||"expense",annualAmount:item?.annualAmount||"",monthlyAmounts:item?.monthlyAmounts||{},notes:item?.notes||"",useMonthly:item?.monthlyAmounts&&Object.keys(item.monthlyAmounts).length>0});const u=(k,v)=>sF(p=>({...p,[k]:v}));const MO=["Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar"];const cats=f.type==="income"?ICATEGORIES:ECATEGORIES;return<div><div className="grid grid-cols-2 gap-4"><FF l="Tax Year"><S value={String(f.taxYear)} onChange={e=>u("taxYear",parseInt(e.target.value))} options={[dty-1,dty,dty+1].map(String)}/></FF><FF l="Type"><S value={f.type} onChange={e=>{u("type",e.target.value);u("category","")}} options={["income","expense"]}/></FF></div><FF l="Category"><S value={f.category} onChange={e=>u("category",e.target.value)} ph="— Select —" options={cats}/></FF><FF l="Annual Amount"><I type="number" value={f.annualAmount} onChange={e=>u("annualAmount",e.target.value)} placeholder="0.00"/></FF><div className="my-4"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={f.useMonthly} onChange={e=>u("useMonthly",e.target.checked)} className="rounded border-stone-300 text-amber-600"/><span className="text-sm text-stone-700">Custom monthly breakdown</span></label>{f.useMonthly&&<div className="grid grid-cols-3 gap-2 mt-3">{MO.map(m=><div key={m}><label className="text-xs text-stone-500">{m}</label><I type="number" value={f.monthlyAmounts[m]||""} onChange={e=>{const ma={...f.monthlyAmounts,[m]:parseFloat(e.target.value)||0};u("monthlyAmounts",ma);const total=MO.reduce((s,k)=>s+(ma[k]||0),0);u("annualAmount",total)}} placeholder="0"/></div>)}</div>}</div><FF l="Notes" h="Budget assumptions"><T value={f.notes||""} onChange={e=>u("notes",e.target.value)}/></FF><div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?Plus:CheckCircle} onClick={async()=>{if(isNew)await db.createBudgetItem({...f,monthlyAmounts:f.useMonthly?f.monthlyAmounts:{}});else await db.updateBudgetItem(item.id,{...f,monthlyAmounts:f.useMonthly?f.monthlyAmounts:{}});await reload();toast(isNew?"Budget item created":"Updated","success");c()}}>{isNew?"Create":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteBudgetItem(item.id);await reload();toast("Deleted","info");c()}}>Delete</B>}</div></div>}

/* === SUB-VIEWS === */
function VehicleV({onBack,o}){const tk=TRIPS.reduce((s,t)=>s+t.km,0);const vd=DEDS.vehicle||{};const r1=vd.tier1||1.17,r2=vd.tier2||0.37;const t1km=Math.min(tk,14000),t2km=Math.max(tk-14000,0);const ded=t1km*r1+t2km*r2;return<div><Bk onClick={onBack} label="Back to Expenses"/><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Vehicle Log</h1><B sz="sm" icon={Plus} onClick={()=>o("trip")}>Log Trip</B></div><div className="grid grid-cols-4 gap-4 mb-6"><Stat l="Total Km" v={`${tk} km`} icon={Route} ch={`${TRIPS.length} trips`}/><Stat l="Method" v={vd.method||"Km Rate"} icon={Calculator} sub={`${vd.type||"Petrol"} $${r1}/$${r2}`}/><Stat l="Deduction (YTD)" v={$(ded)} icon={DollarSign} up ch={t2km>0?"Tier 1+2":"Tier 1"}/><Stat l="Business Use" v={`${DEDS.homeOffice?.percent||10}%`} icon={Percent}/></div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Route</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Km</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Purpose</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Deduction</th></tr></thead><tbody>{TRIPS.map(t=><tr key={t.id} className="border-b border-stone-100 hover:bg-stone-50"><td className="px-5 py-3 text-sm text-stone-500">{t.dt}</td><td className="px-5 py-3 text-sm text-stone-800">{t.fr} → {t.to}</td><td className="px-5 py-3 text-right text-sm font-medium fm">{t.km}</td><td className="px-5 py-3 text-sm text-stone-600">{t.p}</td><td className="px-5 py-3 text-right text-sm font-medium text-emerald-700 fm">{$(t.km*r1)}</td></tr>)}</tbody></table></div><div className="mt-6 p-4 bg-stone-50 rounded-lg border border-stone-200"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-3">Annual Summary</h4><div className="grid grid-cols-3 gap-4"><div><p className="text-xs text-stone-500">Tier 1 (≤14,000km)</p><p className="text-sm font-medium fm">{t1km}km × ${r1} = {$(t1km*r1)}</p></div><div><p className="text-xs text-stone-500">Tier 2 (&gt;14,000km)</p><p className="text-sm font-medium fm">{t2km}km{t2km>0&&` × $${r2} = ${$(t2km*r2)}`}</p></div><div><p className="text-xs text-stone-500">Total Deduction</p><p className="text-lg font-semibold text-emerald-700 fm">{$(ded)}</p></div></div></div></div>}

function HomeV({onBack,o}){const td=HOEX.reduce((s,e)=>s+e.d,0);return<div><Bk onClick={onBack} label="Back to Expenses"/><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Home Office</h1><B sz="sm" icon={Plus} onClick={()=>o("homeExp")}>Log Expense</B></div><div className="grid grid-cols-4 gap-4 mb-6"><Stat l="Office" v={`${DEDS.homeOffice?.officeSqm||0} m²`} icon={Home} sub={`of ${DEDS.homeOffice?.totalSqm||0} m²`}/><Stat l="Business %" v={`${DEDS.homeOffice?.percent||0}%`} icon={Percent}/><Stat l="Full Costs (YTD)" v={$(HOEX.reduce((s,e)=>s+e.f,0))} icon={Receipt}/><Stat l="Deductible (YTD)" v={$(td)} icon={DollarSign} up/></div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Month</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Type</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Full</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">%</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Deductible</th></tr></thead><tbody>{HOEX.map(e=><tr key={e.id} className="border-b border-stone-100 hover:bg-stone-50"><td className="px-5 py-3 text-sm text-stone-500">{e.m}</td><td className="px-5 py-3 text-sm text-stone-800">{e.ty}</td><td className="px-5 py-3 text-right text-sm fm">{$(e.f)}</td><td className="px-5 py-3 text-right text-sm text-stone-500">{e.pc}%</td><td className="px-5 py-3 text-right text-sm font-medium text-emerald-700 fm">{$(e.d)}</td></tr>)}</tbody></table></div></div>}

function RecurV({onBack,toast,reload}){return<div><Bk onClick={onBack} label="Back to Invoices"/><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Recurring Invoices</h1><B sz="sm" icon={Plus}>New Template</B></div><div className="space-y-4">{RECTPL.map(t=><div key={t.id} className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><div className="flex items-start justify-between mb-4"><div><h3 className="text-sm font-semibold text-stone-800">{t.cl}</h3><p className="text-xs text-stone-500">{t.d}</p></div><Badge s={t.st}/></div><div className="grid grid-cols-4 gap-4 mb-4"><div><p className="text-xs text-stone-500">Amount</p><p className="text-sm font-semibold fm">{$(t.am)}</p></div><div><p className="text-xs text-stone-500">Frequency</p><p className="text-sm font-medium">{t.freq}</p></div><div><p className="text-xs text-stone-500">Next</p><p className="text-sm font-medium">{t.next||"—"}</p></div><div><p className="text-xs text-stone-500">Generated</p><p className="text-sm font-medium">{t.gen}</p></div></div><div className="flex gap-2">{t.st==="Active"&&<B vr="secondary" sz="sm" icon={Ban} onClick={async()=>{await db.updateRecurringTemplate(t.id,{st:"Paused"});await reload();toast("Paused","info")}}>Pause</B>}{t.st==="Paused"&&<B vr="secondary" sz="sm" icon={RefreshCw} onClick={async()=>{await db.updateRecurringTemplate(t.id,{st:"Active"});await reload();toast("Resumed","success")}}>Resume</B>}<B vr="danger" sz="sm" icon={Trash2} onClick={async()=>{await db.deleteRecurringTemplate(t.id);await reload();toast("Deleted","info")}}>Delete</B></div></div>)}</div></div>}

function StripeV({onBack,toast}){const[s,setS]=useState(1);return<div><Bk onClick={onBack} label="Back"/><h1 className="text-2xl font-bold text-stone-900 fs mb-6">Import Stripe</h1><div className="flex gap-2 mb-6">{[1,2,3].map(n=><div key={n} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium ${s>=n?"bg-stone-900 text-white":"bg-stone-100 text-stone-500"}`}>{["Upload","Preview","Confirm"][n-1]}</div>)}</div>
  {s===1&&<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-8 text-center"><div className="border-2 border-dashed border-stone-300 rounded-lg p-12 hover:border-amber-400 cursor-pointer" onClick={()=>setS(2)}><FileSpreadsheet size={32}className="mx-auto text-stone-400 mb-3"/><p className="text-sm font-medium text-stone-700">Drop Stripe CSV here</p><p className="text-xs text-stone-400 mt-1">Balance transactions / Payouts</p></div></div>}
  {s===2&&<div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden mb-4"><div className="px-5 py-3 bg-stone-50 border-b border-stone-200"><span className="text-sm font-semibold text-stone-700">{STRP.length} rows detected</span></div><table className="w-full"><thead><tr className="border-b border-stone-200"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Type</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Desc</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-2">Gross</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-2">Fee</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-2">Net</th></tr></thead><tbody>{STRP.map(r=><tr key={r.id} className="border-b border-stone-100"><td className="px-5 py-2.5 text-xs text-stone-500">{r.dt}</td><td className="px-5 py-2.5"><span className={`text-xs px-2 py-0.5 rounded-full ${r.ty==="charge"?"bg-emerald-50 text-emerald-700":"bg-blue-50 text-blue-700"}`}>{r.ty}</span></td><td className="px-5 py-2.5 text-xs text-stone-600">{r.d}</td><td className="px-5 py-2.5 text-right text-xs fm">{r.g?$(r.g):"—"}</td><td className="px-5 py-2.5 text-right text-xs text-red-600 fm">{r.fe?`-${$(r.fe)}`:"—"}</td><td className="px-5 py-2.5 text-right text-xs font-medium fm">{$(r.ne)}</td></tr>)}</tbody></table></div><div className="flex gap-3"><B onClick={()=>setS(3)}>Continue</B><B vr="ghost" onClick={()=>setS(1)}>Back</B></div></div>}
  {s===3&&<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6 text-center"><CheckCircle size={48}className="mx-auto text-emerald-500 mb-4"/><h3 className="text-lg font-semibold text-stone-900 mb-2">Ready to Import</h3><p className="text-sm text-stone-600 mb-6">{STRP.filter(r=>r.ty==="charge").length} charges + {STRP.filter(r=>r.ty!=="charge").length} payouts</p><div className="flex gap-3 justify-center"><B vr="success" icon={CheckCircle} onClick={()=>{toast("Imported","success");onBack()}}>Import</B><B vr="ghost" onClick={()=>setS(2)}>Back</B></div></div>}
</div>}

function parseCSVLine(line){const r=[];let c='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){q=!q}else if(ch===','&&!q){r.push(c.trim());c=''}else{c+=ch}}r.push(c.trim());return r}
function parseDDMMYYYY(s){if(!s)return null;const p=s.split('/');if(p.length!==3)return null;return`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`}
function detectBank(text){const h=text.split('\n')[0].toLowerCase();if(h.includes('unique id')||/^\d{4}\//.test(text.split('\n')[1]||''))return'ASB';if(h.includes('other party'))return'Westpac';if(h.startsWith('type,details'))return'ANZ';if(h.includes('this party account'))return'BNZ';return''}
function parseBankCSV(text,bank){const lines=text.trim().split('\n');const rows=[];for(let i=1;i<lines.length;i++){const c=parseCSVLine(lines[i]);if(c.length<3)continue;let date,desc,amount;if(bank==='ASB'){date=c[0]?.replace(/\//g,'-');desc=[c[4],c[5]].filter(Boolean).join(' - ');amount=parseFloat(c[6])}else if(bank==='Westpac'){date=parseDDMMYYYY(c[0]);desc=[c[2],c[3]].filter(Boolean).join(' - ');amount=parseFloat(c[1])}else if(bank==='ANZ'){date=parseDDMMYYYY(c[6]);desc=[c[1],c[2]].filter(Boolean).join(' - ');amount=parseFloat(c[5])}else if(bank==='BNZ'){date=parseDDMMYYYY(c[0]);desc=[c[2],c[3]].filter(Boolean).join(' - ');amount=parseFloat(c[1])}else{date=c[0];desc=c[1]||'';amount=parseFloat(c[2]||c[1])}if(date&&!isNaN(amount))rows.push({date,description:desc||'',amount})}return rows}
function BankRecPg({o,toast,reload}){const[tab,sTab]=useState("Unreconciled");const[parsed,sParsed]=useState(null);const[bankName,sBN]=useState("");const[sel,sSel]=useState(null);const[q,sQ]=useState("");const[drag,sDrag]=useState(false);const fileRef=useRef(null);const unrec=BANK.filter(b=>!b.rec);const recd=BANK.filter(b=>b.rec);const handleFile=file=>{const reader=new FileReader();reader.onload=e=>{const text=e.target.result;const det=detectBank(text);sBN(det);sParsed(parseBankCSV(text,det));sTab("Import")};reader.readAsText(file)};const doImport=async()=>{if(!parsed?.length)return;const batch=crypto.randomUUID();const rows=parsed.map(r=>({...r,bank:bankName,batch}));await db.createBankTransactions(rows);await reload();sParsed(null);sTab("Unreconciled");toast(`Imported ${rows.length} transactions`,"success")};const doMatch=async(bk,candidate)=>{await db.createBankMatch({bankTxnId:bk.id,type:candidate.type,targetId:candidate.id,amount:candidate.amount});if(candidate.type==='invoice'){await db.updateInvoice(candidate.id,{st:'Paid',payDt:bk.dt,payMethod:'Bank Transfer',payRef:bk.d})}await reload();sSel(null);toast("Matched","success")};const doUnmatch=async(bk)=>{for(const m of bk.matches){await db.deleteBankMatch(m.id,bk.id)}await reload();toast("Unmatched","info")};const matchLabel=(m)=>{if(m.ty==='invoice')return INV.find(i=>i.id===m.invId)?.id||m.invId;if(m.ty==='expense'){const e=EXP.find(x=>x.id===m.expId);return e?.d||`Expense #${m.expId}`}return'—'};
return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Bank</h1><div className="flex items-center gap-3"><div className="flex gap-2 text-xs"><span className="px-2 py-1 bg-amber-50 text-amber-700 rounded-full font-medium">{unrec.length} unreconciled</span><span className="px-2 py-1 bg-emerald-50 text-emerald-700 rounded-full font-medium">{recd.length} reconciled</span></div><B sz="sm" icon={Upload} onClick={()=>fileRef.current?.click()}>Import CSV</B><input ref={fileRef} type="file" accept=".csv" className="hidden" onChange={e=>{const f=e.target.files?.[0];if(f)handleFile(f);e.target.value=""}}/></div></div>
<Tabs items={["Unreconciled","Reconciled","Import"]} active={tab} onChange={sTab}/>
{tab==="Unreconciled"&&<div>{unrec.length?<><SearchBar value={q} onChange={sQ} placeholder="Search transactions..."/><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Description</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Amount</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Suggested Match</th><th className="text-center text-xs font-medium text-stone-500 uppercase px-5 py-3">Actions</th></tr></thead><tbody>{unrec.filter(r=>!q||(r.d||'').toLowerCase().includes(q.toLowerCase())).map(r=>{const sugs=db.suggestMatches(r,INV,EXP);const best=sugs[0];return<Fragment key={r.id}><tr className={`border-b border-stone-100 hover:bg-stone-50 ${sel===r.id?"bg-amber-50/30":""}`}><td className="px-5 py-3 text-sm text-stone-500">{r.dt}</td><td className="px-5 py-3 text-sm text-stone-800">{r.d}</td><td className={`px-5 py-3 text-right text-sm font-medium fm ${r.am>0?"text-emerald-700":"text-stone-700"}`}>{r.am>0?"+":""}{$(Math.abs(r.am))}</td><td className="px-5 py-3">{best?<span className={`text-xs ${best.score>=70?"text-emerald-700":"text-amber-600"}`}>{best.label} ({$(best.amount)})</span>:<span className="text-xs text-stone-400">No match</span>}</td><td className="px-5 py-3 text-center"><div className="flex items-center justify-center gap-1">{best&&<B vr="success" sz="sm" onClick={()=>doMatch(r,best)}>Match</B>}<B vr="ghost" sz="sm" onClick={()=>sSel(sel===r.id?null:r.id)}>...</B>{r.am<0&&<B vr="ghost" sz="sm" onClick={()=>o("bankExp",{dt:r.dt,am:Math.abs(r.am).toFixed(2),d:r.d,gst:(Math.abs(r.am)*3/23).toFixed(2)})}>Expense</B>}</div></td></tr>{sel===r.id&&<tr><td colSpan={5} className="px-5 py-4 bg-stone-50 border-b border-stone-200"><div className="max-w-xl"><p className="text-xs font-semibold text-stone-600 uppercase mb-2">Match candidates</p>{sugs.length?<div className="space-y-2">{sugs.map((s,si)=><div key={si} className="flex items-center justify-between p-2.5 bg-white rounded-lg border border-stone-200"><div><span className={`text-xs px-1.5 py-0.5 rounded ${s.type==='invoice'?'bg-blue-50 text-blue-700':'bg-orange-50 text-orange-700'}`}>{s.type}</span><span className="text-sm text-stone-800 ml-2">{s.label}</span><span className="text-xs text-stone-400 ml-2">({$(s.amount)})</span><span className="text-xs text-stone-400 ml-2">score: {s.score}</span></div><B vr="success" sz="sm" onClick={()=>doMatch(r,s)}>Match</B></div>)}</div>:<p className="text-xs text-stone-400">No candidates found</p>}</div></td></tr>}</Fragment>})}</tbody></table></div></>:<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-12 text-center"><FileSpreadsheet size={40} className="mx-auto text-stone-300 mb-3"/><p className="text-sm text-stone-500">No unreconciled transactions</p><p className="text-xs text-stone-400 mt-1">Import a bank CSV to get started</p></div>}</div>}
{tab==="Reconciled"&&<div>{recd.length?<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Description</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Amount</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Matched To</th><th className="text-center text-xs font-medium text-stone-500 uppercase px-5 py-3">Action</th></tr></thead><tbody>{recd.map(r=><tr key={r.id} className="border-b border-stone-100"><td className="px-5 py-3 text-sm text-stone-500">{r.dt}</td><td className="px-5 py-3 text-sm text-stone-800">{r.d}</td><td className={`px-5 py-3 text-right text-sm font-medium fm ${r.am>0?"text-emerald-700":"text-stone-700"}`}>{r.am>0?"+":""}{$(Math.abs(r.am))}</td><td className="px-5 py-3"><div className="flex flex-wrap gap-1">{r.matches.map(m=><span key={m.id} className="inline-flex items-center gap-1 text-xs text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded-full"><Link2 size={10}/>{matchLabel(m)}</span>)}</div></td><td className="px-5 py-3 text-center"><button onClick={()=>doUnmatch(r)} className="text-stone-400 hover:text-red-500" title="Unmatch"><Unlink size={14}/></button></td></tr>)}</tbody></table></div>:<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-12 text-center"><p className="text-sm text-stone-500">No reconciled transactions yet</p></div>}</div>}
{tab==="Import"&&<div>{parsed?<div><div className="flex items-center justify-between mb-4"><div className="flex items-center gap-3"><span className="text-sm font-semibold text-stone-700">{parsed.length} rows parsed</span>{bankName&&<span className="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full">{bankName}</span>}</div><FF l=""><S value={bankName} onChange={e=>{sBN(e.target.value)}} ph="Auto-detect" options={["ASB","Westpac","ANZ","BNZ"]}/></FF></div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden mb-4" style={{maxHeight:400,overflowY:'auto'}}><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50 sticky top-0"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-2">Description</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-2">Amount</th></tr></thead><tbody>{parsed.map((r,i)=><tr key={i} className="border-b border-stone-100"><td className="px-5 py-2.5 text-xs text-stone-500">{r.date}</td><td className="px-5 py-2.5 text-xs text-stone-800">{r.description}</td><td className={`px-5 py-2.5 text-right text-xs font-medium fm ${r.amount>0?"text-emerald-700":"text-stone-700"}`}>{r.amount>0?"+":""}{$(Math.abs(r.amount))}</td></tr>)}</tbody></table></div><div className="flex gap-3"><B vr="success" icon={CheckCircle} onClick={doImport}>Import {parsed.length} rows</B><B vr="ghost" onClick={()=>sParsed(null)}>Cancel</B></div></div>:<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-8 text-center"><div className={`border-2 border-dashed rounded-lg p-12 cursor-pointer transition-colors ${drag?"border-amber-400 bg-amber-50/50":"border-stone-300 hover:border-amber-400"}`} onClick={()=>fileRef.current?.click()} onDragOver={e=>{e.preventDefault();sDrag(true)}} onDragLeave={()=>sDrag(false)} onDrop={e=>{e.preventDefault();sDrag(false);const f=e.dataTransfer.files?.[0];if(f&&f.name.endsWith('.csv'))handleFile(f)}}><FileSpreadsheet size={32}className="mx-auto text-stone-400 mb-3"/><p className="text-sm font-medium text-stone-700">Drop bank CSV here</p><p className="text-xs text-stone-400 mt-1">ASB, Westpac, ANZ, BNZ</p></div></div>}</div>}
</div>}

/* === PDF DOWNLOADS (fetch line items from DB) === */
async function dlQuote(q){const cl=CL.find(c=>c.n===q.cl);const li=await db.getLineItems("quote",q.id);generateQuotePdf({id:q.id,version:q.v||1,status:q.st,date:q.dt,expiryDate:q.exp||null,client:{name:cl?.n||q.cl,email:cl?.e||"",phone:cl?.p||"",address:cl?.a||""},jobTitle:q.job||"",lineItems:li.length?li:[{description:q.job||"Services",type:"Labour",quantity:1,unitPrice:q.am-q.gst,total:q.am-q.gst}],subtotal:q.am-q.gst,gst:q.gst,total:q.am,externalNote:q.en||""})}
async function dlInv(inv){const cl=CL.find(c=>c.n===inv.cl);const li=await db.getLineItems("invoice",inv.id);generateInvoicePdf({id:inv.id,status:inv.st,date:inv.dt,dueDate:inv.due||null,client:{name:cl?.n||inv.cl,email:cl?.e||"",phone:cl?.p||"",address:cl?.a||""},lineItems:li.length?li:[{description:"Services",type:"Labour",quantity:1,unitPrice:inv.am-inv.gst,total:inv.am-inv.gst}],subtotal:inv.am-inv.gst,gst:inv.gst,total:inv.am,externalNote:inv.en||"",linkedQuote:null,paymentDate:inv.st==="Paid"?new Date().toISOString().slice(0,10):null})}
async function dlExp(){const exps=EXP.map(e=>({date:e.dt,description:e.d,category:e.cat,job:e.job||null,amount:e.am,gst:e.gst||0,hasReceipt:!!e.rc,apportioned:!!e.ap,fullAmount:e.full||null,businessPercent:e.bp||null}));const ta=EXP.reduce((s,e)=>s+e.am,0);const tg=EXP.reduce((s,e)=>s+(e.gst||0),0);const cats={};EXP.forEach(e=>{cats[e.cat]=(cats[e.cat]||0)+e.am});const _ds=EXP.map(e=>e.dt).filter(Boolean).sort(),_fr=_ds[0]||"",_to=_ds[_ds.length-1]||_fr;generateExpenseReportPdf(exps,{from:_fr,to:_to,label:_fr&&_to?`${_fr} to ${_to}`:"All expenses"},{totalAmount:ta,totalGst:tg,byCategory:Object.entries(cats).map(([category,amount])=>({category,amount}))})}

/* === PAGES === */
function Dash({o}){
  const tm=REV[REV.length-1],lm=REV[REV.length-2];
  const _now=new Date(),_mo=_now.getMonth(),_yr=_now.getFullYear(),_monLbl=_now.toLocaleString("en-NZ",{month:"short",year:"numeric"}),_tyS=_mo>=3?_yr:_yr-1,_tyE=_tyS+1,_tyEl=_mo>=3?_mo-2:_mo+10,_tyPct=Math.round(_tyEl/12*100);
  const tRev=REV.reduce((s,r)=>s+r.inv+r.sub,0),tExp=EC.reduce((s,e)=>s+e.v,0);
  const profit=tRev-tExp,margin=Math.round(profit/tRev*100);
  const aj=JOBS.filter(j=>!["Closed","Invoiced","Complete"].includes(j.st));
  const avgJ=Math.round(JOBS.reduce((s,j)=>s+j.v,0)/JOBS.length);
  const qpv=QT.filter(q=>["Draft","Sent"].includes(q.st)).reduce((s,q)=>s+q.am,0);
  const mrr=SUBS[0]?.mrr||0,nsubs=SUBS[0]?.subscribers||0,trend=(SUBS[0]?.trend||[]).map(v=>({v}));
  return<div>
  <div className="flex items-center justify-between mb-6"><div><h1 className="text-2xl font-bold text-stone-900 fs">Dashboard</h1><p className="text-sm text-stone-500 mt-1">{_monLbl} · Tax year ending 31 Mar</p></div><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Plus} onClick={()=>o("exp")}>Expense</B><B vr="secondary" sz="sm" icon={FileText} onClick={()=>o("inv")}>Invoice</B><B sz="sm" icon={Plus} onClick={()=>o("job")}>New Job</B></div></div>

  <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl px-5 py-3 mb-6"><div className="flex items-center justify-between mb-1.5"><span className="text-xs font-medium text-stone-500">Tax Year</span><span className="text-xs text-stone-400">Apr {_tyS} – Mar {_tyE} · {_tyPct}%</span></div><div className="h-1.5 bg-stone-100 rounded-full overflow-hidden"><div className="h-full bg-amber-400 rounded-full transition-all" style={{width:`${_tyPct}%`}}/></div></div>

  <div className="grid grid-cols-4 gap-5 mb-5">
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><div className="flex items-center justify-between mb-2"><span className="text-xs font-medium text-stone-400 uppercase tracking-wider">Revenue (YTD)</span><DollarSign size={15} className="text-stone-300"/></div><div className="text-xl font-semibold text-stone-800 fm">{$(tRev)}</div><div className="flex items-center gap-2 mt-1"><span className="text-xs text-stone-400">YTD · {REV.length} months</span></div><div className="mt-3 h-8"><ResponsiveContainer width="100%" height="100%"><AreaChart data={REV.map(r=>({v:r.inv+r.sub}))}><Area type="monotone" dataKey="v" fill="#d9770620" stroke="#d97706" strokeWidth={1.5} dot={false}/></AreaChart></ResponsiveContainer></div></div>
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5">{(()=>{const sent=INV.filter(i=>i.st==="Sent"),od=INV.filter(i=>i.st==="Overdue"),ost=[...sent,...od];return<><div className="flex items-center justify-between mb-2"><span className="text-xs font-medium text-stone-400 uppercase tracking-wider">Outstanding</span><Clock size={15} className="text-stone-300"/></div><div className="text-xl font-semibold text-stone-800 fm">{$(ost.reduce((s,i)=>s+i.am,0))}</div><div className="flex items-center gap-2 mt-1"><span className="text-xs text-stone-500">{ost.length} inv</span>{od.length>0&&<span className="text-xs text-red-500">{od.length} overdue</span>}</div><div className="mt-3 space-y-1.5">{sent.length>0&&<div className="flex items-center justify-between text-xs"><span className="text-stone-400">Sent</span><span className="text-stone-600 fm">{$(sent.reduce((s,i)=>s+i.am,0))}</span></div>}{od.length>0&&<div className="flex items-center justify-between text-xs"><span className="text-red-400">Overdue</span><span className="text-red-600 fm">{$(od.reduce((s,i)=>s+i.am,0))}</span></div>}</div></>})()}</div>
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><div className="flex items-center justify-between mb-2"><span className="text-xs font-medium text-stone-400 uppercase tracking-wider">Expenses (YTD)</span><Receipt size={15} className="text-stone-300"/></div><div className="text-xl font-semibold text-stone-800 fm">{$(tExp)}</div><div className="flex items-center gap-2 mt-1"><span className="text-xs text-stone-400">{EC.length} categories</span></div><div className="mt-3 flex gap-0.5 h-2 rounded-full overflow-hidden">{EC.map((e,i)=><div key={i} className="h-full first:rounded-l-full last:rounded-r-full" style={{background:e.c,width:`${e.v/tExp*100}%`}} title={`${e.n}: ${$(e.v)}`}/>)}</div></div>
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><div className="flex items-center justify-between mb-2"><span className="text-xs font-medium text-stone-400 uppercase tracking-wider">Net Profit</span><TrendingUp size={15} className="text-stone-300"/></div><div className={`text-xl font-semibold fm ${profit>=0?"text-emerald-700":"text-red-700"}`}>{$(profit)}</div><div className="flex items-center gap-2 mt-1"><span className="text-xs text-stone-400">Before tax</span></div><div className="mt-3"><div className="flex items-center justify-between text-xs mb-1"><span className="text-stone-400">Margin</span><span className={`font-medium ${profit>=0?"text-emerald-600":"text-red-600"}`}>{margin}%</span></div><div className="h-1.5 bg-stone-100 rounded-full overflow-hidden"><div className={`h-full rounded-full ${profit>=0?"bg-emerald-500":"bg-red-500"}`} style={{width:`${Math.min(Math.abs(margin),100)}%`}}/></div></div></div>
  </div>

  <div className="grid grid-cols-6 gap-3 mb-6">{[["This Month",$(tm.inv+tm.sub)],["Quote Pipeline",$(qpv)],["Avg Job Value",$(avgJ)],["Active Jobs",`${aj.length}`],["MRR (myMECA)",$(mrr)],["Subscribers",`${nsubs}`]].map(([l,v])=><div key={l} className="bg-white shadow-sm border border-stone-200/60 rounded-lg px-4 py-3"><p className="text-[11px] text-stone-400 mb-0.5">{l}</p><p className="text-sm font-semibold text-stone-700 fm">{v}</p></div>)}</div>
  <div className="grid grid-cols-3 gap-5 mb-6">
    <div className="col-span-2 bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><div className="flex items-center justify-between mb-4"><h3 className="text-sm font-semibold text-stone-700 fs">Revenue — 6 Months</h3><div className="flex items-center gap-4 text-xs"><span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-stone-800 inline-block"/>Invoices</span><span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-amber-400 inline-block"/>Subs</span></div></div><ResponsiveContainer width="100%" height={240}><BarChart data={REV} barGap={2}><CartesianGrid strokeDasharray="3 3" stroke="#f5f5f4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:12,fill:"#a8a29e"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:12,fill:"#a8a29e"}} axisLine={false} tickLine={false} width={50} tickFormatter={v=>`$${v/1e3}k`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:10,border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",fontSize:13}}/><Bar dataKey="inv" fill="#292524" radius={[4,4,0,0]} name="Invoices"/><Bar dataKey="sub" fill="#fbbf24" radius={[4,4,0,0]} name="Subs"/></BarChart></ResponsiveContainer></div>
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-2 fs">Expenses by Category</h3><p className="text-xs text-stone-400 mb-3">YTD · {$(tExp)}</p><ResponsiveContainer width="100%" height={150}><RPie><Pie data={EC} cx="50%" cy="50%" innerRadius={38} outerRadius={65} dataKey="v" stroke="none">{EC.map((e,i)=><Cell key={i} fill={e.c}/>)}</Pie><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:10,border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",fontSize:13}}/></RPie></ResponsiveContainer><div className="space-y-1 mt-2">{EC.map((e,i)=><div key={i} className="flex items-center justify-between text-xs"><div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full" style={{background:e.c}}/><span className="text-stone-500">{e.n}</span></div><span className="text-stone-600 fm">{$(e.v)}</span></div>)}</div></div>
  </div>
  <div className="grid grid-cols-2 gap-5 mb-6">
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 fs mb-4">Quote Pipeline</h3>{["Draft","Sent","Accepted","Declined"].map(s=>{const qs=QT.filter(q=>q.st===s);if(!qs.length)return null;return<div key={s} className="flex items-center justify-between py-2.5 border-b border-stone-100 last:border-0"><div className="flex items-center gap-2.5"><Badge s={s}/><span className="text-xs text-stone-400">{qs.length} {qs.length===1?"quote":"quotes"}</span></div><span className="text-sm font-medium fm text-stone-700">{$(qs.reduce((a,q)=>a+q.am,0))}</span></div>})}<div className="flex justify-between mt-3 pt-3 border-t border-stone-200"><span className="text-xs font-semibold text-stone-500 uppercase">Open Pipeline</span><span className="text-sm font-semibold fm">{$(qpv)}</span></div></div>
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 fs mb-4">Invoice Summary</h3>{["Draft","Sent","Overdue","Paid"].map(s=>{const invs=INV.filter(i=>i.st===s);return<div key={s} className="flex items-center justify-between py-2.5 border-b border-stone-100 last:border-0"><div className="flex items-center gap-2.5"><Badge s={s}/><span className="text-xs text-stone-400">{invs.length}</span></div><span className={`text-sm font-medium fm ${s==="Overdue"?"text-red-600":s==="Paid"?"text-emerald-600":"text-stone-700"}`}>{$(invs.reduce((a,i)=>a+i.am,0))}</span></div>})}</div>
  </div>

  <div className="grid grid-cols-3 gap-5">
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 fs mb-4">Active Jobs</h3>{aj.map(j=><div key={j.id} className="flex items-center justify-between py-2 border-b border-stone-100 last:border-0"><div className="flex items-center gap-3"><div className={`w-2 h-2 rounded-full ${PD(j.pr)}`}/><div><p className="text-sm font-medium text-stone-800">{j.t}{!!j.n&&<Lock size={11}className="inline ml-1.5 text-amber-500"/>}</p><p className="text-xs text-stone-400">{j.cl}</p></div></div><Badge s={j.st}/></div>)}</div>
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 fs mb-4"><span className="inline-flex items-center gap-2"><AlertTriangle size={14}className="text-red-500"/>Attention</span></h3>{INV.filter(i=>i.st==="Overdue").map(inv=><div key={inv.id} className="p-3 bg-red-50 rounded-lg border border-red-100 mb-3"><div className="flex items-center justify-between"><div><p className="text-sm font-medium text-red-800">{inv.id} — Overdue</p><p className="text-xs text-red-600">{inv.cl} · Due {inv.due}</p></div><span className="text-sm font-semibold text-red-800 fm">{$(inv.am)}</span></div>{inv.inn&&<div className="flex items-start gap-1.5 mt-2 pt-2 border-t border-red-100"><Lock size={11}className="text-red-400 mt-0.5"/><p className="text-xs text-red-700">{inv.inn}</p></div>}</div>)}{(()=>{const gc=INV.filter(i=>i.st==="Paid").reduce((s,i)=>s+i.gst,0);const gp=EXP.reduce((s,e)=>s+(e.gst||0),0);const gd=gc-gp;return gd>0?<div className="p-3 bg-amber-50 rounded-lg border border-amber-100"><p className="text-sm font-medium text-amber-800">GST Return Due</p><p className="text-xs text-amber-600">Estimated from data</p><p className="text-sm font-semibold text-amber-900 mt-1 fm">{$(gd)}</p></div>:null})()}</div>
    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><div className="flex items-center justify-between mb-4"><h3 className="text-sm font-semibold text-stone-700 fs">myMECA</h3><span className="text-[11px] bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded-full font-medium">Live</span></div><div className="grid grid-cols-2 gap-3 mb-4"><div><p className="text-[11px] text-stone-400">MRR</p><p className="text-lg font-semibold text-stone-800 fm">{$(mrr)}</p></div><div><p className="text-[11px] text-stone-400">Subscribers</p><p className="text-lg font-semibold text-stone-800">{nsubs}</p></div></div><div className="h-14"><ResponsiveContainer width="100%" height="100%"><AreaChart data={trend}><Area type="monotone" dataKey="v" fill="#d9770615" stroke="#d97706" strokeWidth={1.5} dot={false}/></AreaChart></ResponsiveContainer></div><div className="mt-3 space-y-1"><div className="flex items-center justify-between text-xs"><span className="text-stone-400">Net (Jan)</span><span className="text-emerald-600 font-medium fm">{$(SUBS[0]?.netJan||0)}</span></div><div className="flex items-center justify-between text-xs"><span className="text-stone-400">Fees (Jan)</span><span className="text-red-500 font-medium fm">-{$(SUBS[0]?.feesJan||0)}</span></div></div></div>
  </div>
</div>}

function JobsPg({o}){const[f,sF]=useState("All");const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("t");const JS=["Quoted","Approved","In Progress","Complete","Invoiced","Closed"];const base=f==="All"?JOBS:JOBS.filter(j=>j.st===f);const fil=q?base.filter(j=>(j.t+j.cl+j.ty).toLowerCase().includes(q.toLowerCase())):base;const l=sorted(fil,(x,k)=>({t:x.t,cl:x.cl,ty:x.ty,st:x.st,v:x.v,due:x.due||""}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Jobs</h1><B sz="sm" icon={Plus} onClick={()=>o("job")}>New Job</B></div><Tabs items={["All",...JS]} active={f} onChange={sF}/><SearchBar value={q} onChange={sQ} placeholder="Search jobs..."/><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="t" sort={sort} toggle={toggle}>Job</SortTh><SortTh sortKey="cl" sort={sort} toggle={toggle}>Client</SortTh><SortTh sortKey="ty" sort={sort} toggle={toggle}>Type</SortTh><SortTh sortKey="st" sort={sort} toggle={toggle}>Status</SortTh><SortTh sortKey="v" sort={sort} toggle={toggle} align="right">Value</SortTh><SortTh sortKey="due" sort={sort} toggle={toggle} align="right">Due</SortTh></tr></thead><tbody>{l.length?l.map(j=><tr key={j.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer" onClick={()=>o("job",j)}><td className="px-5 py-3.5"><div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${PD(j.pr)}`}/><span className="text-sm font-medium text-stone-800">{j.t}</span>{!!j.n&&<Lock size={11}className="text-amber-500"/>}</div></td><td className="px-5 py-3.5 text-sm text-stone-600">{j.cl}</td><td className="px-5 py-3.5"><span className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{j.ty}</span></td><td className="px-5 py-3.5"><Badge s={j.st}/></td><td className="px-5 py-3.5 text-right text-sm font-medium fm">{$(j.v)}</td><td className="px-5 py-3.5 text-right text-sm text-stone-500">{j.due||"—"}</td></tr>):<tr><td colSpan={6} className="px-5 py-8 text-center text-sm text-stone-400">No jobs found</td></tr>}</tbody></table></div></div>}

function ClientsPg({o}){const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("n");const fil=q?CL.filter(c=>(c.n+c.e+c.a).toLowerCase().includes(q.toLowerCase())):CL;const l=sorted(fil,(x,k)=>({n:x.n,e:x.e,a:x.a,j:x.j,r:x.r}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Clients</h1><B sz="sm" icon={Plus} onClick={()=>o("client")}>Add Client</B></div><SearchBar value={q} onChange={sQ} placeholder="Search clients..."/><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="n" sort={sort} toggle={toggle}>Client</SortTh><SortTh sortKey="e" sort={sort} toggle={toggle}>Contact</SortTh><SortTh sortKey="a" sort={sort} toggle={toggle}>Address</SortTh><SortTh sortKey="j" sort={sort} toggle={toggle} align="center">Jobs</SortTh><SortTh sortKey="r" sort={sort} toggle={toggle} align="right">Revenue</SortTh></tr></thead><tbody>{l.length?l.map(c=><tr key={c.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer" onClick={()=>o("client",c)}><td className="px-5 py-3.5 text-sm font-medium text-stone-800">{c.n}</td><td className="px-5 py-3.5"><div className="text-sm text-stone-600">{c.e}</div><div className="text-xs text-stone-400">{c.p}</div></td><td className="px-5 py-3.5 text-sm text-stone-500 max-w-48 truncate">{c.a}</td><td className="px-5 py-3.5 text-sm text-center">{c.j}</td><td className="px-5 py-3.5 text-right text-sm font-medium fm">{$(c.r)}</td></tr>):<tr><td colSpan={5} className="px-5 py-8 text-center text-sm text-stone-400">No clients found</td></tr>}</tbody></table></div></div>}

function ContactsPg({o}){const[f,sF]=useState("All");const[q,sQ]=useState("");const base=f==="All"?CT:CT.filter(c=>c.ty===f);const l=q?base.filter(c=>(c.n+c.co+(c.tg||[]).join(" ")+(c.nt||"")).toLowerCase().includes(q.toLowerCase())):base;return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Contacts Directory</h1><B sz="sm" icon={Plus} onClick={()=>o("contact")}>Add Contact</B></div><Tabs items={["All",...CTYPES]} active={f} onChange={sF}/><SearchBar value={q} onChange={sQ} placeholder="Search contacts..."/><div className="grid grid-cols-2 gap-4">{l.length?l.map(c=><div key={c.id} className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5 hover:border-stone-300 cursor-pointer" onClick={()=>o("contact",c)}><div className="flex items-start justify-between mb-3"><div><h3 className="text-sm font-semibold text-stone-800">{c.n}</h3><p className="text-xs text-stone-500">{c.co}</p></div><span className={`text-xs px-2 py-0.5 rounded-full font-medium ${CC(c.ty)}`}>{c.ty}</span></div><div className="space-y-1.5 mb-3">{c.e&&<div className="flex items-center gap-2 text-xs text-stone-600"><Mail size={12}className="text-stone-400"/>{c.e}</div>}<div className="flex items-center gap-2 text-xs text-stone-600"><Phone size={12}className="text-stone-400"/>{c.p}</div></div>{c.tg?.length>0&&<div className="flex flex-wrap gap-1 mb-3">{c.tg.map(t=><span key={t} className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{t}</span>)}</div>}{c.nt&&<div className="flex items-start gap-2 p-2.5 bg-amber-50 border border-amber-200 rounded-lg"><Lock size={12}className="text-amber-600 mt-0.5"/><p className="text-xs text-amber-800">{c.nt}</p></div>}</div>):<div className="col-span-2 py-8 text-center text-sm text-stone-400">No contacts found</div>}</div></div>}

function EnqPg({o}){const[f,sF]=useState("All");const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("dt","desc");const base=f==="All"?ENQ:ENQ.filter(e=>e.status===f);const fil=q?base.filter(e=>(e.name+e.email+e.msg).toLowerCase().includes(q.toLowerCase())):base;const l=sorted(fil,(x,k)=>({dt:x.dt,name:x.name,email:x.email,status:x.status}[k]));const nc=ENQ.filter(e=>e.status==="New").length;return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Enquiries</h1>{nc>0&&<span className="text-sm text-amber-600 font-medium">{nc} new</span>}</div><Tabs items={["All","New","Read","Replied","Archived"]} active={f} onChange={sF}/><SearchBar value={q} onChange={sQ} placeholder="Search enquiries..."/><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="dt" sort={sort} toggle={toggle}>Date</SortTh><SortTh sortKey="name" sort={sort} toggle={toggle}>Name</SortTh><SortTh sortKey="email" sort={sort} toggle={toggle}>Email</SortTh><th className="text-left text-xs font-medium text-stone-500 uppercase tracking-wider px-5 py-3">Message</th><SortTh sortKey="status" sort={sort} toggle={toggle}>Status</SortTh></tr></thead><tbody>{l.length?l.map(e=><tr key={e.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer" onClick={()=>o("enq",e)}><td className="px-5 py-3.5 text-sm text-stone-500">{new Date(e.dt).toLocaleDateString("en-NZ")}</td><td className="px-5 py-3.5 text-sm font-medium text-stone-800">{e.name}</td><td className="px-5 py-3.5 text-sm text-stone-600">{e.email}</td><td className="px-5 py-3.5 text-sm text-stone-500 max-w-64 truncate">{e.msg}</td><td className="px-5 py-3.5"><div className="flex items-center gap-2"><Badge s={e.status}/>{e.jobId&&<Briefcase size={12} className="text-emerald-500" title="Converted to job"/>}</div></td></tr>):<tr><td colSpan={5} className="px-5 py-8 text-center text-sm text-stone-400">No enquiries yet</td></tr>}</tbody></table></div></div>}
function EnqF({c,item,toast,reload}){const[f,sF]=useState({status:item?.status||"New",notes:item?.notes||""});const u=(k,v)=>sF(p=>({...p,[k]:v}));const linked=item?.jobId?JOBS.find(j=>j.id===item.jobId):null;useEffect(()=>{if(item&&item.status==="New"){db.updateEnquiry(item.id,{status:"Read"}).then(()=>reload())}},[]);const convert=async()=>{const job=await db.createJob({t:`Enquiry from ${item.name}`,cl:"",ty:JTYPES[0]||"Fabrication",pr:"Medium",st:"Quoted",v:"",due:"",n:`Web enquiry: ${item.msg}\nContact: ${item.email}${item.phone?" / "+item.phone:""}`});if(job){await db.updateEnquiry(item.id,{status:"Archived",jobId:job.id});await reload();toast("Job created from enquiry","success");c()}else{toast("Failed to create job","error")}};return<div><div className="space-y-4 mb-6"><div className="p-4 bg-stone-50 rounded-lg border border-stone-200"><div className="grid grid-cols-2 gap-4"><div><p className="text-xs font-medium text-stone-500 uppercase mb-1">Name</p><p className="text-sm text-stone-800 font-medium">{item?.name||"—"}</p></div><div><p className="text-xs font-medium text-stone-500 uppercase mb-1">Email</p><p className="text-sm text-stone-800">{item?.email||"—"}</p></div>{item?.phone&&<div><p className="text-xs font-medium text-stone-500 uppercase mb-1">Phone</p><p className="text-sm text-stone-800">{item.phone}</p></div>}<div><p className="text-xs font-medium text-stone-500 uppercase mb-1">Received</p><p className="text-sm text-stone-500">{item?.dt?new Date(item.dt).toLocaleString("en-NZ"):"—"}</p></div></div></div><div className="p-4 bg-white border border-stone-200 rounded-lg"><p className="text-xs font-medium text-stone-500 uppercase mb-2">Message</p><p className="text-sm text-stone-800 whitespace-pre-wrap">{item?.msg||"—"}</p></div>{linked&&<div className="p-3 bg-emerald-50 border border-emerald-200 rounded-lg flex items-center gap-2"><Briefcase size={14} className="text-emerald-600"/><span className="text-sm text-emerald-800">Converted to job: <strong>{linked.t}</strong></span></div>}</div><FF l="Status"><S value={f.status} onChange={e=>u("status",e.target.value)} options={["New","Read","Replied","Archived"]}/></FF><FF l="Internal Notes"><T value={f.notes} onChange={e=>u("notes",e.target.value)} placeholder="Follow-up notes..."/></FF><div className="flex flex-wrap gap-3 pt-4 border-t border-stone-200 mt-6">{!linked&&<B icon={Briefcase} onClick={convert}>Convert to Job</B>}{item?.email&&<a href={`mailto:${item.email}?subject=Re: Your enquiry`} className="inline-flex items-center justify-center font-medium rounded-lg transition-all gap-2 bg-stone-900 text-white hover:bg-stone-800 px-4 py-2 text-sm"><Send size={16}/>Reply</a>}<B vr="success" icon={CheckCircle} onClick={async()=>{await db.updateEnquiry(item.id,f);await reload();toast("Enquiry updated","success");c()}}>Save</B><B vr="ghost" onClick={c}>Cancel</B><B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteEnquiry(item.id);await reload();toast("Enquiry deleted","info");c()}}>Delete</B></div></div>}

function QuotesPg({o,toast}){const[f,sF]=useState("All");const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("dt","desc");const base=f==="All"?QT:QT.filter(x=>x.st===f);const fil=q?base.filter(x=>(x.id+x.cl+x.job).toLowerCase().includes(q.toLowerCase())):base;const l=sorted(fil,(x,k)=>({id:x.id,cl:x.cl,st:x.st,am:x.am,dt:x.dt}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Quotes</h1><B sz="sm" icon={Plus} onClick={()=>o("quote")}>New Quote</B></div><Tabs items={["All","Draft","Sent","Accepted","Declined","Expired"]} active={f} onChange={sF}/><SearchBar value={q} onChange={sQ} placeholder="Search quotes..."/><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="id" sort={sort} toggle={toggle}>Quote</SortTh><SortTh sortKey="cl" sort={sort} toggle={toggle}>Client / Job</SortTh><SortTh sortKey="st" sort={sort} toggle={toggle}>Status</SortTh><SortTh sortKey="am" sort={sort} toggle={toggle} align="right">Amount</SortTh><th className="w-12"></th></tr></thead><tbody>{l.map(q=><tr key={q.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer" onClick={()=>o("quote",q)}><td className="px-5 py-3.5"><div className="flex items-center gap-2"><span className="text-sm font-mono font-medium text-stone-800">{q.id}</span>{q.v>1&&<span className="text-xs bg-stone-100 text-stone-500 px-1.5 py-0.5 rounded">v{q.v}</span>}{(q.inn||q.en)&&<MessageSquare size={12}className="text-stone-400"/>}</div></td><td className="px-5 py-3.5"><div className="text-sm text-stone-700">{q.cl}</div><div className="text-xs text-stone-400">{q.job}</div></td><td className="px-5 py-3.5"><Badge s={q.st}/></td><td className="px-5 py-3.5 text-right"><span className="text-sm font-medium fm">{$(q.am)}</span><span className="block text-xs text-stone-400">+{$(q.gst)} GST</span></td><td className="px-3"><div className="flex gap-1">{q.st==="Accepted"&&<button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={e=>{e.stopPropagation();toast("Invoice created","success")}}><FileText size={14}/></button>}<button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={e=>{e.stopPropagation();dlQuote(q);toast("PDF downloaded","success")}}><Download size={14}/></button></div></td></tr>)}</tbody></table></div></div>}

function InvPg({o,toast,setView}){const[f,sF]=useState("All");const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("dt","desc");const base=f==="All"?INV:INV.filter(i=>i.st===f);const fil=q?base.filter(i=>(i.id+i.cl).toLowerCase().includes(q.toLowerCase())):base;const l=sorted(fil,(x,k)=>({id:x.id,cl:x.cl,due:x.due||"",st:x.st,am:x.am,dt:x.dt}[k]));return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Invoices</h1><div className="flex gap-2"><B vr="secondary" sz="sm" icon={RefreshCw} onClick={()=>setView("recurring")}>Recurring</B><B sz="sm" icon={Plus} onClick={()=>o("inv")}>New Invoice</B></div></div><div className="grid grid-cols-4 gap-4 mb-6">{["Draft","Sent","Paid","Overdue"].map(st=>{const g=INV.filter(i=>i.st===st);return<div key={st} className={`bg-white shadow-sm border rounded-xl p-4 cursor-pointer transition-all ${f===st?"border-amber-400 ring-1 ring-amber-400/30":"border-stone-200/60 hover:border-stone-300"}`} onClick={()=>sF(f===st?"All":st)}><p className="text-xs font-medium text-stone-500 uppercase">{st}</p><p className="text-xl font-semibold mt-1 fm">{$(g.reduce((s,i)=>s+i.am,0))}</p><p className="text-xs text-stone-400">{g.length} inv</p></div>})}</div><SearchBar value={q} onChange={sQ} placeholder="Search invoices..."/><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="id" sort={sort} toggle={toggle}>Invoice</SortTh><SortTh sortKey="cl" sort={sort} toggle={toggle}>Client</SortTh><SortTh sortKey="due" sort={sort} toggle={toggle}>Due</SortTh><SortTh sortKey="st" sort={sort} toggle={toggle}>Status</SortTh><SortTh sortKey="am" sort={sort} toggle={toggle} align="right">Amount</SortTh><th className="w-10"></th></tr></thead><tbody>{l.map(inv=><tr key={inv.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer" onClick={()=>o("inv",inv)}><td className="px-5 py-3.5"><div className="flex items-center gap-2"><span className="text-sm font-mono font-medium text-stone-800">{inv.id}</span>{!!inv.rec&&<RefreshCw size={12}className="text-blue-500"/>}{(inv.inn||inv.en)&&<MessageSquare size={12}className="text-stone-400"/>}</div></td><td className="px-5 py-3.5 text-sm text-stone-600">{inv.cl}</td><td className="px-5 py-3.5 text-sm text-stone-500">{inv.due||"—"}</td><td className="px-5 py-3.5"><Badge s={inv.st}/></td><td className="px-5 py-3.5 text-right"><span className="text-sm font-medium fm">{$(inv.am)}</span><span className="block text-xs text-stone-400">GST {$(inv.gst)}</span></td><td className="px-3"><button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={e=>{e.stopPropagation();dlInv(inv);toast("PDF downloaded","success")}}><Download size={14}/></button></td></tr>)}</tbody></table></div></div>}

function ExpPg({o,setView}){const[fc,sFc]=useState("All");const[pf,sPf]=useState("All");const[q,sQ]=useState("");const{sort,toggle,sorted}=useSort("dt","desc");const byPaid=pf==="All"?EXP:pf==="Paid"?EXP.filter(e=>e.paid):EXP.filter(e=>!e.paid);const base=fc==="All"?byPaid:byPaid.filter(e=>e.cat===fc);const fil=q?base.filter(e=>(e.d+e.cat+(e.job||"")+(e.invNo||"")+(e.sup||"")).toLowerCase().includes(q.toLowerCase())):base;const l=sorted(fil,(x,k)=>({dt:x.dt,d:x.d,cat:x.cat,job:x.job||"",am:x.am,due:x.due||""}[k]));const unpaidTotal=EXP.filter(e=>!e.paid).reduce((s,e)=>s+e.am,0);const paidTotal=EXP.filter(e=>e.paid).reduce((s,e)=>s+e.am,0);return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Expenses</h1><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Download} onClick={()=>dlExp()}>Export PDF</B><B vr="secondary" sz="sm" icon={Car} onClick={()=>setView("vehicle")}>Vehicle Log</B><B vr="secondary" sz="sm" icon={Home} onClick={()=>setView("home")}>Home Office</B><B sz="sm" icon={Plus} onClick={()=>o("exp")}>Log Expense</B></div></div><div className="grid grid-cols-3 gap-4 mb-6">{[["All",EXP.length,EXP.reduce((s,e)=>s+e.am,0)],["Unpaid",EXP.filter(e=>!e.paid).length,unpaidTotal],["Paid",EXP.filter(e=>e.paid).length,paidTotal]].map(([label,cnt,tot])=><div key={label} className={`bg-white shadow-sm border rounded-xl p-4 cursor-pointer transition-all ${pf===label?"border-amber-400 ring-1 ring-amber-400/30":"border-stone-200/60 hover:border-stone-300"}`} onClick={()=>sPf(pf===label?"All":label)}><p className="text-xs font-medium text-stone-500 uppercase">{label}</p><p className="text-xl font-semibold mt-1 fm">{$(tot)}</p><p className="text-xs text-stone-400">{cnt} expenses</p></div>)}</div><Tabs items={["All",...ECATEGORIES]} active={fc} onChange={sFc}/><SearchBar value={q} onChange={sQ} placeholder="Search expenses..."/><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><SortTh sortKey="dt" sort={sort} toggle={toggle}>Date</SortTh><SortTh sortKey="d" sort={sort} toggle={toggle}>Description</SortTh><SortTh sortKey="cat" sort={sort} toggle={toggle}>Cat</SortTh><SortTh sortKey="due" sort={sort} toggle={toggle}>Due</SortTh><SortTh sortKey="am" sort={sort} toggle={toggle} align="right">Amount</SortTh><th className="text-center text-xs font-medium text-stone-500 uppercase px-5 py-3">Paid</th><th className="text-center text-xs font-medium text-stone-500 uppercase px-5 py-3">Rcpt</th></tr></thead><tbody>{l.map(e=>{const overdue=!e.paid&&e.due&&new Date(e.due)<new Date();return<tr key={e.id} className={`border-b border-stone-100 hover:bg-stone-50 cursor-pointer${overdue?" bg-red-50/50":""}`} onClick={()=>o("exp",e)}><td className="px-5 py-3.5 text-sm text-stone-500">{e.dt}</td><td className="px-5 py-3.5"><span className="text-sm text-stone-800">{e.d}</span>{e.invNo&&<span className="ml-2 text-xs bg-stone-100 text-stone-500 px-1.5 py-0.5 rounded-full">{e.invNo}</span>}{!!e.ap&&<span className="ml-2 text-xs bg-amber-50 text-amber-700 px-1.5 py-0.5 rounded-full">{e.bp}%</span>}{!!e.auto&&<span className="ml-2 text-xs bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded-full">auto</span>}</td><td className="px-5 py-3.5"><span className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{e.cat}</span></td><td className={`px-5 py-3.5 text-sm${overdue?" text-red-600 font-medium":" text-stone-500"}`}>{e.due||"—"}</td><td className="px-5 py-3.5 text-right"><span className="text-sm font-medium fm">{$(e.am)}</span>{!!e.ap&&<span className="block text-xs text-stone-400">of {$(e.full)}</span>}</td><td className="px-5 py-3.5 text-center">{e.paid?<CheckCircle size={16}className="mx-auto text-emerald-500"/>:<Circle size={16}className="mx-auto text-amber-400"/>}</td><td className="px-5 py-3.5 text-center">{e.rc?<CheckCircle size={16}className="mx-auto text-emerald-500"/>:<Circle size={16}className="mx-auto text-stone-300"/>}</td></tr>})}</tbody></table></div></div>}

function SubsPg({setView,o}){const[exp,sExp]=useState({});const toggle=id=>sExp(p=>({...p,[id]:!p[id]}));const _n=new Date(),_fy=_n.getMonth()>=3?new Date(_n.getFullYear(),3,1):new Date(_n.getFullYear()-1,3,1),fyStr=_fy.toISOString().split('T')[0];const strpYr=STRP.filter(r=>r.ty==='charge'&&r.dt>=fyStr);const strpG=strpYr.reduce((s,r)=>s+(r.g||0),0);const strpF=strpYr.reduce((s,r)=>s+(r.fe||0),0);const strpN=strpYr.reduce((s,r)=>s+(r.ne||0),0);const MO=["Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar"];return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Subscriptions & Apps</h1><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Upload} onClick={()=>setView("stripe")}>Import Stripe</B><B sz="sm" icon={Plus} onClick={()=>o("incSrc")}>Add Source</B></div></div>{SUBS.map(a=>{const payments=MPAY.filter(p=>p.sid===a.id);const isStripe=a.platform==='Stripe';const mpYtd=db.computeManualPaymentYTD(payments,a.id);const hasMP=payments.length>0;let ytdG,ytdF,ytdN;if(isStripe){ytdG=strpG||a.grossJan||0;ytdF=strpF||a.feesJan||0;ytdN=strpN||a.netJan||(ytdG-ytdF)}else if(hasMP){ytdG=mpYtd.ytdGross;ytdF=mpYtd.ytdFees;ytdN=mpYtd.ytdNet}else{ytdG=a.grossJan||0;ytdF=a.feesJan||0;ytdN=a.netJan||0}const txns=isStripe?strpYr:payments;const txnCount=txns.length;const txnNet=txns.reduce((s,r)=>s+(r.ne||0),0);const chartData=MO.map((label,i)=>{const mIdx=(i+3)%12;const yr=i<9?_fy.getFullYear():_fy.getFullYear()+1;return{m:label,v:txns.filter(r=>{const d=new Date(r.dt);return d.getMonth()===mIdx&&d.getFullYear()===yr}).reduce((s,r)=>s+(r.g||0),0)}});const hasTxnData=chartData.some(d=>d.v>0);const nowMoIdx=_n.getMonth()>=3?_n.getMonth()-3:_n.getMonth()+9;const firstNonZero=chartData.findIndex(d=>d.v>0);const trendData=hasTxnData?chartData.slice(Math.max(0,firstNonZero),nowMoIdx+1):(a.trend||[]).map((v,i)=>({m:a.metadata?.monthLabels?.[i]||("M"+(i+1)),v}));return<div key={a.id} className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6 mb-6"><div className="flex items-start justify-between mb-6"><div><h2 className="text-lg font-semibold text-stone-900 fs">{a.app}</h2><p className="text-sm text-stone-500">{a.platform} · {a.subscribers} subs</p></div><div className="flex items-center gap-3">{!isStripe&&<B vr="secondary" sz="sm" icon={Plus} onClick={()=>o("mp",{sid:a.id})}>Log Payment</B>}<div className="text-right"><p className="text-2xl font-semibold fm">{$(a.mrr)}</p><p className="text-xs text-stone-500">MRR</p></div></div></div><div className="grid grid-cols-3 gap-4 mb-6"><div className="bg-stone-50 rounded-lg p-4"><p className="text-xs font-medium text-stone-500 uppercase mb-1">Gross (YTD)</p><p className="text-lg font-semibold fm">{$(ytdG)}</p></div><div className="bg-red-50 rounded-lg p-4"><p className="text-xs font-medium text-red-500 uppercase mb-1">Fees (YTD)</p><p className="text-lg font-semibold text-red-700 fm">{ytdF>0?`-${$(ytdF)}`:$(0)}</p></div><div className="bg-emerald-50 rounded-lg p-4"><p className="text-xs font-medium text-emerald-600 uppercase mb-1">Net (YTD)</p><p className="text-lg font-semibold text-emerald-700 fm">{$(ytdN)}</p></div></div>{trendData.length>0&&<><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">{hasTxnData?"Revenue (Monthly)":"MRR Trend"}</h3><ResponsiveContainer width="100%" height={120}><LineChart data={trendData}><CartesianGrid strokeDasharray="3 3" stroke="#f5f5f4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:11,fill:"#78716c"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:11,fill:"#78716c"}} axisLine={false} tickLine={false} width={45} tickFormatter={v=>`$${v}`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:10,border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",fontSize:13}}/><Line type="monotone" dataKey="v" stroke="#d97706" strokeWidth={2.5} dot={{fill:"#d97706",r:3}}/></LineChart></ResponsiveContainer></>}{txnCount>0&&<div className="mt-6 border-t border-stone-200 pt-4"><button onClick={()=>toggle(a.id)} className="flex items-center gap-2 text-sm font-semibold text-stone-700 mb-3 hover:text-stone-900"><span>{exp[a.id]?"\u25BE":"\u25B8"}</span><span>{isStripe?"Charges":"Payments"} ({txnCount})</span><span className="text-xs text-stone-400 font-normal ml-2">{$(txnNet)} net</span></button>{exp[a.id]&&<div className="bg-white border border-stone-200 rounded-lg overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-4 py-2">Date</th><th className="text-left text-xs font-medium text-stone-500 uppercase px-4 py-2">{isStripe?"Description":"Payer"}</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-2">Gross</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-2">Fee</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-2">Net</th></tr></thead><tbody>{txns.map(p=><tr key={p.id} className={"border-b border-stone-100 hover:bg-stone-50"+(isStripe?"":" cursor-pointer")} onClick={()=>{if(!isStripe)o("mp",p)}}><td className="px-4 py-2.5 text-xs text-stone-500">{p.dt}</td><td className="px-4 py-2.5 text-xs text-stone-800">{isStripe?(p.d||"\u2014"):(p.payer||"\u2014")}</td><td className="px-4 py-2.5 text-right text-xs fm">{$(p.g)}</td><td className="px-4 py-2.5 text-right text-xs text-red-600 fm">{p.fe?`-${$(p.fe)}`:"\u2014"}</td><td className="px-4 py-2.5 text-right text-xs font-medium fm">{$(p.ne)}</td></tr>)}</tbody></table></div>}</div>}{!isStripe&&txnCount===0&&<div className="mt-6 border-t border-stone-200 pt-4"><p className="text-xs text-stone-400 text-center py-3">No payments logged yet. <button onClick={()=>o("mp",{sid:a.id})} className="text-amber-600 hover:underline">Log first payment</button></p></div>}</div>})}</div>}

function BudgetPg({o,toast}){
  const[tab,sTab]=useState("Summary");
  const now=new Date(),cm=now.getMonth(),cy=now.getFullYear(),dty=cm>=3?cy:cy-1;
  const[selYear,setSelYear]=useState(dty);
  const MO=["Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar"];

  const yb=BUDGET.filter(b=>b.taxYear===selYear);
  const ib=yb.filter(b=>b.type==="income"),eb=yb.filter(b=>b.type==="expense");
  const actuals=db.computeBudgetActuals(INV,EXP,SUBS,TRIPS,HOEX,STRP,DEDS,selYear);

  const tbi=ib.reduce((s,b)=>s+(b.annualAmount||0),0);
  const tbe=eb.reduce((s,b)=>s+(b.annualAmount||0),0);
  const tai=ICATEGORIES.reduce((s,k)=>s+(actuals[k]||[]).reduce((a,m)=>a+m.value,0),0);
  const tae=Object.keys(actuals).filter(k=>!ICATEGORIES.includes(k)).reduce((s,k)=>s+(actuals[k]||[]).reduce((a,m)=>a+m.value,0),0);
  const iv=tai-tbi,ev=tae-tbe;

  // Monthly budget for a given category
  const mBudget=(cat,mi)=>{const b=yb.find(x=>x.category===cat);if(!b)return 0;const ma=b.monthlyAmounts||{};return Object.keys(ma).length>0?(ma[MO[mi]]||0):(b.annualAmount||0)/12};

  // Monthly chart data
  const chartData=MO.map((m,i)=>{
    const bInc=ib.reduce((s,b)=>s+mBudget(b.category,i),0);
    const bExp=eb.reduce((s,b)=>s+mBudget(b.category,i),0);
    const aInc=ICATEGORIES.reduce((s,k)=>s+(actuals[k]?.[i]?.value||0),0);
    const aExp=Object.keys(actuals).filter(k=>!ICATEGORIES.includes(k)).reduce((s,k)=>s+(actuals[k]?.[i]?.value||0),0);
    return{m,bInc,bExp,aInc,aExp};
  });

  // Check if a month is in the future
  const isFuture=(mi)=>{const mIdx=(mi+3)%12;const y=mi<9?selYear:selYear+1;return y>cy||(y===cy&&mIdx>cm)};

  return<div>
  <div className="flex items-center justify-between mb-6"><div><h1 className="text-2xl font-bold text-stone-900 fs">Budget</h1><p className="text-sm text-stone-500 mt-1">Tax year Apr {selYear} – Mar {selYear+1}</p></div><div className="flex items-center gap-3"><select value={selYear} onChange={e=>setSelYear(parseInt(e.target.value))} className="px-3 py-2 border border-stone-300 rounded-lg text-sm text-stone-900 bg-white">{[dty-1,dty,dty+1].map(y=><option key={y} value={y}>Apr {y} – Mar {y+1}</option>)}</select><B sz="sm" icon={Plus} onClick={()=>o("budget")}>New Budget Item</B></div></div>

  <Tabs items={["Summary","Monthly","Income","Expenses"]} active={tab} onChange={sTab}/>

  {tab==="Summary"&&<div>
    <div className="grid grid-cols-4 gap-4 mb-6">
      <Stat l="Budget Income" v={$(tbi)} icon={DollarSign} sub="Annual plan"/>
      <Stat l="Actual Income" v={$(tai)} icon={TrendingUp} ch={tbi>0?(iv>=0?"On track":"Behind"):null} up={iv>=0}/>
      <Stat l="Budget Expenses" v={$(tbe)} icon={Receipt} sub="Annual plan"/>
      <Stat l="Actual Expenses" v={$(tae)} icon={AlertTriangle} ch={tbe>0?(ev<=0?"Under budget":"Over budget"):null} up={ev<=0}/>
    </div>

    <div className="grid grid-cols-3 gap-5 mb-6">
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-1 fs">Income Variance</h3><p className={`text-2xl font-semibold fm ${iv>=0?"text-emerald-700":"text-red-700"}`}>{iv>=0?"+":""}{$(iv)}</p>{tbi>0&&<p className="text-xs text-stone-400 mt-1">{((iv/tbi)*100).toFixed(1)}% vs budget</p>}</div>
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-1 fs">Expense Variance</h3><p className={`text-2xl font-semibold fm ${ev<=0?"text-emerald-700":"text-red-700"}`}>{ev>=0?"+":""}{$(ev)}</p>{tbe>0&&<p className="text-xs text-stone-400 mt-1">{((Math.abs(ev)/tbe)*100).toFixed(1)}% {ev<=0?"under":"over"}</p>}</div>
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-1 fs">Net Position</h3><p className={`text-2xl font-semibold fm ${iv-ev>=0?"text-emerald-700":"text-red-700"}`}>{iv-ev>=0?"+":""}{$(iv-ev)}</p><p className="text-xs text-stone-400 mt-1">Budget net: {$(tbi-tbe)}</p></div>
    </div>

    <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5 mb-6"><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Monthly Budget vs Actual</h3><div className="flex items-center gap-4 mb-3 text-xs"><span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-amber-400 inline-block"/>Budget</span><span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-emerald-500 inline-block"/>Actual</span></div><ResponsiveContainer width="100%" height={260}><BarChart data={chartData} barGap={2}><CartesianGrid strokeDasharray="3 3" stroke="#f5f5f4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:12,fill:"#a8a29e"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:12,fill:"#a8a29e"}} axisLine={false} tickLine={false} width={55} tickFormatter={v=>`$${v/1e3}k`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:10,border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",fontSize:13}}/><Bar dataKey="bInc" fill="#fbbf24" radius={[4,4,0,0]} name="Budget Income"/><Bar dataKey="aInc" fill="#10b981" radius={[4,4,0,0]} name="Actual Income"/><Bar dataKey="bExp" fill="#fca5a5" radius={[4,4,0,0]} name="Budget Expense"/><Bar dataKey="aExp" fill="#ef4444" radius={[4,4,0,0]} name="Actual Expense"/></BarChart></ResponsiveContainer></div>

    {yb.length>0&&<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Category Utilisation</h3><div className="space-y-3">{yb.map(b=>{const actual=(actuals[b.category]||[]).reduce((s,m)=>s+m.value,0);const pct=b.annualAmount>0?Math.min(Math.round(actual/b.annualAmount*100),200):0;const over=pct>100;return<div key={b.id} className="flex items-center gap-4"><span className="text-sm text-stone-700 w-28 truncate">{b.category}</span><div className="flex-1 h-2 bg-stone-100 rounded-full overflow-hidden"><div className={`h-full rounded-full transition-all ${over?"bg-red-500":b.type==="income"?"bg-emerald-500":"bg-amber-400"}`} style={{width:`${Math.min(pct,100)}%`}}/></div><span className="text-xs font-medium text-stone-500 w-12 text-right">{pct}%</span><span className="text-xs text-stone-400 w-24 text-right fm">{$(actual)} / {$(b.annualAmount)}</span></div>})}</div></div>}
    {yb.length===0&&<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-12 text-center"><Target size={32} className="mx-auto text-stone-300 mb-3"/><h3 className="text-sm font-semibold text-stone-700 mb-1">No budget set</h3><p className="text-xs text-stone-400 mb-4">Create budget items to start tracking income and expenses against targets.</p><B sz="sm" icon={Plus} onClick={()=>o("budget")}>New Budget Item</B></div>}
  </div>}

  {tab==="Monthly"&&<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-4 py-3">Month</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-3">Budget Inc</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-3">Actual Inc</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-3">Var</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-3">Budget Exp</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-3">Actual Exp</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-4 py-3">Var</th></tr></thead><tbody>{chartData.map((r,i)=>{const incV=r.aInc-r.bInc,expV=r.aExp-r.bExp,fut=isFuture(i);return<tr key={r.m} className={`border-b border-stone-100 ${fut?"opacity-40":""}`}><td className="px-4 py-3 text-sm font-medium text-stone-800">{r.m}{i===MO.indexOf(["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][cm])&&!fut&&<span className="ml-1.5 text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">now</span>}</td><td className="px-4 py-3 text-right text-sm fm text-stone-500">{$(r.bInc)}</td><td className="px-4 py-3 text-right text-sm font-medium fm">{fut?"—":$(r.aInc)}</td><td className={`px-4 py-3 text-right text-sm font-medium fm ${fut?"":incV>=0?"text-emerald-700":"text-red-700"}`}>{fut?"—":`${incV>=0?"+":""}${$(incV)}`}</td><td className="px-4 py-3 text-right text-sm fm text-stone-500">{$(r.bExp)}</td><td className="px-4 py-3 text-right text-sm font-medium fm">{fut?"—":$(r.aExp)}</td><td className={`px-4 py-3 text-right text-sm font-medium fm ${fut?"":expV<=0?"text-emerald-700":"text-red-700"}`}>{fut?"—":`${expV>=0?"+":""}${$(expV)}`}</td></tr>})}<tr className="bg-stone-50 font-semibold"><td className="px-4 py-3 text-sm">Total</td><td className="px-4 py-3 text-right text-sm fm">{$(tbi)}</td><td className="px-4 py-3 text-right text-sm fm">{$(tai)}</td><td className={`px-4 py-3 text-right text-sm fm ${iv>=0?"text-emerald-700":"text-red-700"}`}>{iv>=0?"+":""}{$(iv)}</td><td className="px-4 py-3 text-right text-sm fm">{$(tbe)}</td><td className="px-4 py-3 text-right text-sm fm">{$(tae)}</td><td className={`px-4 py-3 text-right text-sm fm ${ev<=0?"text-emerald-700":"text-red-700"}`}>{ev>=0?"+":""}{$(ev)}</td></tr></tbody></table></div>}

  {tab==="Income"&&<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Category</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Budget</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Actual</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Variance</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">%</th><th className="w-10"></th></tr></thead><tbody>{ICATEGORIES.map(cat=>{const budget=ib.find(b=>b.category===cat)?.annualAmount||0;const actual=(actuals[cat]||[]).reduce((s,m)=>s+m.value,0);const v=actual-budget;const pct=budget>0?((v/budget)*100).toFixed(1):"—";return<tr key={cat} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer" onClick={()=>{const it=ib.find(b=>b.category===cat);if(it)o("budget",it)}}><td className="px-5 py-3.5 text-sm font-medium text-stone-800">{cat}</td><td className="px-5 py-3.5 text-right text-sm fm">{$(budget)}</td><td className="px-5 py-3.5 text-right text-sm font-medium fm">{$(actual)}</td><td className={`px-5 py-3.5 text-right text-sm font-medium fm ${v>=0?"text-emerald-700":"text-red-700"}`}>{v>=0?"+":""}{$(v)}</td><td className="px-5 py-3.5 text-right text-sm text-stone-500">{pct}{pct!=="—"&&"%"}</td><td className="px-3"><button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={e=>{e.stopPropagation();const it=ib.find(b=>b.category===cat);if(it)o("budget",it)}}><Edit3 size={14}/></button></td></tr>})}<tr className="bg-stone-50 font-semibold"><td className="px-5 py-3 text-sm">Total</td><td className="px-5 py-3 text-right text-sm fm">{$(tbi)}</td><td className="px-5 py-3 text-right text-sm fm">{$(tai)}</td><td className={`px-5 py-3 text-right text-sm fm ${iv>=0?"text-emerald-700":"text-red-700"}`}>{iv>=0?"+":""}{$(iv)}</td><td className="px-5 py-3 text-right text-sm text-stone-500">{tbi>0?((iv/tbi)*100).toFixed(1)+"%":"—"}</td><td></td></tr></tbody></table><div className="p-5"><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">Monthly Income Trend</h3><ResponsiveContainer width="100%" height={180}><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" stroke="#f5f5f4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:11,fill:"#a8a29e"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:11,fill:"#a8a29e"}} axisLine={false} tickLine={false} width={50} tickFormatter={v=>`$${v/1e3}k`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:10,border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",fontSize:13}}/><Bar dataKey="bInc" fill="#fbbf24" radius={[4,4,0,0]} name="Budget"/><Bar dataKey="aInc" fill="#10b981" radius={[4,4,0,0]} name="Actual"/></BarChart></ResponsiveContainer></div></div>}

  {tab==="Expenses"&&<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Category</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Budget</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Actual</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Variance</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Used</th><th className="w-10"></th></tr></thead><tbody>{ECATEGORIES.map(cat=>{const budget=eb.find(b=>b.category===cat)?.annualAmount||0;const actual=(actuals[cat]||[]).reduce((s,m)=>s+m.value,0);const v=actual-budget;const pct=budget>0?Math.round(actual/budget*100):0;return<tr key={cat} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer" onClick={()=>{const it=eb.find(b=>b.category===cat);if(it)o("budget",it)}}><td className="px-5 py-3.5"><div className="text-sm font-medium text-stone-800">{cat}</div>{budget>0&&<div className="mt-1 h-1.5 w-24 bg-stone-100 rounded-full overflow-hidden"><div className={`h-full rounded-full ${pct>100?"bg-red-500":"bg-amber-400"}`} style={{width:`${Math.min(pct,100)}%`}}/></div>}</td><td className="px-5 py-3.5 text-right text-sm fm">{$(budget)}</td><td className="px-5 py-3.5 text-right text-sm font-medium fm">{$(actual)}</td><td className={`px-5 py-3.5 text-right text-sm font-medium fm ${v<=0?"text-emerald-700":"text-red-700"}`}>{v>=0?"+":""}{$(v)}</td><td className="px-5 py-3.5 text-right text-sm text-stone-500">{budget>0?pct+"%":"—"}</td><td className="px-3"><button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={e=>{e.stopPropagation();const it=eb.find(b=>b.category===cat);if(it)o("budget",it)}}><Edit3 size={14}/></button></td></tr>})}<tr className="bg-stone-50 font-semibold"><td className="px-5 py-3 text-sm">Total</td><td className="px-5 py-3 text-right text-sm fm">{$(tbe)}</td><td className="px-5 py-3 text-right text-sm fm">{$(tae)}</td><td className={`px-5 py-3 text-right text-sm fm ${ev<=0?"text-emerald-700":"text-red-700"}`}>{ev>=0?"+":""}{$(ev)}</td><td className="px-5 py-3 text-right text-sm text-stone-500">{tbe>0?Math.round(tae/tbe*100)+"%":"—"}</td><td></td></tr></tbody></table><div className="p-5"><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">Monthly Expense Trend</h3><ResponsiveContainer width="100%" height={180}><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" stroke="#f5f5f4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:11,fill:"#a8a29e"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:11,fill:"#a8a29e"}} axisLine={false} tickLine={false} width={50} tickFormatter={v=>`$${v/1e3}k`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:10,border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",fontSize:13}}/><Bar dataKey="bExp" fill="#fca5a5" radius={[4,4,0,0]} name="Budget"/><Bar dataKey="aExp" fill="#ef4444" radius={[4,4,0,0]} name="Actual"/></BarChart></ResponsiveContainer></div></div>}
</div>}

function RepPg({toast}){const[t,sT]=useState("Profit & Loss");const[cfPd,sCfPd]=useState("Monthly");const ti=PNL.reduce((s,d)=>s+d.i,0);const te=PNL.reduce((s,d)=>s+d.e,0);const _invI=INV.filter(i=>i.st==="Paid").reduce((s,i)=>s+(i.am-(i.gst||0)),0);const _subI=ti-_invI;const sf=STRP.filter(r=>r.ty==="charge").reduce((s,r)=>s+(r.fe||0),0);return<div><div className="flex items-center justify-between mb-6"><h1 className="text-2xl font-bold text-stone-900 fs">Reports</h1><div className="flex gap-2"><B vr="secondary" sz="sm" icon={Download} onClick={()=>toast("CSV exported","success")}>Export</B><B vr="secondary" sz="sm" icon={Printer} onClick={()=>toast("Print opened","info")}>Print</B></div></div><Tabs items={["Profit & Loss","Cashflow","GST Return","Tax Summary","Job Profitability"]} active={t} onChange={sT}/>
  {t==="Profit & Loss"&&<div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5 mb-6"><ResponsiveContainer width="100%" height={240}><AreaChart data={PNL}><CartesianGrid strokeDasharray="3 3" stroke="#f5f5f4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:12,fill:"#78716c"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:12,fill:"#78716c"}} axisLine={false} tickLine={false} width={50} tickFormatter={v=>`$${v/1e3}k`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:10,border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",fontSize:13}}/><Area type="monotone" dataKey="i" fill="#d9770620" stroke="#d97706" strokeWidth={2} name="Income"/><Area type="monotone" dataKey="e" fill="#dc262620" stroke="#dc2626" strokeWidth={2} name="Expenses"/></AreaChart></ResponsiveContainer></div><div className="grid grid-cols-2 gap-6"><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">Income</h3>{[["Invoices",_invI],["Subscriptions",_subI]].map(([l,v])=><div key={l} className="flex justify-between py-2 border-b border-stone-100"><span className="text-sm text-stone-600">{l}</span><span className="text-sm font-medium fm">{$(v)}</span></div>)}<div className="flex justify-between py-2 font-semibold"><span className="text-sm">Total</span><span className="fm">{$(ti)}</span></div></div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">Expenses</h3>{EC.map(e=><div key={e.n} className="flex justify-between py-2 border-b border-stone-100"><span className="text-sm text-stone-600">{e.n}</span><span className="text-sm font-medium fm">{$(e.v)}</span></div>)}<div className="flex justify-between py-2 border-b border-stone-100"><span className="text-sm text-stone-600">Stripe Fees</span><span className="text-sm font-medium fm">{$(sf)}</span></div><div className="flex justify-between py-2 font-semibold"><span className="text-sm">Total</span><span className="fm">{$(te+sf)}</span></div><div className="mt-4 pt-4 border-t-2 border-stone-900"><div className="flex justify-between"><span className="font-semibold">NET PROFIT</span><span className={`font-semibold fm ${(ti-te-sf)>=0?"text-emerald-700":"text-red-700"}`}>{$(ti-te-sf)}</span></div></div></div></div></div>}
  {t==="Cashflow"&&(()=>{const today=new Date();const todayStr=today.toISOString().slice(0,10);const MN=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];const arDue=INV.filter(i=>i.st==="Sent"||i.st==="Overdue");const arTotal=arDue.reduce((s,i)=>s+i.am,0);const arOverdue=arDue.filter(i=>i.due&&i.due<todayStr);const arOdTotal=arOverdue.reduce((s,i)=>s+i.am,0);const apDue=EXP.filter(e=>!e.paid);const apTotal=apDue.reduce((s,e)=>s+e.am,0);const apOverdue=apDue.filter(e=>e.due&&e.due<todayStr);const apOdTotal=apOverdue.reduce((s,e)=>s+e.am,0);const mrrTotal=SUBS.reduce((s,a)=>s+(a.mrr||0),0);const netPos=arTotal+mrrTotal-apTotal;const isM=cfPd==="Monthly";const bars=[];if(isM){for(let m=0;m<6;m++){const ms=new Date(today.getFullYear(),today.getMonth()+m,1);const me=new Date(today.getFullYear(),today.getMonth()+m+1,0);const msStr=ms.toISOString().slice(0,10);const meStr=me.toISOString().slice(0,10);const inM=arDue.filter(i=>i.due&&i.due>=msStr&&i.due<=meStr).reduce((s,i)=>s+i.am,0)+mrrTotal;const outM=apDue.filter(e=>e.due&&e.due>=msStr&&e.due<=meStr).reduce((s,e)=>s+e.am,0);bars.push({m:MN[ms.getMonth()],i:Math.round(inM*100)/100,o:outM})}}else{const weeklyMrr=mrrTotal*12/52;for(let w=0;w<8;w++){const ws=new Date(today);ws.setDate(ws.getDate()+w*7);const we=new Date(ws);we.setDate(we.getDate()+6);const wStr=ws.toISOString().slice(0,10);const weStr=we.toISOString().slice(0,10);const inW=arDue.filter(i=>i.due&&i.due>=wStr&&i.due<=weStr).reduce((s,i)=>s+i.am,0)+weeklyMrr;const outW=apDue.filter(e=>e.due&&e.due>=wStr&&e.due<=weStr).reduce((s,e)=>s+e.am,0);bars.push({m:`${ws.getDate()}/${ws.getMonth()+1}`,i:Math.round(inW*100)/100,o:outW})}}const noDueIn=arDue.filter(i=>!i.due).reduce((s,i)=>s+i.am,0);const noDueOut=apDue.filter(e=>!e.due).reduce((s,e)=>s+e.am,0);return<div><div className="grid grid-cols-4 gap-4 mb-6"><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-xs font-semibold text-stone-500 uppercase mb-1">Receivable</h3><p className="text-2xl font-semibold text-emerald-700 fm">{$(arTotal)}</p><p className="text-xs text-stone-400">{arDue.length} outstanding invoices</p>{arOdTotal>0&&<p className="text-xs text-red-600 mt-1">{$(arOdTotal)} overdue</p>}</div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-xs font-semibold text-stone-500 uppercase mb-1">Recurring</h3><p className="text-2xl font-semibold text-blue-700 fm">{$(mrrTotal)}</p><p className="text-xs text-stone-400">{SUBS.length} source{SUBS.length!==1?"s":""} · /month</p></div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-xs font-semibold text-stone-500 uppercase mb-1">Payable</h3><p className="text-2xl font-semibold text-red-700 fm">{$(apTotal)}</p><p className="text-xs text-stone-400">{apDue.length} unpaid expenses</p>{apOdTotal>0&&<p className="text-xs text-red-600 mt-1">{$(apOdTotal)} overdue</p>}</div><div className={`bg-white shadow-sm border rounded-xl p-5 ${netPos>=0?"border-emerald-200":"border-red-200"}`}><h3 className="text-xs font-semibold text-stone-500 uppercase mb-1">Net Position</h3><p className={`text-2xl font-semibold fm ${netPos>=0?"text-emerald-700":"text-red-700"}`}>{$(netPos)}</p><p className="text-xs text-stone-400">AR + MRR - AP</p></div></div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5 mb-6"><div className="flex items-center justify-between mb-3"><h3 className="text-sm font-semibold text-stone-700 fs">{isM?"6-Month":"8-Week"} Forecast</h3><div className="flex bg-stone-100 rounded-lg p-0.5">{["Monthly","Weekly"].map(p=><button key={p} onClick={()=>sCfPd(p)} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${cfPd===p?"bg-white text-stone-900 shadow-sm":"text-stone-500 hover:text-stone-700"}`}>{p}</button>)}</div></div><p className="text-xs text-stone-400 mb-3">Includes {$(isM?mrrTotal:mrrTotal*12/52)}/{isM?"mo":"wk"} recurring income</p><ResponsiveContainer width="100%" height={200}><BarChart data={bars}><CartesianGrid strokeDasharray="3 3" stroke="#f5f5f4" vertical={false}/><XAxis dataKey="m" tick={{fontSize:11,fill:"#78716c"}} axisLine={false} tickLine={false}/><YAxis tick={{fontSize:11,fill:"#78716c"}} axisLine={false} tickLine={false} width={50} tickFormatter={v=>`$${v/1e3}k`}/><Tooltip formatter={v=>$(v)} contentStyle={{borderRadius:10,border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",fontSize:13}}/><Bar dataKey="i" fill="#10b981" radius={[4,4,0,0]} name="Incoming"/><Bar dataKey="o" fill="#ef4444" radius={[4,4,0,0]} name="Outgoing"/></BarChart></ResponsiveContainer>{(noDueIn>0||noDueOut>0)&&<p className="text-xs text-stone-400 mt-3 text-center">Not shown: {noDueIn>0&&<span>{$(noDueIn)} receivable</span>}{noDueIn>0&&noDueOut>0&&", "}{noDueOut>0&&<span>{$(noDueOut)} payable</span>} with no due date</p>}</div><div className="grid grid-cols-2 gap-6"><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">Accounts Receivable</h3>{arDue.length?arDue.sort((a,b)=>(a.due||"9").localeCompare(b.due||"9")).map(i=><div key={i.id} className={`flex justify-between py-2 border-b border-stone-100${i.due&&i.due<todayStr?" text-red-700":""}`}><div><span className="text-sm font-medium">{i.id}</span><span className="text-sm text-stone-500 ml-2">{i.cl}</span></div><div className="text-right"><span className="text-sm font-medium fm">{$(i.am)}</span><span className="block text-xs text-stone-400">{i.due||"No due date"}</span></div></div>):<p className="text-sm text-stone-400 text-center py-4">No outstanding invoices</p>}{SUBS.length>0&&<div className="mt-4 pt-4 border-t border-stone-200"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-2">Recurring Income</h4>{SUBS.map(a=><div key={a.id} className="flex justify-between py-2 border-b border-stone-100"><div><span className="text-sm font-medium">{a.app}</span><span className="text-xs text-stone-400 ml-2">{a.platform}</span></div><div className="text-right"><span className="text-sm font-medium fm">{$(a.mrr)}</span><span className="block text-xs text-stone-400">/month</span></div></div>)}<div className="flex justify-between py-2 font-semibold"><span className="text-sm">Total MRR</span><span className="fm">{$(mrrTotal)}</span></div></div>}</div><div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-5"><h3 className="text-sm font-semibold text-stone-700 mb-3 fs">Accounts Payable</h3>{apDue.length?apDue.sort((a,b)=>(a.due||"9").localeCompare(b.due||"9")).map(e=><div key={e.id} className={`flex justify-between py-2 border-b border-stone-100${e.due&&e.due<todayStr?" text-red-700":""}`}><div><span className="text-sm font-medium">{e.d}</span>{e.invNo&&<span className="text-xs text-stone-400 ml-2">#{e.invNo}</span>}{e.sup&&<span className="text-xs text-stone-500 ml-2">{e.sup}</span>}</div><div className="text-right"><span className="text-sm font-medium fm">{$(e.am)}</span><span className="block text-xs text-stone-400">{e.due||"No due date"}</span></div></div>):<p className="text-sm text-stone-400 text-center py-4">No unpaid expenses</p>}</div></div></div>})()}
  {t==="GST Return"&&(()=>{const gInv=INV.filter(i=>i.st==="Paid").reduce((s,i)=>s+i.gst,0);const gSub=SUBS.reduce((s,a)=>s+(a.gstJan||0),0);const gCol=gInv+gSub;const gPaid=EXP.reduce((s,e)=>s+(e.gst||0),0);const gDue=gCol-gPaid;return<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6"><h3 className="text-sm font-semibold text-stone-700 mb-1 fs">GST Summary</h3><p className="text-xs text-stone-400 mb-6">Computed from data</p><div className="space-y-4"><div className="p-4 bg-stone-50 rounded-lg">{[["Collected (Invoices)",gInv],["Collected (Subs)",gSub]].map(([l,v])=><div key={l} className="flex justify-between mb-2"><span className="text-sm text-stone-600">{l}</span><span className="text-sm font-medium fm">{$(v)}</span></div>)}<div className="flex justify-between pt-2 border-t border-stone-200 font-semibold"><span className="text-sm">Total Collected</span><span className="fm">{$(gCol)}</span></div></div><div className="p-4 bg-stone-50 rounded-lg"><div className="flex justify-between"><span className="text-sm text-stone-600">GST Paid (Expenses)</span><span className="text-sm font-medium fm">{$(gPaid)}</span></div></div><div className={`p-4 ${gDue>0?"bg-amber-50 border border-amber-200":"bg-emerald-50 border border-emerald-200"} rounded-lg`}><div className="flex justify-between font-semibold"><span className={gDue>0?"text-amber-900":"text-emerald-900"}>{gDue>0?"To Pay IRD":"Refund Due"}</span><span className={gDue>0?"text-amber-900":"text-emerald-900"}>{$(Math.abs(gDue))}</span></div></div></div></div>})()}
  {t==="Tax Summary"&&(()=>{const invInc=INV.filter(i=>i.st==="Paid").reduce((s,i)=>s+(i.am-i.gst),0);const subInc=SUBS.reduce((s,a)=>s+(a.grossJan||0)*12,0);const ttInc=invInc+subInc;const dedMap={};EXP.forEach(e=>{const k=e.cat||"Other";dedMap[k]=(dedMap[k]||0)+e.am});dedMap["Stripe Fees"]=(dedMap["Stripe Fees"]||0)+sf;const tkm=TRIPS.reduce((s,t)=>s+t.km,0);dedMap["Vehicle"]=(dedMap["Vehicle"]||0)+tkm*(DEDS.vehicle?.tier1||1.17);const hoD=HOEX.reduce((s,e)=>s+e.d,0);dedMap["Home Office"]=(dedMap["Home Office"]||0)+hoD;const ttDed=Object.values(dedMap).reduce((s,v)=>s+v,0);return<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6"><h3 className="text-sm font-semibold text-stone-700 mb-1 fs">Tax Year Summary</h3><p className="text-xs text-stone-400 mb-6">YTD · Computed from data</p><div className="space-y-4"><div className="p-4 bg-stone-50 rounded-lg"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-3">Income</h4>{[["Invoices (excl GST)",invInc],["Subscriptions (est. annual)",subInc]].map(([l,v])=><div key={l} className="flex justify-between py-1.5"><span className="text-sm text-stone-600">{l}</span><span className="text-sm font-medium fm">{$(v)}</span></div>)}<div className="flex justify-between pt-2 border-t border-stone-200 font-semibold"><span className="text-sm">Total</span><span className="fm">{$(ttInc)}</span></div></div><div className="p-4 bg-stone-50 rounded-lg"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-3">Deductions</h4>{Object.entries(dedMap).map(([k,v])=><div key={k} className="flex justify-between py-1.5"><span className="text-sm text-stone-600">{k}</span><span className="text-sm font-medium fm">{$(v)}</span></div>)}<div className="flex justify-between pt-2 border-t border-stone-200 font-semibold"><span className="text-sm">Total</span><span className="fm">{$(ttDed)}</span></div></div><div className={`p-4 rounded-lg ${(ttInc-ttDed)>=0?"bg-emerald-50 border border-emerald-200":"bg-red-50 border border-red-200"}`}><div className="flex justify-between font-semibold"><span className={(ttInc-ttDed)>=0?"text-emerald-900":"text-red-900"}>Net Taxable</span><span className={`fm ${(ttInc-ttDed)>=0?"text-emerald-900":"text-red-900"}`}>{$(ttInc-ttDed)}</span></div></div></div></div>})()}
  {t==="Job Profitability"&&(()=>{const jd=JOBS.map(j=>{const r=j.v||0;const e=EXP.filter(x=>x.job===j.t).reduce((s,x)=>s+x.am,0);return{t:j.t,r,e}}).filter(j=>j.r>0||j.e>0);return<div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50"><th className="text-left text-xs font-medium text-stone-500 uppercase px-5 py-3">Job</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Revenue</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Costs</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Profit</th><th className="text-right text-xs font-medium text-stone-500 uppercase px-5 py-3">Margin</th></tr></thead><tbody>{jd.length?jd.map((j,i)=><tr key={i} className="border-b border-stone-100"><td className="px-5 py-3.5 text-sm font-medium">{j.t}</td><td className="px-5 py-3.5 text-right text-sm font-medium fm">{$(j.r)}</td><td className="px-5 py-3.5 text-right text-sm text-red-600 fm">{$(j.e)}</td><td className="px-5 py-3.5 text-right text-sm font-medium text-emerald-700 fm">{$(j.r-j.e)}</td><td className="px-5 py-3.5 text-right text-sm">{j.r>0?((j.r-j.e)/j.r*100).toFixed(0):0}%</td></tr>):<tr><td colSpan={5} className="px-5 py-8 text-center text-sm text-stone-400">No job data yet</td></tr>}</tbody></table></div>})()}
</div>}

function SetPg({toast,setView,setPg,reload}){const[t,sT]=useState("business");
const[biz,sBiz]=useState({tradingName:BIZ.tradingName||"",legalName:BIZ.legalName||"",gstNumber:BIZ.gstNumber||"",irdNumber:BIZ.irdNumber||"",bankAccount:BIZ.bankAccount||"",email:BIZ.email||"",logo:BIZ.logo||""});
const[inv,sInv]=useState({prefix:INVSET.prefix||"SHMAKE-",nextNumber:INVSET.nextNumber||1,terms:INVSET.terms||"20th following",gstPercent:INVSET.gstPercent||15,defaultNote:INVSET.defaultNote||""});
const[ded,sDed]=useState({homeOffice:{officeSqm:DEDS.homeOffice?.officeSqm||0,totalSqm:DEDS.homeOffice?.totalSqm||0},vehicle:{method:DEDS.vehicle?.method||"IRD Km Rate",type:DEDS.vehicle?.type||"Petrol",tier1:DEDS.vehicle?.tier1||1.17,tier2:DEDS.vehicle?.tier2||0.37},phonePercent:DEDS.phonePercent||50,internetPercent:DEDS.internetPercent||10});
const hoPct=ded.homeOffice.totalSqm>0?Math.round(ded.homeOffice.officeSqm/ded.homeOffice.totalSqm*100):0;
const[cats,sCats]=useState({income:[...ICATEGORIES],expense:[...ECATEGORIES],jobTypes:[...JTYPES],contactTypes:[...CTYPES]});
const[newCat,sNewCat]=useState({income:"",expense:"",jobTypes:"",contactTypes:""});
const ub=(k,v)=>sBiz(p=>({...p,[k]:v}));
const ui=(k,v)=>sInv(p=>({...p,[k]:v}));
return<div><h1 className="text-2xl font-bold text-stone-900 fs mb-6">Settings</h1><div className="flex gap-6"><div className="w-48 flex-shrink-0 space-y-0.5">{[["business","Business"],["invoicing","Invoicing"],["deductions","Deductions"],["categories","Categories"],["data","Data"]].map(([k,l])=><button key={k} onClick={()=>sT(k)} className={`w-full text-left px-3 py-2 text-sm rounded-lg ${t===k?"bg-stone-200 text-stone-900 font-medium":"text-stone-500 hover:bg-stone-100"}`}>{l}</button>)}</div><div className="flex-1 bg-white shadow-sm border border-stone-200/60 rounded-xl p-6">
  {t==="business"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Business Details</h3><div className="grid grid-cols-2 gap-4"><FF l="Trading Name"><I value={biz.tradingName} onChange={e=>ub("tradingName",e.target.value)}/></FF><FF l="Legal Name"><I value={biz.legalName} onChange={e=>ub("legalName",e.target.value)}/></FF><FF l="GST #"><I value={biz.gstNumber} onChange={e=>ub("gstNumber",e.target.value)}/></FF><FF l="IRD #"><I value={biz.irdNumber} onChange={e=>ub("irdNumber",e.target.value)}/></FF><FF l="Bank"><I value={biz.bankAccount} onChange={e=>ub("bankAccount",e.target.value)}/></FF><FF l="Email"><I value={biz.email} onChange={e=>ub("email",e.target.value)}/></FF></div><FF l="Logo"><ImgUp value={biz.logo} onChange={v=>ub("logo",v)} h={100}/></FF><div className="pt-4"><B icon={CheckCircle} onClick={async()=>{await db.updateSiteContent("business",biz);await reload();toast("Saved","success")}}>Save</B></div></div>}
  {t==="invoicing"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Invoice Settings</h3><div className="grid grid-cols-2 gap-4"><FF l="Prefix"><I value={inv.prefix} onChange={e=>ui("prefix",e.target.value)}/></FF><FF l="Next #"><I type="number" value={inv.nextNumber} onChange={e=>ui("nextNumber",parseInt(e.target.value)||1)}/></FF><FF l="Terms"><S value={inv.terms} onChange={e=>ui("terms",e.target.value)} options={["7 days","14 days","20th following","30 days"]}/></FF><FF l="GST %"><I type="number" value={inv.gstPercent} onChange={e=>ui("gstPercent",parseFloat(e.target.value)||0)}/></FF></div><FF l="Default Note" h="On every invoice"><T value={inv.defaultNote} onChange={e=>ui("defaultNote",e.target.value)}/></FF><div className="pt-4"><B icon={CheckCircle} onClick={async()=>{await db.updateSiteContent("invoicing",inv);await reload();toast("Saved","success")}}>Save</B></div></div>}
  {t==="deductions"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Tax Deductions</h3><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-6"><div className="flex items-center gap-2 mb-3"><Home size={16}className="text-stone-600"/><h4 className="text-sm font-semibold text-stone-700">Home Office</h4></div><div className="grid grid-cols-3 gap-4"><FF l="Office (m²)"><I type="number" value={ded.homeOffice.officeSqm} onChange={e=>sDed(p=>({...p,homeOffice:{...p.homeOffice,officeSqm:parseFloat(e.target.value)||0}}))}/></FF><FF l="Total (m²)"><I type="number" value={ded.homeOffice.totalSqm} onChange={e=>sDed(p=>({...p,homeOffice:{...p.homeOffice,totalSqm:parseFloat(e.target.value)||0}}))}/></FF><FF l="Biz %"><div className="px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm font-medium">{hoPct}%</div></FF></div></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 mb-6"><div className="flex items-center gap-2 mb-3"><Car size={16}className="text-stone-600"/><h4 className="text-sm font-semibold text-stone-700">Vehicle</h4></div><FF l="Method"><S value={ded.vehicle.method} onChange={e=>sDed(p=>({...p,vehicle:{...p.vehicle,method:e.target.value}}))} options={["IRD Km Rate","Actual + %"]}/></FF><FF l="Type"><S value={ded.vehicle.type} onChange={e=>sDed(p=>({...p,vehicle:{...p.vehicle,type:e.target.value}}))} options={["Petrol","Diesel","Hybrid","Electric"]}/></FF><div className="grid grid-cols-2 gap-4"><FF l="Tier 1 (≤14k km)"><I type="number" value={ded.vehicle.tier1} onChange={e=>sDed(p=>({...p,vehicle:{...p.vehicle,tier1:parseFloat(e.target.value)||0}}))}/></FF><FF l="Tier 2 (>14k km)"><I type="number" value={ded.vehicle.tier2} onChange={e=>sDed(p=>({...p,vehicle:{...p.vehicle,tier2:parseFloat(e.target.value)||0}}))}/></FF></div></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200"><div className="flex items-center gap-2 mb-3"><Wifi size={16}className="text-stone-600"/><h4 className="text-sm font-semibold text-stone-700">Other</h4></div><div className="grid grid-cols-2 gap-4"><FF l="Phone %"><I type="number" value={ded.phonePercent} onChange={e=>sDed(p=>({...p,phonePercent:parseInt(e.target.value)||0}))}/></FF><FF l="Internet %"><I type="number" value={ded.internetPercent} onChange={e=>sDed(p=>({...p,internetPercent:parseInt(e.target.value)||0}))}/></FF></div></div><div className="pt-4"><B icon={CheckCircle} onClick={async()=>{const d={...ded,homeOffice:{...ded.homeOffice,percent:hoPct}};await db.updateSiteContent("deductions",d);await reload();toast("Saved","success")}}>Save</B></div></div>}
  {t==="categories"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Categories</h3>{[["Income","income",cats.income],["Expense","expense",cats.expense],["Job Types","jobTypes",cats.jobTypes],["Contact","contactTypes",cats.contactTypes]].map(([l,k,items])=><div key={k} className="mb-6"><h4 className="text-xs font-semibold text-stone-500 uppercase mb-2">{l}</h4><div className="flex flex-wrap gap-2 mb-2">{items.map(i=><span key={i} className="inline-flex items-center gap-1.5 text-sm bg-stone-100 text-stone-700 px-3 py-1.5 rounded-lg">{i}<button className="text-stone-400 hover:text-red-500" onClick={async()=>{const updated={...cats,[k]:cats[k].filter(x=>x!==i)};sCats(updated);await db.updateSiteContent("categories",updated);await reload();toast(`Removed "${i}"`,"info")}}><X size={12}/></button></span>)}</div><div className="flex gap-2"><I value={newCat[k]||""} onChange={e=>sNewCat(p=>({...p,[k]:e.target.value}))} placeholder={`New ${l.toLowerCase()}...`}/><B vr="ghost" sz="sm" icon={Plus} onClick={async()=>{const v=(newCat[k]||"").trim();if(!v)return;const updated={...cats,[k]:[...cats[k],v]};sCats(updated);sNewCat(p=>({...p,[k]:""}));await db.updateSiteContent("categories",updated);await reload();toast("Added","success")}}>Add</B></div></div>)}</div>}
  {t==="data"&&<div><h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Data & Export</h3><div className="space-y-4"><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 flex items-center justify-between"><div><p className="text-sm font-medium text-stone-700">Export All</p><p className="text-xs text-stone-400">CSV of everything</p></div><B vr="secondary" sz="sm" icon={Download} onClick={()=>toast("Exported","success")}>Export</B></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 flex items-center justify-between"><div><p className="text-sm font-medium text-stone-700">Bank Statement</p><p className="text-xs text-stone-400">ASB, Westpac, ANZ, BNZ CSV</p></div><B vr="secondary" sz="sm" icon={Upload} onClick={()=>{setPg("bank");setView(null)}}>Go to Bank</B></div><div className="p-4 bg-stone-50 rounded-lg border border-stone-200 flex items-center justify-between"><div><p className="text-sm font-medium text-stone-700">Stripe Transactions</p><p className="text-xs text-stone-400">Balance / payouts</p></div><B vr="secondary" sz="sm" icon={Upload} onClick={()=>setView("stripe")}>Import</B></div></div></div>}
</div></div></div>}

/* === PORTFOLIO PAGE === */
const GRADS=["gradient-amber","gradient-cyan","gradient-slate","gradient-pink","gradient-emerald","gradient-violet","gradient-rose","gradient-blue","gradient-orange","gradient-teal","gradient-indigo","gradient-lime","gradient-fuchsia","gradient-sky","gradient-red","gradient-yellow","gradient-green","gradient-purple","gradient-stone","gradient-zinc"];
const GCC={amber:"#f59e0b",cyan:"#06b6d4",slate:"#64748b",pink:"#ec4899",emerald:"#10b981",violet:"#8b5cf6",rose:"#f43f5e",blue:"#3b82f6",orange:"#f97316",teal:"#14b8a6",indigo:"#6366f1",lime:"#84cc16",fuchsia:"#d946ef",sky:"#0ea5e9",red:"#ef4444",yellow:"#eab308",green:"#22c55e",purple:"#a855f7",stone:"#78716c",zinc:"#71717a"};
const grc=g=>GCC[(g||"").replace("gradient-","")]||"#78716c";

function ProjF({item,isNew,c,toast,cats,onSave}){
  const[f,sF]=useState({title:item?.title||"",category:Array.isArray(item?.category)?item.category[0]:item?.category||"",description:item?.description||"",longDescription:item?.longDescription||"",gradient:item?.gradient||"gradient-amber",year:item?.year||"",started:item?.started||"",image:item?.image||"",gallery:item?.gallery||[],specs:item?.specs||[]});
  const[ns,sNs]=useState("");const galRef=useRef(null);
  const u=(k,v)=>sF(p=>({...p,[k]:v}));
  return<div>
    <FF l="Title"><I value={f.title} onChange={e=>u("title",e.target.value)} placeholder="Project name"/></FF>
    <FF l="Category"><S value={f.category} onChange={e=>u("category",e.target.value)} options={cats} ph="— Select —"/></FF>
    <FF l="Short Description"><T value={f.description} onChange={e=>u("description",e.target.value)} placeholder="One-liner for card"/></FF>
    <FF l="Long Description"><T value={f.longDescription} onChange={e=>u("longDescription",e.target.value)} placeholder="Expanded detail for modal"/></FF>
    <div className="grid grid-cols-2 gap-4"><FF l="Year"><I value={f.year} onChange={e=>u("year",e.target.value)} placeholder="2025 or Ongoing"/></FF><FF l="Started"><I type="number" value={f.started} onChange={e=>u("started",e.target.value)} placeholder="2023"/></FF></div>
    <FF l="Gradient"><div className="flex flex-wrap gap-1.5 p-3 bg-stone-50 rounded-lg border border-stone-200">{GRADS.map(g=><button key={g} type="button" onClick={()=>u("gradient",g)} className={`w-7 h-7 rounded-lg border-2 transition-all ${f.gradient===g?"border-stone-900 scale-110":"border-transparent hover:border-stone-300"}`} style={{background:grc(g)}} title={g.replace("gradient-","")}/>)}</div></FF>
    <FF l="Hero Image"><ImgUp value={f.image} onChange={v=>u("image",v)}/></FF>
    <FF l="Gallery"><div className="grid grid-cols-4 gap-2">{f.gallery.map((url,i)=><ImgUp key={i} value={url} h={80} onChange={v=>{if(v){const g=[...f.gallery];g[i]=v;u("gallery",g)}else{u("gallery",f.gallery.filter((_,j)=>j!==i))}}}/>)}<div className="border-2 border-dashed border-stone-300 rounded-lg flex flex-col items-center justify-center hover:border-amber-400 cursor-pointer" style={{height:80}} onClick={()=>galRef.current?.click()}><Plus size={16}className="text-stone-400 mb-0.5"/><p className="text-[10px] text-stone-500">Add</p></div></div><input ref={galRef} type="file" accept="image/*" className="hidden" onChange={async e=>{const file=e.target.files?.[0];if(file){const url=await db.uploadFile(file,"gallery");if(url)u("gallery",[...f.gallery,url])}e.target.value=""}}/></FF>
    <FF l="Specs">{f.specs.length>0&&<div className="flex flex-wrap gap-1.5 mb-2">{f.specs.map((s,i)=><span key={i} className="inline-flex items-center gap-1 text-xs bg-stone-100 text-stone-700 px-2.5 py-1 rounded-lg">{s}<button onClick={()=>u("specs",f.specs.filter((_,j)=>j!==i))} className="text-stone-400 hover:text-red-500"><X size={12}/></button></span>)}</div>}<div className="flex gap-2"><I value={ns} onChange={e=>sNs(e.target.value)} placeholder="e.g. React, Supabase"/><B vr="secondary" sz="sm" icon={Plus} onClick={()=>{if(ns){u("specs",[...f.specs,ns]);sNs("")}}}>Add</B></div></FF>
    <div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?Plus:CheckCircle} onClick={async()=>{if(isNew)await db.createPortfolioProject(f);else await db.updatePortfolioProject(item.id,f);if(onSave)await onSave();toast(isNew?"Project added":"Project updated","success");c()}}>{isNew?"Add Project":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deletePortfolioProject(item.id);if(onSave)await onSave();toast("Deleted","info");c()}}>Delete</B>}</div>
  </div>}

function HeroF({item,isNew,c,toast,onSave}){
  const[f,sF]=useState({key:item?.key||"",title:item?.title||"",logo:item?.logo||"",screenshot:item?.screenshot||"",description:item?.description||"",linkText:item?.linkText||"",linkHref:item?.linkHref||"",isInternal:item?.isInternal||false,initiallyExpanded:item?.initiallyExpanded||false,bgStyle:item?.bgStyle||""});
  const u=(k,v)=>sF(p=>({...p,[k]:v}));
  return<div>
    <FF l="Key" h="URL-safe identifier"><I value={f.key} onChange={e=>u("key",e.target.value)} placeholder="my-project"/></FF>
    <FF l="Title"><I value={f.title} onChange={e=>u("title",e.target.value)} placeholder="Project Name"/></FF>
    <div className="grid grid-cols-2 gap-4"><FF l="Logo"><ImgUp value={f.logo} onChange={v=>u("logo",v)} h={100}/></FF><FF l="Screenshot"><ImgUp value={f.screenshot} onChange={v=>u("screenshot",v)} h={100}/></FF></div>
    <FF l="Description" h="Supports <strong> HTML"><T value={f.description} onChange={e=>u("description",e.target.value)} placeholder="Card description..."/></FF>
    <div className="grid grid-cols-2 gap-4"><FF l="Link Text"><I value={f.linkText} onChange={e=>u("linkText",e.target.value)} placeholder="Visit →"/></FF><FF l="Link URL"><I value={f.linkHref} onChange={e=>u("linkHref",e.target.value)} placeholder="https://..."/></FF></div>
    <div className="space-y-3 my-4"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={f.isInternal} onChange={e=>u("isInternal",e.target.checked)} className="rounded border-stone-300 text-amber-600"/><span className="text-sm text-stone-700">Internal link (scrolls on page)</span></label><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={f.initiallyExpanded} onChange={e=>u("initiallyExpanded",e.target.checked)} className="rounded border-stone-300 text-amber-600"/><span className="text-sm text-stone-700">Initially expanded</span></label></div>
    <FF l="Background Style" h="CSS background property"><T value={f.bgStyle} onChange={e=>u("bgStyle",e.target.value)} placeholder="linear-gradient(...), url('...')"/></FF>
    {f.bgStyle&&<div className="mb-5 rounded-lg overflow-hidden border border-stone-200"><div className="h-20 flex items-center justify-center" style={{background:f.bgStyle}}><span className="text-white text-sm font-medium drop-shadow-sm">{f.title||"Preview"}</span></div></div>}
    <div className="flex gap-3 pt-4 border-t border-stone-200 mt-6"><B icon={isNew?Plus:CheckCircle} onClick={async()=>{if(isNew)await db.createHeroCard(f);else await db.updateHeroCard(item.id,f);if(onSave)await onSave();toast(isNew?"Card added":"Card updated","success");c()}}>{isNew?"Add Card":"Save"}</B><B vr="ghost" onClick={c}>Cancel</B>{!isNew&&<B vr="danger" icon={Trash2} onClick={async()=>{await db.deleteHeroCard(item.id);if(onSave)await onSave();toast("Removed","info");c()}}>Delete</B>}</div>
  </div>}

function PortfolioPg({toast}){
  const[tab,sTab]=useState("Projects");
  const[data,setData]=useState(null);
  const[q,sQ]=useState("");
  const[editing,setEditing]=useState(null);
  const[heroCards,setHeroCards]=useState([]);
  const[about,setAbout]=useState({name:"",photo:"",tagline:"",taglineSub:"",bio:[],skills:[]});
  const[contact,setContact]=useState({formAction:"",recaptchaSiteKey:"",heading:"",subheading:"",socials:[]});
  const[siteMeta,setSiteMeta]=useState({title:"",gaId:""});
  const[skillIn,setSkillIn]=useState({});
  const{sort,toggle,sorted}=useSort("id","desc");

  useEffect(()=>{loadProjects().then(setData);db.listHeroCards().then(setHeroCards);db.getSiteContent().then(sc=>{if(sc){if(sc.about)setAbout({...sc.about,bio:sc.about.bio||[],skills:(sc.about.skills||[]).map(s=>({...s,items:[...s.items]}))});if(sc.contact)setContact({...sc.contact,socials:(sc.contact.socials||[]).map(s=>({...s}))});if(sc.meta)setSiteMeta(sc.meta)}})},[]);

  const closeEdit=()=>setEditing(null);
  const editTitle=editing?(editing.isNew?`New ${editing.type==="project"?"Project":"Hero Card"}`:`Edit ${editing.type==="project"?"Project":"Hero Card"}`):"";

  if(!data)return<p className="text-sm text-stone-400">Loading portfolio...</p>;

  const projects=data.projects.filter(p=>p.id!==0);
  const fil=q?projects.filter(p=>(p.title+(p.category||"")+(p.description||"")).toLowerCase().includes(q.toLowerCase())):projects;
  const sl=sorted(fil,(x,k)=>({id:x.id,title:x.title,category:Array.isArray(x.category)?x.category[0]:x.category,year:x.year}[k]));

  return<div>
    <div className="flex items-center justify-between mb-6">
      <div><h1 className="text-2xl font-bold text-stone-900 fs">Portfolio</h1><p className="text-sm text-stone-500 mt-1">{projects.length} projects · {data.categories.length-1} categories · {heroCards.length} hero cards</p></div>
      <a href="/" target="_blank" rel="noopener"><B vr="secondary" sz="sm" icon={Eye}>View Site</B></a>
    </div>
    <Tabs items={["Projects","Hero Cards","About","Contact & Meta"]} active={tab} onChange={sTab}/>

    {tab==="Projects"&&<div>
      <SearchBar value={q} onChange={sQ} placeholder="Search projects..."><B sz="sm" icon={Plus} onClick={()=>setEditing({type:"project",item:null,isNew:true})}>Add Project</B></SearchBar>
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-stone-200 bg-stone-50">
        <SortTh sortKey="id" sort={sort} toggle={toggle} align="center">#</SortTh>
        <SortTh sortKey="title" sort={sort} toggle={toggle}>Project</SortTh>
        <SortTh sortKey="category" sort={sort} toggle={toggle}>Category</SortTh>
        <SortTh sortKey="year" sort={sort} toggle={toggle}>Year</SortTh>
        <th className="text-center text-xs font-medium text-stone-500 uppercase px-5 py-3">Image</th>
        <th className="text-center text-xs font-medium text-stone-500 uppercase px-5 py-3">Gallery</th>
        <th className="w-10"></th>
      </tr></thead>
      <tbody>{sl.length?sl.map(p=><tr key={p.id} className="border-b border-stone-100 hover:bg-stone-50 cursor-pointer" onClick={()=>setEditing({type:"project",item:p,isNew:false})}>
        <td className="px-5 py-3.5 text-center text-xs text-stone-400 fm">{p.id}</td>
        <td className="px-5 py-3.5"><div className="flex items-center gap-2.5"><div className="w-3 h-3 rounded-full flex-shrink-0" style={{background:grc(p.gradient)}}/><div><p className="text-sm font-medium text-stone-800">{p.title}</p><p className="text-xs text-stone-400 max-w-sm truncate">{p.description}</p></div></div></td>
        <td className="px-5 py-3.5"><span className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{Array.isArray(p.category)?p.category.join(", "):p.category||"—"}</span></td>
        <td className="px-5 py-3.5 text-sm text-stone-500">{p.year}</td>
        <td className="px-5 py-3.5 text-center">{p.image?<CheckCircle size={16}className="mx-auto text-emerald-500"/>:<Circle size={16}className="mx-auto text-stone-300"/>}</td>
        <td className="px-5 py-3.5 text-center text-sm text-stone-500">{p.gallery?.length||0}</td>
        <td className="px-3"><button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={e=>{e.stopPropagation();setEditing({type:"project",item:p,isNew:false})}}><Edit3 size={14}/></button></td>
      </tr>):<tr><td colSpan={7} className="px-5 py-8 text-center text-sm text-stone-400">No projects found</td></tr>}</tbody></table></div>
    </div>}

    {tab==="Hero Cards"&&<div>
      <div className="flex items-center justify-between mb-6"><p className="text-sm text-stone-500">{heroCards.length} cards · first card is initially expanded on the public site</p><B sz="sm" icon={Plus} onClick={()=>setEditing({type:"hero",item:null,isNew:true})}>Add Card</B></div>
      <div className="space-y-3">{heroCards.map((card,i)=><div key={card.key} className="bg-white shadow-sm border border-stone-200/60 rounded-xl overflow-hidden hover:border-stone-300">
        <div className="flex">
          <div className="w-32 flex-shrink-0 relative" style={{background:card.bgStyle,minHeight:100}}>{card.logo&&<img src={`/${card.logo}`} alt="" className="absolute inset-0 m-auto w-12 h-12 object-contain drop-shadow-sm opacity-80"/>}</div>
          <div className="flex-1 p-4">
            <div className="flex items-start justify-between">
              <div className="flex-1 min-w-0"><h3 className="text-sm font-semibold text-stone-800">{card.title}</h3><p className="text-xs text-stone-500 mt-0.5 line-clamp-2">{card.description.replace(/<[^>]*>/g,"")}</p></div>
              <div className="flex items-center gap-1 ml-3 flex-shrink-0">
                {i>0&&<button className="p-1 rounded hover:bg-stone-100 text-stone-400 text-sm" onClick={()=>toast("Moved up","success")} title="Move up">↑</button>}
                {i<heroCards.length-1&&<button className="p-1 rounded hover:bg-stone-100 text-stone-400 text-sm" onClick={()=>toast("Moved down","success")} title="Move down">↓</button>}
                <button className="p-1 rounded hover:bg-stone-100 text-stone-400" onClick={()=>setEditing({type:"hero",item:card,isNew:false})}><Edit3 size={14}/></button>
              </div>
            </div>
            <div className="flex items-center gap-2 mt-2 flex-wrap">
              <span className="text-xs text-stone-400">{card.linkText}</span>
              {card.isInternal&&<span className="text-xs bg-stone-100 text-stone-500 px-1.5 py-0.5 rounded">internal</span>}
              {card.initiallyExpanded&&<span className="text-xs bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded">expanded</span>}
            </div>
          </div>
        </div>
      </div>)}</div>
    </div>}

    {tab==="About"&&<div className="max-w-2xl">
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6 mb-6">
        <h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Profile</h3>
        <FF l="Name"><I value={about.name} onChange={e=>setAbout({...about,name:e.target.value})}/></FF>
        <FF l="Photo"><ImgUp value={about.photo} onChange={v=>setAbout({...about,photo:v})}/></FF>
        <FF l="Tagline"><I value={about.tagline} onChange={e=>setAbout({...about,tagline:e.target.value})}/></FF>
        <FF l="Tagline Sub"><I value={about.taglineSub} onChange={e=>setAbout({...about,taglineSub:e.target.value})}/></FF>
      </div>
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6 mb-6">
        <div className="flex items-center justify-between mb-4"><h3 className="text-sm font-semibold text-stone-700 fs">Bio Paragraphs</h3><B vr="ghost" sz="sm" icon={Plus} onClick={()=>setAbout({...about,bio:[...about.bio,""]})}>Add Paragraph</B></div>
        {about.bio.map((p,i)=><div key={i} className="mb-3"><div className="flex items-start gap-2"><div className="flex-1"><label className="text-xs text-stone-400 mb-1 block">Paragraph {i+1}</label><T value={p} onChange={e=>{const b=[...about.bio];b[i]=e.target.value;setAbout({...about,bio:b})}}/></div>{about.bio.length>1&&<button className="mt-6 p-1 text-stone-400 hover:text-red-500" onClick={()=>setAbout({...about,bio:about.bio.filter((_,j)=>j!==i)})}><X size={14}/></button>}</div></div>)}
      </div>
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6 mb-6">
        <h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Skills Grid</h3>
        <div className="space-y-4">{about.skills.map((sk,si)=><div key={si} className="p-4 bg-stone-50 rounded-lg border border-stone-200">
          <FF l={`Category ${si+1} Title`}><I value={sk.title} onChange={e=>{const s=about.skills.map((x,xi)=>xi===si?{...x,title:e.target.value}:x);setAbout({...about,skills:s})}}/></FF>
          <div className="flex flex-wrap gap-1.5 mb-2">{sk.items.map((item,ii)=><span key={ii} className="inline-flex items-center gap-1 text-xs bg-white text-stone-700 px-2.5 py-1 rounded-lg border border-stone-200">{item}<button onClick={()=>{const s=about.skills.map((x,xi)=>xi===si?{...x,items:x.items.filter((_,j)=>j!==ii)}:x);setAbout({...about,skills:s})}} className="text-stone-400 hover:text-red-500"><X size={12}/></button></span>)}</div>
          <div className="flex gap-2"><I value={skillIn[si]||""} onChange={e=>setSkillIn({...skillIn,[si]:e.target.value})} placeholder="New skill..." onKeyDown={e=>{if(e.key==="Enter"&&skillIn[si]){const s=about.skills.map((x,xi)=>xi===si?{...x,items:[...x.items,skillIn[si]]}:x);setAbout({...about,skills:s});setSkillIn({...skillIn,[si]:""})}}}/><B vr="ghost" sz="sm" icon={Plus} onClick={()=>{if(skillIn[si]){const s=about.skills.map((x,xi)=>xi===si?{...x,items:[...x.items,skillIn[si]]}:x);setAbout({...about,skills:s});setSkillIn({...skillIn,[si]:""})}}}> </B></div>
        </div>)}</div>
      </div>
      <B icon={CheckCircle} onClick={async()=>{await db.updateSiteContent("about",about);toast("About saved","success")}}>Save About</B>
    </div>}

    {tab==="Contact & Meta"&&<div className="max-w-2xl">
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6 mb-6">
        <h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Contact Section</h3>
        <FF l="Heading"><I value={contact.heading} onChange={e=>setContact({...contact,heading:e.target.value})}/></FF>
        <FF l="Subheading"><I value={contact.subheading} onChange={e=>setContact({...contact,subheading:e.target.value})}/></FF>
        <div className="grid grid-cols-2 gap-4"><FF l="Form Action URL"><I value={contact.formAction} onChange={e=>setContact({...contact,formAction:e.target.value})}/></FF><FF l="reCAPTCHA Site Key"><I value={contact.recaptchaSiteKey} onChange={e=>setContact({...contact,recaptchaSiteKey:e.target.value})}/></FF></div>
      </div>
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6 mb-6">
        <div className="flex items-center justify-between mb-4"><h3 className="text-sm font-semibold text-stone-700 fs">Social Links</h3><B vr="ghost" sz="sm" icon={Plus} onClick={()=>setContact({...contact,socials:[...contact.socials,{type:"",url:"",label:""}]})}>Add</B></div>
        {contact.socials.map((s,i)=><div key={i} className="flex items-center gap-3 mb-3 p-3 bg-stone-50 rounded-lg border border-stone-200">
          <div className="grid grid-cols-3 gap-2 flex-1"><I value={s.type} onChange={e=>{const sl=contact.socials.map((x,xi)=>xi===i?{...x,type:e.target.value}:x);setContact({...contact,socials:sl})}} placeholder="Type (e.g. linkedin)"/><I value={s.url} onChange={e=>{const sl=contact.socials.map((x,xi)=>xi===i?{...x,url:e.target.value}:x);setContact({...contact,socials:sl})}} placeholder="URL"/><I value={s.label} onChange={e=>{const sl=contact.socials.map((x,xi)=>xi===i?{...x,label:e.target.value}:x);setContact({...contact,socials:sl})}} placeholder="Label"/></div>
          <button onClick={()=>setContact({...contact,socials:contact.socials.filter((_,j)=>j!==i)})} className="text-stone-400 hover:text-red-500 flex-shrink-0"><X size={16}/></button>
        </div>)}
      </div>
      <div className="bg-white shadow-sm border border-stone-200/60 rounded-xl p-6 mb-6">
        <h3 className="text-sm font-semibold text-stone-700 mb-4 fs">Site Metadata</h3>
        <div className="grid grid-cols-2 gap-4"><FF l="Site Title"><I value={siteMeta.title} onChange={e=>setSiteMeta({...siteMeta,title:e.target.value})}/></FF><FF l="GA Tracking ID"><I value={siteMeta.gaId} onChange={e=>setSiteMeta({...siteMeta,gaId:e.target.value})}/></FF></div>
      </div>
      <B icon={CheckCircle} onClick={async()=>{await db.updateSiteContent("contact",contact);await db.updateSiteContent("meta",siteMeta);toast("Contact & meta saved","success")}}>Save</B>
    </div>}


    <Sld open={!!editing} onClose={closeEdit} title={editTitle}>
      {editing?.type==="project"&&<ProjF item={editing.item} isNew={editing.isNew} c={closeEdit} toast={toast} cats={data.categories.filter(c=>c!=="All")} onSave={()=>loadProjects().then(setData)}/>}
      {editing?.type==="hero"&&<HeroF item={editing.item} isNew={editing.isNew} c={closeEdit} toast={toast} onSave={()=>db.listHeroCards().then(setHeroCards)}/>}
    </Sld>
  </div>
}

/* === NAV + APP === */
const NAV_SECTIONS=[
  {items:[{id:"dashboard",l:"Dashboard",ic:LayoutDashboard}]},
  {label:"Work",items:[{id:"enquiries",l:"Enquiries",ic:Mail},{id:"jobs",l:"Jobs",ic:Briefcase},{id:"quotes",l:"Quotes",ic:FileCheck}]},
  {label:"People",items:[{id:"clients",l:"Clients",ic:Users},{id:"contacts",l:"Contacts",ic:BookOpen}]},
  {label:"Money",items:[{id:"invoices",l:"Invoices",ic:FileText},{id:"subscriptions",l:"Subscriptions",ic:CreditCard},{id:"expenses",l:"Expenses",ic:Receipt},{id:"bank",l:"Bank",ic:FileSpreadsheet},{id:"budget",l:"Budget",ic:Target}]},
  {label:"Insights",items:[{id:"reports",l:"Reports",ic:PieChart}]},
  {items:[{id:"portfolio",l:"Portfolio",ic:Image},{id:"settings",l:"Settings",ic:Settings}]},
];
function navBadge(id){if(id==="jobs"){const c=JOBS.filter(j=>!["Closed","Invoiced","Complete"].includes(j.st)).length;return c||null}if(id==="invoices"){const c=INV.filter(i=>i.st==="Overdue").length;return c||null}if(id==="enquiries"){const c=ENQ.filter(e=>e.status==="New").length;return c||null}if(id==="bank"){const c=BANK.filter(b=>!b.rec).length;return c||null}return null}
const FT={job:["New Job","Edit Job"],quote:["New Quote","Edit Quote"],inv:["New Invoice","Edit Invoice"],exp:["Log Expense","Edit Expense"],contact:["New Contact","Edit Contact"],client:["New Client","Edit Client"],markPaid:["Record Payment","Record Payment"],incSrc:["Add Income Source","Add Income Source"],trip:["Log Trip","Edit Trip"],homeExp:["Home Expense","Edit Expense"],budget:["New Budget Item","Edit Budget Item"],mp:["Log Payment","Edit Payment"],enq:["View Enquiry","View Enquiry"],bankExp:["Create Expense","Create Expense"]};

export default function AdminLayout(){
  const[pg,sPg]=useState("dashboard");
  const[vw,sVw]=useState(null);
  const[sl,sSl]=useState({o:false,t:null,item:null});
  const{toast,Toasts}=useToast();
  const{user,signOut}=useAuth();
  const o=(t,item)=>sSl({o:true,t,item:item||null});const c=()=>sSl({o:false,t:null,item:null});const gb=()=>sVw(null);
  useEffect(()=>{const prev=document.title;document.title="SHMAKE Admin";return()=>{document.title=prev}},[]);
  const[loading,setLoading]=useState(true);const[,sv]=useState(0);
  const reload=useCallback(async()=>{const[j,cl,ct,qt,inv,exp,tr,ho,rec,str,sub,bk,sc,budg,mp,enq]=await Promise.all([db.listJobs(),db.listClients(),db.listContacts(),db.listQuotes(),db.listInvoices(),db.listExpenses(),db.listTrips(),db.listHomeOfficeExpenses(),db.listRecurringTemplates(),db.listStripeTransactions(),db.listSubscriptionSources(),db.listBankTransactions(),db.getSiteContent(),db.listBudgetItems(),db.listManualPayments(),db.listEnquiries()]);CL=cl;CT=ct;const cn=id=>cl.find(c=>c.id===id)?.n||"";const jn=id=>j.find(x=>x.id===id)?.t||"";JOBS=j.map(x=>({...x,cl:cn(x.clId)}));QT=qt.map(q=>({...q,cl:cn(q.clId),job:jn(q.jobId)}));INV=inv.map(i=>({...i,cl:cn(i.clId)}));const today=new Date().toISOString().slice(0,10);const od=INV.filter(i=>i.st==="Sent"&&i.due&&i.due<today);if(od.length){await db.markInvoicesOverdue(od.map(i=>i.id));od.forEach(i=>{i.st="Overdue"})}EXP=exp.map(e=>({...e,job:jn(e.jobId)}));RECTPL=rec.map(r=>({...r,cl:cn(r.clId)}));TRIPS=tr;HOEX=ho;STRP=str;SUBS=sub;BANK=bk;BUDGET=budg;MPAY=mp;ENQ=enq;REV=db.computeRevenue(INV,SUBS);EC=db.computeExpenseCategories(EXP);PNL=db.computePnl(INV,EXP,SUBS);DEDS=sc?.deductions||DEDS;BIZ=sc?.business||BIZ;INVSET=sc?.invoicing||INVSET;ECATEGORIES=sc?.categories?.expense||["Materials","Tools","Software","Vehicle","Home Office","Marketing","Processing","Other"];ICATEGORIES=sc?.categories?.income||["Invoicing","Subscriptions"];JTYPES=sc?.categories?.jobTypes||["Fabrication","Design","Consulting","Other"];CTYPES=sc?.categories?.contactTypes||["Supplier","Contractor","Trade","Professional","Other"];setLoading(false);sv(x=>x+1)},[]);
  useEffect(()=>{reload()},[reload]);

  const form=()=>{const it=sl.item;switch(sl.t){case"job":return<JobF c={c} item={it} toast={toast} reload={reload}/>;case"quote":return<QuoteF c={c} item={it} toast={toast} reload={reload}/>;case"inv":return<InvF c={c} item={it} toast={toast} reload={reload}/>;case"exp":return<ExpF c={c} item={it} toast={toast} reload={reload}/>;case"contact":return<ContactF c={c} item={it} toast={toast} reload={reload}/>;case"client":return<ClientF c={c} item={it} toast={toast} reload={reload}/>;case"markPaid":return<MarkPaidF c={c} toast={toast} item={it} reload={reload}/>;case"incSrc":return<IncSrcF c={c} toast={toast} reload={reload}/>;case"trip":return<TripF c={c} toast={toast} reload={reload}/>;case"homeExp":return<HomeExpF c={c} toast={toast} reload={reload}/>;case"budget":return<BudgetF c={c} item={it} toast={toast} reload={reload}/>;case"mp":return<MPF c={c} item={it} toast={toast} reload={reload}/>;case"enq":return<EnqF c={c} item={it} toast={toast} reload={reload}/>;case"bankExp":return<ExpF c={c} item={it} toast={toast} reload={reload}/>;default:return null}};

  const page=()=>{
    if(vw==="vehicle")return<VehicleV onBack={gb} o={o}/>;
    if(vw==="home")return<HomeV onBack={gb} o={o}/>;
    if(vw==="recurring")return<RecurV onBack={gb} toast={toast} reload={reload}/>;
    if(vw==="stripe")return<StripeV onBack={gb} toast={toast}/>;
    switch(pg){case"dashboard":return<Dash o={o}/>;case"jobs":return<JobsPg o={o}/>;case"clients":return<ClientsPg o={o}/>;case"contacts":return<ContactsPg o={o}/>;case"enquiries":return<EnqPg o={o}/>;case"quotes":return<QuotesPg o={o} toast={toast}/>;case"invoices":return<InvPg o={o} toast={toast} setView={sVw}/>;case"expenses":return<ExpPg o={o} setView={sVw}/>;case"subscriptions":return<SubsPg setView={sVw} o={o}/>;case"bank":return<BankRecPg o={o} toast={toast} reload={reload}/>;case"budget":return<BudgetPg o={o} toast={toast}/>;case"reports":return<RepPg toast={toast}/>;case"portfolio":return<PortfolioPg toast={toast}/>;case"settings":return<SetPg toast={toast} setView={sVw} setPg={sPg} reload={reload}/>}
  };

  if(loading)return<div className="flex h-screen items-center justify-center bg-stone-100"><div className="text-center"><div className="w-9 h-9 bg-amber-500 rounded-lg flex items-center justify-center mx-auto mb-4"><span className="text-sm font-bold text-white fm">S</span></div><p className="text-sm text-stone-500">Loading...</p></div></div>;
  return(<div className="flex h-screen bg-stone-100" style={{fontFamily:"'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif"}}>
    <div className="w-60 bg-stone-50 flex flex-col flex-shrink-0 border-r border-stone-200/60"><div className="px-5 py-5 border-b border-stone-200/60"><div className="flex items-center gap-3"><div className="w-9 h-9 bg-amber-500 rounded-lg flex items-center justify-center"><span className="text-sm font-bold text-white fm">S</span></div><div><h1 className="text-sm font-bold text-stone-900 tracking-wide fs">SHMAKE</h1><p className="text-xs text-stone-400">Admin</p></div></div></div>
      <nav className="flex-1 px-3 py-4 overflow-y-auto">{NAV_SECTIONS.map((sec,si)=><div key={si} className={si>0?"mt-4":""}>{sec.label&&<p className="px-3 mb-1 text-[10px] font-semibold uppercase tracking-widest text-stone-400">{sec.label}</p>}<div className="space-y-0.5">{sec.items.map(n=>{const a=pg===n.id&&!vw;const b=navBadge(n.id);return<button key={n.id} onClick={()=>{sPg(n.id);sVw(null)}} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all ${a?"bg-white text-stone-900 shadow-sm":"text-stone-500 hover:text-stone-700 hover:bg-white/60"}`}><n.ic size={18}className={a?"text-amber-500":""}/><span className="flex-1 text-left">{n.l}</span>{b&&<span className={`text-xs px-1.5 py-0.5 rounded-full ${a?"bg-amber-500/15 text-amber-600":"bg-stone-200/60 text-stone-500"}`}>{b}</span>}</button>})}</div></div>)}</nav>
      <div className="px-5 py-4 border-t border-stone-200/60">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 bg-stone-200 rounded-full flex items-center justify-center"><span className="text-xs font-semibold text-stone-600">{(user?.email||"?")[0].toUpperCase()}</span></div>
            <div><p className="text-sm font-medium text-stone-700 truncate max-w-[120px]">{user?.email?.split("@")[0]||"Admin"}</p><p className="text-xs text-stone-400">Sole Trader</p></div>
          </div>
          <button onClick={signOut} className="text-xs text-stone-400 hover:text-stone-600 transition-colors" title="Sign out">
            <ArrowLeft size={16}/>
          </button>
        </div>
      </div>
    </div>
    <div className="flex-1 overflow-y-auto"><div className="max-w-[1600px] mx-auto px-10 py-8">{page()}</div></div>
    <Sld open={sl.o} onClose={c} title={FT[sl.t]?(FT[sl.t][sl.item?1:0]):""} wide={sl.t==="quote"||sl.t==="inv"||sl.t==="exp"}>{form()}</Sld><Toasts/>
  </div>);
}
