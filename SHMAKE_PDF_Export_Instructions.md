# SHMAKE Admin — PDF Export Build Instructions

## Context

This is the SHMAKE admin system for a NZ sole trader (Sam). Stack is React + Vite + Tailwind. The UI is in `src/App.jsx` as a single-file component. We need PDF export functionality for invoices, quotes, and expense reports.

The system currently has mock data but will be backed by Supabase. Build the PDF generation as a standalone utility module (`src/lib/pdf.js`) that accepts data objects and returns downloadable PDFs. Wire the existing "PDF" and "Download" buttons in the UI to call these generators.

## Tech Choice

Use **jsPDF** with **jspdf-autotable** for table rendering. Do NOT use react-pdf or puppeteer — we want client-side generation with no server dependency.

```bash
npm install jspdf jspdf-autotable
```

## Shared Business Details

These come from Settings in production. For now, hardcode as defaults in a config object at the top of `src/lib/pdf.js`:

```js
const BUSINESS = {
  name: "SHMAKE",
  legalName: "Sam — Sole Trader",
  address: "Greymouth, West Coast, New Zealand",
  phone: "027 555 0000",
  email: "sam@shmake.nz",
  web: "shmake.nz",
  gstNumber: "123-456-789",
  irdNumber: "12-345-678",
  bankAccount: "03-1234-0567890-00",
  bankName: "ASB Bank",
};
```

Export a `setBusiness(config)` function so the app can override these from Settings/Supabase later.

## Design System

Match the existing UI aesthetic. The PDFs should feel like they belong to the same app.

- **Fonts:** Use Helvetica (built into jsPDF). Bold for headings, regular for body.
- **Colours:** 
  - Primary text: `#1c1917` (stone-900)
  - Secondary text: `#78716c` (stone-500)
  - Accent/brand: `#f59e0b` (amber-500) — use sparingly, e.g. a thin header bar or the "S" logo mark
  - Table header bg: `#f5f5f4` (stone-100)
  - Table border: `#e7e5e4` (stone-200)
  - Paid stamp: `#059669` (emerald-600)
  - Overdue stamp: `#dc2626` (red-600)
- **Logo:** Draw a simple amber square with "S" in dark text (matching the sidebar logo) as a placeholder. Accept an optional logo image (base64) for when the real logo is uploaded.
- **Page size:** A4 (210 x 297mm)
- **Margins:** 20mm all sides
- **Footer:** Page number centred, "Generated by SHMAKE" right-aligned, small grey text

## Currency Formatting

All monetary values formatted as NZD:

```js
const fmt = (n) => new Intl.NumberFormat("en-NZ", { 
  style: "currency", currency: "NZD" 
}).format(n);
```

---

## 1. Invoice PDF (`generateInvoicePdf`)

### Function Signature

```js
generateInvoicePdf(invoice, client, settings) → triggers download
```

### Input Data Shape (from Supabase, mapped from current mock fields)

```js
invoice = {
  id: "SHMAKE-0013",           // Invoice number
  status: "Sent",              // Draft | Sent | Paid | Overdue
  date: "2026-02-01",          // Invoice date
  dueDate: "2026-02-20",      // Payment due date
  client: {                    // Resolved client object
    name: "BuildRight Construction",
    email: "orders@buildright.co.nz",
    phone: "027 555 4567",
    address: "22 Industrial Pl, Greymouth",
  },
  lineItems: [                 // Line items array
    {
      description: "Steel bracket fabrication",
      type: "Labour",          // Labour | Materials | Flat Fee
      quantity: 24,
      unitPrice: 75.00,
      total: 1800.00,
    },
  ],
  subtotal: 1800.00,
  gst: 270.00,                 // 15% GST
  total: 2070.00,              // Subtotal + GST
  externalNote: "Per Quote Q-0009.",  // Shows on PDF
  // internalNote is NEVER included in PDF
  recurring: false,
  linkedQuote: "Q-0009",       // Optional reference
  paymentDate: null,           // Set when status is Paid
}
```

### Layout Spec

```
┌─────────────────────────────────────────────────┐
│ [Logo/S mark]              TAX INVOICE          │
│  SHMAKE                                         │
│  Sam — Sole Trader                              │
│  Greymouth, West Coast, NZ                      │
│  sam@shmake.nz | 027 555 0000                   │
│  GST: 123-456-789                               │
│                                                 │
│  ┌─────────────────┐  ┌──────────────────────┐  │
│  │ BILL TO         │  │ Invoice: SHMAKE-0013 │  │
│  │ BuildRight...   │  │ Date: 1 Feb 2026     │  │
│  │ 22 Industrial Pl│  │ Due: 20 Feb 2026     │  │
│  │ orders@build... │  │ Ref: Q-0009          │  │
│  │ 027 555 4567    │  │ Status: SENT         │  │
│  └─────────────────┘  └──────────────────────┘  │
│                                                 │
│  ┌───────────────────────────────────────────┐  │
│  │ Description    │ Type  │ Qty │ Rate │Total│  │
│  ├───────────────────────────────────────────┤  │
│  │ Steel bracket  │Labour │  24 │ $75  │$1800│  │
│  │ fabrication    │       │     │      │     │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│                          Subtotal:   $1,800.00  │
│                          GST (15%):    $270.00  │
│                         ─────────────────────── │
│                          TOTAL:      $2,070.00  │
│                                                 │
│  ┌───────────────────────────────────────────┐  │
│  │ PAYMENT DETAILS                           │  │
│  │ Bank: ASB Bank                            │  │
│  │ Account: 03-1234-0567890-00               │  │
│  │ Reference: SHMAKE-0013                    │  │
│  │ Due: 20 February 2026                     │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│  Note: Per Quote Q-0009.                        │
│                                                 │
│  Terms: Thank you for your business. Payment    │
│  by bank transfer to the account shown above.   │
│                                                 │
│  ──────────────────────────────────────────────  │
│  Page 1                    Generated by SHMAKE  │
└─────────────────────────────────────────────────┘
```

### Rules

- If `status === "Paid"`, render a diagonal "PAID" watermark stamp (green, 40pt, rotated -30deg, ~30% opacity) across the middle of the page. Also show payment date below the total.
- If `status === "Overdue"`, render "OVERDUE" watermark stamp in red same style.
- If `status === "Draft"`, render "DRAFT" watermark in grey.
- `externalNote` renders below the totals section as "Note:" if present. 
- **NEVER include `internalNote` in any PDF.** This is critical.
- The payment details box with bank account and reference MUST always be present on non-draft invoices.
- Format all dates as "1 February 2026" (day month year, no leading zero, full month name).
- Line items table: if description is long, it should wrap. Use autoTable's `columnStyles` to give description column flex width.
- GST number must be visible in the header. This is a legal requirement for NZ tax invoices.
- The words "TAX INVOICE" must appear prominently. This is required by NZ IRD for GST-registered businesses.
- Filename: `{invoice.id}.pdf` (e.g. `SHMAKE-0013.pdf`)

---

## 2. Quote PDF (`generateQuotePdf`)

### Function Signature

```js
generateQuotePdf(quote, client, settings) → triggers download
```

### Input Data Shape

```js
quote = {
  id: "Q-0006",
  version: 2,
  status: "Accepted",
  date: "2026-01-12",
  expiryDate: "2026-02-11",
  client: {
    name: "Sarah & Mark Thompson",
    email: "sarah.mark@gmail.com",
    phone: "027 555 1234",
    address: "14 Tainui St, Greymouth",
  },
  jobTitle: "Custom Timber Shelving Unit",
  lineItems: [
    {
      description: "Design and fabrication — recycled rimu shelving unit",
      type: "Labour",
      quantity: 1,
      unitPrice: 1600.00,
      total: 1600.00,
    },
    {
      description: "Materials — recycled rimu timber, brackets, fixings",
      type: "Materials",
      quantity: 1,
      unitPrice: 800.00,
      total: 800.00,
    },
  ],
  subtotal: 2400.00,
  gst: 360.00,
  total: 2760.00,
  externalNote: "Incl. material & install. Recycled rimu.",
  // internalNote NEVER on PDF
}
```

### Layout Spec

Similar to invoice but with these differences:

- Header says **"QUOTATION"** instead of "TAX INVOICE"
- No payment details box
- Show **"Quote: Q-0006 (v2)"** with version number
- Show **"Valid until: 11 February 2026"** (from expiryDate). If no expiry, show "Valid for 30 days from issue."
- Show **"Job: Custom Timber Shelving Unit"** linking it to the work
- If `status === "Accepted"`, show a subtle green "ACCEPTED" stamp
- If `status === "Expired"`, show a grey "EXPIRED" stamp
- If `status === "Declined"`, show a red "DECLINED" stamp
- Draft quotes get grey "DRAFT" stamp
- **Acceptance section** at the bottom before the footer:

```
┌───────────────────────────────────────────────┐
│ ACCEPTANCE                                    │
│                                               │
│ I accept this quotation and authorise the     │
│ work described above to proceed.              │
│                                               │
│ Signed: ____________________  Date: ______    │
│                                               │
│ Name:   ____________________                  │
└───────────────────────────────────────────────┘
```

- Only show acceptance section if status is "Sent" or "Draft" (not needed on accepted/declined)
- Filename: `{quote.id}_v{version}.pdf` (e.g. `Q-0006_v2.pdf`)

---

## 3. Expense Report PDF (`generateExpenseReportPdf`)

### Function Signature

```js
generateExpenseReportPdf(expenses, dateRange, summary) → triggers download
```

### Input Data Shape

```js
expenses = [
  {
    date: "2026-02-08",
    description: "Steel flat bar x4",
    category: "Materials",
    job: "Steel Bracket Fab",  // or null
    amount: 186.30,            // Business-use amount (after apportionment)
    gst: 24.30,
    hasReceipt: true,
    apportioned: false,
  },
  {
    date: "2026-01-28",
    description: "Z Energy — fuel",
    category: "Vehicle",
    job: null,
    amount: 22.50,
    gst: 2.93,
    hasReceipt: true,
    apportioned: true,
    fullAmount: 90.00,
    businessPercent: 25,
  },
  // ...
];

dateRange = {
  from: "2026-01-01",
  to: "2026-01-31",
  label: "January 2026",       // Human-readable period
};

summary = {
  totalAmount: 354.77,
  totalGst: 37.50,
  byCategory: [
    { category: "Materials", amount: 186.30 },
    { category: "Tools", amount: 67.80 },
    { category: "Vehicle", amount: 22.50 },
    // ...
  ],
};
```

### Layout Spec

```
┌─────────────────────────────────────────────────┐
│ [Logo]                 EXPENSE REPORT           │
│  SHMAKE — Sam, Sole Trader                      │
│  Period: January 2026                            │
│  GST: 123-456-789                               │
│                                                 │
│  Summary                                        │
│  ┌───────────────────────────────────────────┐  │
│  │ Total Expenses (business use):  $354.77   │  │
│  │ Total GST claimable:            $37.50    │  │
│  │                                           │  │
│  │ By Category:                              │  │
│  │   Materials ................ $186.30       │  │
│  │   Tools ................... $67.80        │  │
│  │   Vehicle ................. $22.50        │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│  Detail                                         │
│  ┌───────────────────────────────────────────┐  │
│  │Date │Description     │Cat  │Job │Amt │GST │  │
│  ├───────────────────────────────────────────┤  │
│  │08/02│Steel flat bar   │Mat  │Brk │186 │24  │  │
│  │...  │                │     │    │    │    │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│  * = Apportioned expense (business % applied)   │
│                                                 │
│  Totals:               $354.77    $37.50        │
│                                                 │
│  ──────────────────────────────────────────────  │
│  Page 1                    Generated by SHMAKE  │
└─────────────────────────────────────────────────┘
```

### Rules

- This is an internal document, NOT customer-facing. Use "EXPENSE REPORT" header.
- Mark apportioned expenses with an asterisk (*) and show a footnote.
- Expenses should be sorted by date descending (newest first).
- Category summary at the top for quick reference.
- Show "Receipt: ✓" or "Receipt: ✗" column — important for IRD compliance.
- If an expense is linked to a job, show the job name (truncated if long).
- This report is for Sam's records and for his accountant Rachel. Make it clean and scannable.
- Filename: `Expenses_{dateRange.label}.pdf` (e.g. `Expenses_January_2026.pdf`)

---

## Wiring Into the UI

### File: `src/lib/pdf.js`

Export three functions:
- `generateInvoicePdf(invoice, client, settings)`
- `generateQuotePdf(quote, client, settings)`
- `generateExpenseReportPdf(expenses, dateRange, summary)`

Each should create the PDF and trigger a browser download via:

```js
doc.save(filename);
```

### File: `src/App.jsx`

Import the generators at the top:

```js
import { generateInvoicePdf, generateQuotePdf, generateExpenseReportPdf } from './lib/pdf';
```

Wire to existing buttons. Currently the PDF/Download buttons call `toast("PDF downloaded", "success")`. Replace those calls with the actual generator functions. The data is in mock constants (INV, QT, EXP, CL) — resolve the client object by matching the `cl` field to `CL` entries.

For the expense report, add an "Export PDF" button to the Expenses page header (next to the existing Vehicle Log and Home Office buttons). When clicked, generate a report for all current expenses.

### Example wiring for invoice PDF button:

```js
// In the invoice detail panel, replace:
onClick={() => toast("PDF downloaded", "success")}
// With:
onClick={() => {
  const inv = INV.find(i => i.id === "SHMAKE-0013");
  const client = CL.find(c => c.n === inv.cl);
  generateInvoicePdf(
    {
      id: inv.id,
      status: inv.st,
      date: inv.dt,
      dueDate: inv.due,
      client: { name: client.n, email: client.e, phone: client.p, address: client.a },
      lineItems: [{ description: "Steel bracket fabrication", type: "Labour", quantity: 24, unitPrice: 75, total: 1800 }],
      subtotal: inv.am - inv.gst,
      gst: inv.gst,
      total: inv.am,
      externalNote: inv.en,
      linkedQuote: "Q-0009",
    },
    { name: client.n, email: client.e, phone: client.p, address: client.a },
    BUSINESS
  );
  toast("PDF downloaded", "success");
}}
```

NOTE: In production with Supabase, the line items will come from a `line_items` table joined to the invoice. For the mock UI, hardcode representative line items per invoice. This is temporary scaffolding.

---

## Testing Checklist

After building, verify these manually:

- [ ] Invoice PDF: correct invoice number, dates formatted as "1 February 2026", GST calculated right
- [ ] Invoice PDF: "TAX INVOICE" header text present
- [ ] Invoice PDF: GST number visible in header
- [ ] Invoice PDF: bank account and payment reference in payment box
- [ ] Invoice PDF: external note appears, internal note does NOT appear
- [ ] Invoice PDF: PAID watermark appears on paid invoices (green, transparent)
- [ ] Invoice PDF: OVERDUE watermark appears on overdue invoices (red)
- [ ] Invoice PDF: DRAFT watermark on draft invoices (grey)
- [ ] Quote PDF: "QUOTATION" header, version number shown
- [ ] Quote PDF: expiry date or "valid for 30 days" text
- [ ] Quote PDF: acceptance signature block on Sent/Draft quotes only
- [ ] Quote PDF: ACCEPTED/DECLINED/EXPIRED stamps when applicable
- [ ] Expense report: category summary at top matches detail total
- [ ] Expense report: apportioned items marked with asterisk and footnote
- [ ] Expense report: receipt column shows ✓ or ✗
- [ ] All PDFs: footer with page number and "Generated by SHMAKE"
- [ ] All PDFs: A4 size, 20mm margins, text doesn't overflow
- [ ] All PDFs: download triggers with correct filename
- [ ] All PDFs: NZD currency formatting throughout ($1,800.00 not $1800)

---

## File Structure After Build

```
src/
  lib/
    pdf.js          ← PDF generators (new)
  App.jsx           ← Wire PDF buttons to generators
```

Don't create any other files. Keep it simple — one utility module, three exported functions.
